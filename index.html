<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>科学闪卡背诵系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body { height: 100%; margin: 0; padding: 0; background: #f5f7fa; color: #222;}
    body { font-family: 'Roboto Slab', 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; }
    .container {
      display: grid;
      grid-template-columns: 300px 1fr 320px;
      gap: 28px;
      max-width: 1480px;
      margin: 0 auto;
      padding: 24px 14px 38px 14px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .sidebar, .tools-section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 20px #24335608,0 1px 2px #24335611;
      padding: 28px 20px 22px 20px;
      min-width: 0;
      min-height: 650px;
      max-height: 92vh;
      position: sticky;
      top: 22px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow-y: auto;
    }
    .sidebar { align-self: start; }
    .tools-section { align-self: start; }
    .flashcard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      grid-auto-rows: max-content;
      gap: 28px;
      align-items: stretch;
      justify-items: stretch;
      padding: 20px;
      padding-bottom: 40px;
      max-height: 92vh;
      overflow-y: auto;
    }
    /* ---- 3D闪卡动画样式 ---- */
    .flashcard {
      width: 100%;
      max-width: 26rem;
      min-height: 260px;
      max-height: 60vh;
      perspective: 1200px;
      background: transparent;
      margin: 0 auto;
      position: relative;
      cursor: pointer;
      user-select: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: box-shadow .24s, transform .24s;
    }
    .flashcard-inner {
      width: 100%;
      height: 100%;
      transition: transform 0.68s cubic-bezier(.41,1.58,.6,1);
      transform-style: preserve-3d;
      position: relative;
    }
    .flashcard.flipped .flashcard-inner {
      transform: rotateY(180deg);
    }
    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      left: 0; top: 0;
      backface-visibility: hidden;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 1px 6px rgba(36,51,86,0.08);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      cursor: pointer;
      padding: 28px;
      transition: box-shadow .2s;
      z-index: 2;
      overflow-y: auto;
      max-height: 60vh;
    }
    .flashcard-front { z-index: 3; }
    .flashcard-back {
      background: linear-gradient(140deg, #f1fdf4 70%, #e7f9ed 100%);
      transform: rotateY(180deg);
      z-index: 1;
      border: 1.5px solid #bbf7d0;
    }
    .flashcard:hover {
      box-shadow: 0 8px 26px rgba(0,0,0,0.15);
      transform: translateY(-6px);
    }
    /* 缩略图卡片 */
    .flashcard-thumb {
      background:#fff;
      border-radius:12px;
      padding:18px;
      min-height:120px;
      box-shadow:0 2px 12px rgba(0,0,0,0.05);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:center;
      text-align:left;
      cursor:pointer;
      overflow:hidden;
      transition:transform .2s;
    }
    .flashcard-thumb:hover {transform:scale(1.05);}
    .flashcard-thumb .thumb-title {font-weight:600;color:#334155;font-size:1.05em;margin-bottom:4px;}
    .flashcard-thumb .thumb-clue {color:#64748b;font-size:0.9em;line-height:1.4;}

    /* 大卡片模态 */
      #card-modal {
        position: fixed;
        left: 0; top: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.55);
        backdrop-filter: blur(3px);
        display: none;
        align-items: center;
        justify-content: center;
        padding:40px;
        overflow-y:auto;
        z-index: 1500;
      }
      #card-modal.active {display:flex; animation: fadeIn 0.25s;}
      #card-modal .card-popup {
        background:#fff;
        max-width:720px;
        width:100%;
        max-height:80vh;
        padding:32px;
        border-radius:20px;
        position:relative;
        box-shadow:0 8px 32px rgba(0,0,0,0.25);
        animation:scaleIn 0.3s ease;
        display:flex;
        flex-direction:column;
      }
      #card-modal .close-btn {position:absolute;right:16px;top:16px;background:#f8fafc;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;}
      #card-modal .popup-title {font-size:1.3em;font-weight:700;margin-bottom:12px;}
      #card-modal .popup-content {flex:1;overflow-y:auto;line-height:1.6;margin-bottom:18px;color:#374151;}
      #card-modal .popup-clue {color:#64748b;margin-bottom:12px;}
      #card-modal .mastery-buttons {justify-content:center;}

      @keyframes scaleIn {from{transform:scale(0.9);opacity:0;}to{transform:scale(1);opacity:1;}}
    .card-title {font-size:1.23em;font-weight:700;margin-bottom:9px;}
    .flashcard-tags {margin-bottom: 10px;}
    .tag {display:inline-block;font-size:12px;border-radius:10px;padding:2px 9px 2px 7px;margin-right:6px;}
    .tag-icon {margin-right:3px;}
    .tag.high {background: #22c55e;color:#fff;}
    .tag.medium {background: #4ade80;color:#065f46;}
    .tag.low {background: #bbf7d0;color:#065f46;}
    .card-clue {font-size:.98em;color:#385380;margin:3px 0 13px 0;}
    .card-category {font-size:14px;color:#4b5563;margin-bottom:7px;}
    .difficulty-dot {display:inline-block;width:9px;height:9px;margin-right:2.5px;border-radius:50%;background:#e0e0e0;}
    .difficulty-dot.active {background: #6366f1;}
    .card-footer {margin-top:auto;}
    .numbered-list .number {color:#1976d2;font-weight:bold;}
    .numbered-list .list-item {margin-bottom:3px;}
    .note {margin-top:10px;padding:7px 13px 7px 13px;background:#f1f3fa;border-left:4px solid #6366f1;font-size:13px;border-radius:0 7px 7px 0;}
    /* 3D动画按钮 */
    .mastery-buttons { display: flex; gap: 10px; margin-top: 16px; justify-content: center;}
    .mastery-btn { border:none;border-radius:13px;padding:8px 21px;font-size:15px;font-weight:500;cursor:pointer;transition:.14s;}
    .mastery-btn.hard {background:#fde68a;color:#b45309;}
    .mastery-btn.medium {background:#bae6fd;color:#0369a1;}
    .mastery-btn.easy {background:#bbf7d0;color:#166534;}
    .mastery-btn:hover {transform: scale(1.09);}
    /* 进度环与统计区 */
    .progress-ring { position: relative; width: 60px; height: 60px;}
    .progress-ring-circle-bg {
      fill: none;
      stroke: #e2e8f0;
      stroke-width: 4;
    }
    .progress-ring-circle {
      fill: none;
      stroke: #6366f1;
      stroke-width: 4;
      transform: rotate(-90deg);
      transform-origin: center;
      transition: stroke-dashoffset 0.3s ease;
    }
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 15px;
      font-weight: 600;
      color: #6366f1;
      pointer-events:none;
    }
    .stats-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;}
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-item {
      background: #f8fafc;
      padding: 10px 0 6px 0;
      border-radius: 13px;
      display: flex; flex-direction: column; align-items: center;
      transition: transform 0.17s;
      font-size: 15px;
    }
    .stat-item.highlight {
      background: linear-gradient(135deg,#6366f1,#3b82f6);
      color: #fff;
    }
    .stat-label {font-size: 13px; color: #64748b;}
    .stat-item.highlight .stat-label,
    .stat-item.highlight .stat-value {color:#fff;}
    .stat-value {font-size: 20px; font-weight: 600; color: #1a202c;}
    .study-streak {display:flex;justify-content:space-between;background:#f8fafc;padding:13px 16px;border-radius:12px;}
    .streak-info, .today-count {display:flex;flex-direction:column;align-items:center;}
    .streak-label, .today-label {font-size:13px;color:#64748b;}
    .streak-value, .today-value {font-size:16px;font-weight:600;color:#6366f1;}
    /* 搜索输入与侧边栏分类 */
    .search-input {width:100%;padding:11px 14px;border:1px solid #e2e8f0;border-radius:12px;font-size:15px;background:#f8fafc;margin-bottom:8px;}
    .search-input:focus {border-color:#6366f1;box-shadow:0 0 0 2px #c7d2fe;}
    .search-box {position: relative;}
    .search-icon {position: absolute;right: 17px;top: 50%;transform: translateY(-50%);color: #94a3b8;pointer-events: none;}
    .card-list {list-style: none; padding: 0; margin: 0;}
    .category-item {margin-bottom: 14px;}
    .category-header {display: flex;align-items: center;padding: 7px 12px;background: #f8fafc;border-radius: 8px;cursor: pointer;transition: all 0.18s;}
    .category-header:hover {background: #f1f5f9;}
    .category-header i {margin-right: 8px;transition: transform 0.2s;}
    .category-header.expanded i {transform: rotate(90deg);}
    .category-content {margin-left: 20px;padding: 8px 0;display: none;}
    .category-content.expanded {display: block;}
    .chapter-item {margin: 4px 0;padding: 4px 12px;border-radius: 7px;cursor: pointer;transition: all 0.18s;}
    .chapter-item:hover {background: #e0e7ff;color: #6366f1;}
    /* 按钮样式 */
    .btn-primary, .btn-secondary, .btn-save {
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.18s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      outline: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #3b82f6);
      color: #fff;
    }
    .btn-secondary {
      background: #f1f5f9;
      color: #1e293b;
    }
    .btn-save {
      background: #dcfce7;
      color: #15803d;
      margin-top: 12px;
    }
    .btn-primary:hover, .btn-secondary:hover, .btn-save:hover {
      filter: brightness(1.1);
    }
    .action-buttons {display: flex;flex-direction: column;gap: 10px;margin-top: 18px;}
    /* 笔记系统UI */
    .note-section {background:#fff;border-radius:16px;padding:18px 14px 12px 14px;}
    .note-tabs {display: flex;gap: 10px;margin-bottom: 15px;border-bottom: 2px solid #e2e8f0;padding-bottom: 9px;}
    .tab-btn {padding:8px 18px;border:none;border-radius:8px;background:#f1f5f9;color:#64748b;cursor:pointer;}
    .tab-btn.active {background:#6366f1;color:#fff;}
    .tab-content {display: none;}
    .tab-content.active {display: block;}
    .note-controls {display: flex;gap: 10px;margin-bottom: 13px;}
    .note-select {flex: 1;padding: 8px;border: 1px solid #e2e8f0;border-radius: 8px;background: #f8fafc;}
    .btn-new-category {padding:8px 16px;background:#4ade80;color:white;border:none;border-radius:8px;cursor:pointer;}
    .note-editor {display: flex;flex-direction: column;gap: 10px;}
    .note-title {padding: 8px;border: 1px solid #e2e8f0;border-radius: 8px;font-size: 16px;}
    .note-editor textarea {height: 100px;padding: 10px;border: 1px solid #e2e8f0;border-radius: 8px;resize: vertical;font-size: 14px;line-height: 1.6;}
    .note-actions {display: flex;justify-content: space-between;margin-top: 10px;padding-top: 12px;border-top: 1px solid #e2e8f0;}
    /* 响应式适配 */
  @media (max-width:1200px) {
        .container {grid-template-columns: 1fr 1fr;gap: 16px;}
        .sidebar, .tools-section {min-height: 410px;}
        .flashcard-grid {grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; padding: 20px;}
      }
      @media (max-width:900px) {
        .container {grid-template-columns: 1fr;gap:10px;padding:8px;}
        .sidebar, .tools-section {position: static;min-height: auto;margin-bottom:12px;}
        .flashcard-grid {grid-template-columns: 1fr; gap: 20px; padding: 15px;}
      }
    /* 导入弹窗样式 */
    #import-modal-root>div {
      position:fixed;z-index:1200;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.19);display:flex;align-items:center;justify-content:center;
    }
    #import-modal-root .modal-content {
      background:#fff;border-radius:12px;max-width:440px;padding:32px 28px;box-shadow:0 8px 32px #3332;position:relative;
    }
    #import-json {width:98%;min-height:96px;border-radius:8px;border:1px solid #e0e0e0;padding:7px 10px;font-size:15px;}
    #import-file {margin:10px 0;}
    .import-hint {background:#f8fafc;border:1px dashed #d1d5db;padding:8px;font-size:13px;margin:8px 0;white-space:pre-wrap;}
    /* 提示动画 */
    @keyframes fadeIn {from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);}}
    .flashcard,.sidebar,.tools-section,.modal-content {animation:fadeIn 0.4s;}
  </style>
</head>
<body>
  <div class="container">
    <!-- 侧边栏 -->
    <div class="sidebar">
      <h3 style="margin-bottom:14px;">知识导航</h3>
      <div class="search-box">
        <input type="text" class="search-input" placeholder="搜索卡片..." oninput="filterCards(this.value)">
        <i class="search-icon">🔍</i>
      </div>
      <div class="card-list" id="card-list"></div>
      <div class="action-buttons">
        <button class="btn-primary" onclick="showImportModal()"><i>📥</i>导入题库</button>
        <button class="btn-secondary" onclick="addNewCard()"><i>✨</i>新建卡片</button>
      </div>
    </div>
    <!-- 主卡片区 -->
    <div class="flashcard-grid" id="flashcard-grid"></div>
    <div id="card-modal" onclick="closeCardModal(event)"></div>
    <!-- 工具栏 -->
    <div class="tools-section">
      <div class="tool-card countdown">
        <span class="countdown-label">距离考研还有</span>
        <span class="countdown-value" id="countdown">计算中...</span>
      </div>
      <div class="study-stats">
        <div class="stats-header">
          <h4>学习进度</h4>
          <div class="progress-ring">
            <svg width="60" height="60" viewBox="0 0 60 60">
              <circle class="progress-ring-circle-bg" cx="30" cy="30" r="24"/>
              <circle class="progress-ring-circle" cx="30" cy="30" r="24"/>
            </svg>
            <span class="progress-text">0%</span>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-item"><span class="stat-label">已掌握</span><span class="stat-value" id="stat-mastered">0</span></div>
          <div class="stat-item"><span class="stat-label">复习中</span><span class="stat-value" id="stat-reviewing">0</span></div>
          <div class="stat-item"><span class="stat-label">未学习</span><span class="stat-value" id="stat-new">0</span></div>
          <div class="stat-item highlight"><span class="stat-label">高频考点</span><span class="stat-value" id="stat-high">0</span></div>
        </div>
        <div class="study-streak">
          <div class="streak-info">
            <span class="streak-label">连续学习</span>
            <span class="streak-value" id="stat-streak">0天</span>
          </div>
          <div class="today-count">
            <span class="today-label">今日已学</span>
            <span class="today-value" id="stat-today">0张</span>
          </div>
        </div>
      </div>
      <div class="tool-card note-section">
        <h4>学习笔记</h4>
        <div class="note-tabs">
          <button class="tab-btn active" data-tab="quick" onclick="switchNoteTab('quick')">快速笔记</button>
          <button class="tab-btn" data-tab="organized" onclick="switchNoteTab('organized')">系统笔记</button>
        </div>
        <div class="tab-content active" id="quick-note">
          <textarea placeholder="记录临时想法和笔记..." id="quick-textarea"></textarea>
        </div>
        <div class="tab-content" id="organized-note">
          <div class="note-controls">
            <select id="note-category" class="note-select"></select>
            <button class="btn-new-category" onclick="addNoteCategory()">新建分类</button>
          </div>
          <div class="note-editor">
            <input type="text" class="note-title" placeholder="笔记标题...">
            <textarea id="organized-textarea" placeholder="系统化的学习笔记..."></textarea>
          </div>
        </div>
        <div class="note-actions">
          <button class="btn-save" onclick="saveNote()">保存笔记</button>
          <button class="btn-view-history" onclick="viewNoteHistory()">查看历史</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 导入弹窗容器 -->
  <div id="import-modal-root"></div>

  <!-- DeepSeek Chat Widget -->
  <script>
    window.deepseekChatConfig = {
      apiKey: 'sk-10b52ce013e5416bbf98db54354a1bb8',
      language: 'zh'
    };
  </script>
  <script src="https://chat.deepseek.com/widget.js" defer></script>

  <!-- 下面js部分下一轮发送！ -->
</body>
</html>
<script>
// ============ 数据初始化与本地存储 ==============
let cards = JSON.parse(localStorage.getItem('flashcards') || '[]');
if (!cards.length) {
  // 默认初始卡片
  cards = [{
    front: "公共管理的基本特征",
    back: "1、公共性：服务对象和目标的公共性\n2、权力性：行政权力和法律保障\n3、服务性：以服务公众为根本宗旨\n4、专业性：需要专业知识和技能",
    category: "公共管理",
    chapter: "第一章 公共管理概论",
    section: "公共管理特征",
    level: "重点",
    examFrequency: "高频",
    cardType: "特征分析",
    clue: "思考：什么使公共管理区别于一般管理？",
    context: "公共管理是一门专门研究政府管理活动的学科，其特征反映了其本质属性",
    lastReview: null,
    nextReview: null,
    reviewCount: 0,
    difficulty: 0,
    mastery: 0,
    wrongCount: 0
  }];
}

// ============ 学习进度/统计 ==============
function statSummary() {
  const total = cards.length;
  let mastered = 0, reviewing = 0, unlearned = 0, high = 0;
  cards.forEach(card => {
    if (card.mastery >= 4) mastered++;
    else if (card.mastery >= 1) reviewing++;
    else unlearned++;
    if (card.examFrequency === '高频') high++;
  });
  return { total, mastered, reviewing, unlearned, high };
}
function updateStats() {
  const s = statSummary();
  document.getElementById('stat-mastered').textContent = s.mastered;
  document.getElementById('stat-reviewing').textContent = s.reviewing;
  document.getElementById('stat-new').textContent = s.unlearned;
  document.getElementById('stat-high').textContent = s.high;
  // 进度环
  const percent = s.total ? Math.round((s.mastered + s.reviewing) / s.total * 100) : 0;
  const circle = document.querySelector('.progress-ring-circle');
  const radius = 24, circumference = 2 * Math.PI * radius;
  circle.setAttribute('stroke-dasharray', circumference);
  circle.setAttribute('stroke-dashoffset', circumference * (1 - percent / 100));
  document.querySelector('.progress-text').textContent = percent + '%';
  document.getElementById('stat-today').textContent = getTodayStudyCount() + '张';
  document.getElementById('stat-streak').textContent = getStudyStreak() + '天';
}

// ============ 侧边栏 分类-章节 二级展开 ==============
function updateCardList(listCards = cards.filter(activeReviewFilter)) {
  const grouped = listCards.reduce((acc, card) => {
    if (!acc[card.category]) acc[card.category] = {};
    if (!acc[card.category][card.chapter]) acc[card.category][card.chapter] = [];
    acc[card.category][card.chapter].push(card);
    return acc;
  }, {});
  const list = document.getElementById('card-list');
  list.innerHTML = '';
  const allItem = document.createElement('div');
  allItem.className = 'chapter-item';
  allItem.textContent = '全部卡片';
  allItem.onclick = () => { currentCardList = listCards; renderGrid(currentCardList); };
  list.appendChild(allItem);
  for (let cat in grouped) {
    const catDiv = document.createElement('div');
    catDiv.className = 'category-item';
    const catHeader = document.createElement('div');
    catHeader.className = 'category-header';
    catHeader.innerHTML = `<i>▶</i>${cat}`;
    catHeader.onclick = () => {
      catHeader.classList.toggle('expanded');
      catContent.classList.toggle('expanded');
      currentCardList = Object.values(grouped[cat]).flat();
      renderGrid(currentCardList);
    };
    const catContent = document.createElement('div');
    catContent.className = 'category-content';
    for (let chap in grouped[cat]) {
      const chapDiv = document.createElement('div');
      chapDiv.className = 'chapter-item';
      chapDiv.textContent = chap;
      chapDiv.onclick = () => {
        currentCardList = grouped[cat][chap];
        renderGrid(currentCardList);
      };
      catContent.appendChild(chapDiv);
    }
    catDiv.appendChild(catHeader);
    catDiv.appendChild(catContent);
    list.appendChild(catDiv);
  }
}

// ============ 主卡片渲染/3D动画/正反切换 ==============
let currentCardList = cards;
let activeReviewFilter = ()=>true;
function renderGrid(showCards = currentCardList) {
  const grid = document.getElementById('flashcard-grid');
  grid.innerHTML = '';
  showCards.forEach(card => {
    const div = document.createElement('div');
    div.className = 'flashcard';
    div.innerHTML = `
      <div class="flashcard-inner">
        <div class="flashcard-front">
          <div class="card-title">${card.front}</div>
          <div class="flashcard-tags">
            ${card.examFrequency === '高频' ? '<span class="tag high"><span class="tag-icon">⭐</span>高频</span>' : ''}
            ${card.level === '重点' ? '<span class="tag medium"><span class="tag-icon">📌</span>重点</span>' : ''}
          </div>
          <div class="card-clue">${card.clue || ''}</div>
          <div class="card-content"><span>${card.context || ''}</span></div>
        </div>
        <div class="flashcard-back">
          <div class="card-category">${card.category} > ${card.chapter}</div>
          <div class="card-content">${formatCardContent(card.back)}</div>
          <div class="card-footer">
            <div class="mastery-buttons">
              <button class="mastery-btn hard" onclick="updateMastery('${card.front}', 1, event)"><span>😅</span>困难</button>
              <button class="mastery-btn medium" onclick="updateMastery('${card.front}', 3, event)"><span>🤔</span>模糊</button>
              <button class="mastery-btn easy" onclick="updateMastery('${card.front}', 5, event)"><span>✨</span>清晰</button>
            </div>
          </div>
        </div>
      </div>
    `;
    div.onclick = function (e) {
      // 避免点击按钮也触发翻转
      if (e.target.tagName === 'BUTTON' || e.target.classList.contains('mastery-btn')) return;
      this.classList.toggle('flipped');
    };
    grid.appendChild(div);
  });
}

// ============ 卡片内容格式化（编号/注释/高亮） ============
function formatCardContent(content) {
  let mainContent = content, notes = '';
  const noteMatches = content.match(/（[^）]+）/g);
  if (noteMatches) {
    notes = noteMatches.join(' ');
    mainContent = content.replace(/（[^）]+）/g, '');
  }
  if (/1[\.、．]/.test(mainContent)) {
    const points = mainContent.split(/(?=\d+[\.、．])/)
      .map(point => point.trim()).filter(point => point.length > 0);
    let html = '<div class="numbered-list">';
    points.forEach(point => {
      const match = point.match(/^(\d+[\.、．])\s*(.+)$/);
      if (match) {
        html += `<div class="list-item"><span class="number">${match[1]}</span><span class="content">${match[2]}</span></div>`;
      } else {
        html += `<div class="list-item"><span class="content">${point}</span></div>`;
      }
    });
    html += '</div>';
    if (notes) html += `<div class="note">${notes}</div>`;
    return html;
  }
  return `<p>${mainContent.replace(/\n/g, '<br>')}</p>${notes ? `<div class="note">${notes}</div>` : ''}`;
}

function truncateText(t,len=15){
  return t.length>len? t.slice(0,len)+'…': t;
}

function openCard(front){
  const card = cards.find(c=>c.front===front);
  if(!card) return;
  const modal = document.getElementById('card-modal');
  modal.innerHTML = `
    <div class="card-popup" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeCardModal(event)">×</button>
      <div class="popup-title">${card.front}</div>
      <div class="popup-content">
        ${card.clue ? `<div class="popup-clue">${card.clue}</div>` : ''}
        <div>${formatCardContent(card.back)}</div>
      </div>
      <div class="mastery-buttons">
        <button class="mastery-btn hard" onclick="updateMastery('${card.front}', 1, event)"><span>😅</span>困难</button>
        <button class="mastery-btn medium" onclick="updateMastery('${card.front}', 3, event)"><span>🤔</span>模糊</button>
        <button class="mastery-btn easy" onclick="updateMastery('${card.front}', 5, event)"><span>✨</span>清晰</button>
      </div>
    </div>`;
  modal.onclick = closeCardModal;
  modal.classList.add('active');
}

function closeCardModal(e){
  if(e) e.stopPropagation();
  const modal = document.getElementById('card-modal');
  modal.classList.remove('active');
  modal.innerHTML = '';
}

// ============ 搜索过滤 ============
function filterCards(query) {
  const q = query.trim().toLowerCase();
  const base = cards.filter(activeReviewFilter);
  if (!q) {
    renderGrid(base);
    currentCardList = base;
    return;
  }
  const filtered = base.filter(card =>
    card.front.toLowerCase().includes(q) ||
    card.back.toLowerCase().includes(q) ||
    card.category.toLowerCase().includes(q) ||
    card.chapter.toLowerCase().includes(q) ||
    (card.level || '').toLowerCase().includes(q)
  );
  currentCardList = filtered;
  renderGrid(filtered);
}

// ============ 间隔重复算法 ============
function getDueCards() {
  const now = new Date();
  return cards.filter(card => {
    if (!card.nextReview) return true;
    return new Date(card.nextReview) <= now;
  });
}
function spacedRepetition(card, mastery) {
  const now = new Date();
  const interval = Math.pow(2, card.reviewCount || 0) * (mastery / 5);
  card.lastReview = now.toISOString();
  card.reviewCount = (card.reviewCount || 0) + 1;
  card.mastery = mastery;
  const next = new Date(now);
  next.setDate(now.getDate() + Math.max(1, Math.round(interval)));
  card.nextReview = next.toISOString();
  card.difficulty = Math.max(0, Math.min(5, (card.difficulty || 0) + (mastery <= 2 ? 1 : mastery >= 4 ? -1 : 0)));
  return card;
}

// ============ 学习反馈/掌握度按钮 ============
function updateMastery(front, mastery, event) {
  event.stopPropagation();
  const i = cards.findIndex(c => c.front === front);
  if (i === -1) return;
  cards[i] = spacedRepetition(cards[i], mastery);
  if (mastery <= 2) cards[i].wrongCount = (cards[i].wrongCount || 0) + 1;
  localStorage.setItem('flashcards', JSON.stringify(cards));
  incrementTodayStudyCount();
  updateStats();
  document.querySelectorAll('.flashcard').forEach(f => f.classList.remove('flipped'));
  setTimeout(() => {
    const base = cards.filter(activeReviewFilter);
    const due = base.filter(c=>!c.nextReview||new Date(c.nextReview)<=new Date());
    if (due.length) {
      currentCardList = due;
      renderGrid(due);
    } else {
      currentCardList = base;
      renderGrid(base);
    }
  }, 330);
}

// ============ 学习天数/打卡统计 ============
function getTodayStudyCount() {
  const today = new Date().toISOString().split('T')[0];
  return parseInt(localStorage.getItem(`study_count_${today}`) || '0');
}
function incrementTodayStudyCount() {
  const today = new Date().toISOString().split('T')[0];
  const count = getTodayStudyCount();
  localStorage.setItem(`study_count_${today}`, count + 1);
}
function getStudyStreak() {
  let streak = 0;
  const today = new Date(), curr = new Date(today);
  while (1) {
    const dateStr = curr.toISOString().split('T')[0];
    if (parseInt(localStorage.getItem(`study_count_${dateStr}`) || '0') === 0) break;
    streak++;
    curr.setDate(curr.getDate() - 1);
  }
  return streak;
}

// ============ 倒计时 ============
function updateCountdown() {
  // 默认考研12月23日
  const now = new Date(), year = now.getFullYear();
  const target = new Date(year, 11, 23);
  let days = Math.ceil((target - now) / 86400000);
  if (days < 0) days = Math.ceil((new Date(year + 1, 11, 23) - now) / 86400000);
  document.getElementById('countdown').textContent = days + '天';
}

// ============ 批量导入导出 =============
function showImportModal() {
  const modalRoot = document.getElementById('import-modal-root');
  modalRoot.innerHTML = `
  <div>
    <div class="modal-content">
      <h3>批量导入题库</h3>
      <p>粘贴符合格式的JSON数组，或上传.json文件：</p>
      <pre class="import-hint">[
  {"front":"题干","back":"答案","category":"科目","chapter":"章节"}
]</pre>
      <textarea id="import-json"></textarea>
      <input type="file" id="import-file" accept=".json">
      <div style="text-align:right;margin-top:10px;">
        <button class="btn-secondary" onclick="document.getElementById('import-modal-root').innerHTML=''">取消</button>
        <button class="btn-primary" onclick="processImport()">导入</button>
      </div>
    </div>
  </div>`;
  document.getElementById('import-file').onchange = function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (ev) {
      document.getElementById('import-json').value = ev.target.result;
    };
    reader.readAsText(file);
  };
}
function processImport() {
  let importData;
  try {
    importData = JSON.parse(document.getElementById('import-json').value);
    if (!Array.isArray(importData)) throw Error('请粘贴JSON数组格式');
    importData.forEach(card => {
      if (!card.front || !card.back || !card.category || !card.chapter) throw Error('每条需含front,back,category,chapter');
      card.lastReview = null; card.nextReview = null; card.reviewCount = 0; card.difficulty = 0; card.mastery = 0; card.wrongCount = 0;
    });
    // 去重
    const fronts = new Set(cards.map(c => c.front));
    const newCards = importData.filter(card => !fronts.has(card.front));
    cards = cards.concat(newCards);
    localStorage.setItem('flashcards', JSON.stringify(cards));
    document.getElementById('import-modal-root').innerHTML = '';
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats();
    alert('导入成功！新增' + newCards.length + '条');
  } catch (e) {
    alert('导入失败:' + e.message);
  }
}
function addNewCard() {
  const front = prompt('输入题干(正面)...');
  if (!front) return;
  const back = prompt('输入答案(背面)...');
  if (!back) return;
  const category = prompt('所属科目/分类?', '未分类');
  const chapter = prompt('所属章节?', '未分章');
  cards.push({
    front, back, category, chapter,
    level: '基础', examFrequency: '低频', lastReview: null, nextReview: null, reviewCount: 0, difficulty: 0, mastery: 0, wrongCount: 0
  });
  localStorage.setItem('flashcards', JSON.stringify(cards));
  const filtered = cards.filter(activeReviewFilter);
  updateCardList(filtered); renderGrid(filtered); updateStats();
}

// ============ 笔记系统 ============
let notes = JSON.parse(localStorage.getItem('flashcardNotes') || '{"quick":{},"organized":{}}');
function switchNoteTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('.tab-btn[data-tab="' + tab + '"]').classList.add('active');
  document.getElementById(tab + '-note').classList.add('active');
}
function saveNote() {
  const tab = document.querySelector('.tab-btn.active').dataset.tab;
  const today = new Date().toISOString().split('T')[0];
  if (tab === 'quick') {
    notes.quick[today] = document.getElementById('quick-textarea').value;
  } else {
    const cat = document.getElementById('note-category').value;
    const title = document.querySelector('.note-title').value;
    const content = document.getElementById('organized-textarea').value;
    if (!cat) return alert('请选择分类');
    if (!notes.organized[cat]) notes.organized[cat] = [];
    notes.organized[cat].push({ title, content, date: today });
  }
  localStorage.setItem('flashcardNotes', JSON.stringify(notes));
  alert('笔记已保存');
}
function addNoteCategory() {
  const cat = prompt('输入新分类名');
  if (!cat) return;
  if (!notes.organized[cat]) notes.organized[cat] = [];
  updateNoteCategories();
}
function updateNoteCategories() {
  const sel = document.getElementById('note-category');
  if (!sel) return;
  sel.innerHTML = '<option value="">选择分类...</option>' +
    Object.keys(notes.organized).map(c => `<option value="${c}">${c}</option>`).join('');
}
function viewNoteHistory() {
  alert('历史笔记请到控制台输入：notes 查看，也可后续自定义弹窗...');
}

// ============ 页面初始化 ============
function initializeApp() {
  const filtered = cards.filter(activeReviewFilter);
  updateCardList(filtered);
  renderGrid(filtered);
  updateStats();
  updateCountdown();
  updateNoteCategories();
  // 恢复笔记输入
  if (notes.quick) {
    const latest = Object.keys(notes.quick).sort().pop();
    if (latest) document.getElementById('quick-textarea').value = notes.quick[latest];
  }
}
window.onload = initializeApp;
</script>

<script>
// =========== 扩展1：复习模式切换 ===========
function showReviewMenu() {
  const opts = [
    {name:'应复习',    filter:card=>!card.nextReview||new Date(card.nextReview)<=new Date()},
    {name:'今日已学',  filter:card=>card.lastReview && new Date(card.lastReview).toDateString()===new Date().toDateString()},
    {name:'本周已学',  filter:card=>card.lastReview && (new Date()-new Date(card.lastReview))<=7*86400000},
    {name:'高频考点',  filter:card=>card.examFrequency==='高频'},
    {name:'错题本',    filter:card=>(card.wrongCount||0)>=2 || card.mastery<3},
    {name:'全部卡片',  filter:()=>true},
    {name:'乱序',       filter:()=>true, shuffle:true}
  ];
  let html = '<div class="modal-content"><h3>选择复习模式</h3>';
  opts.forEach((opt,i)=>{
    html += `<button class="btn-primary" style="margin:7px 0;width:100%;" onclick="applyReviewMode(${i})">${opt.name}</button>`;
  });
  html += `<div style="text-align:right"><button class="btn-secondary" onclick="closeModal()">取消</button></div></div>`;
  showModal(html);
}
function applyReviewMode(idx) {
  const opts = [
    {name:'应复习',    filter:card=>!card.nextReview||new Date(card.nextReview)<=new Date()},
    {name:'今日已学',  filter:card=>card.lastReview && new Date(card.lastReview).toDateString()===new Date().toDateString()},
    {name:'本周已学',  filter:card=>card.lastReview && (new Date()-new Date(card.lastReview))<=7*86400000},
    {name:'高频考点',  filter:card=>card.examFrequency==='高频'},
    {name:'错题本',    filter:card=>(card.wrongCount||0)>=2 || card.mastery<3},
    {name:'全部卡片',  filter:()=>true},
    {name:'乱序',       filter:()=>true, shuffle:true}
  ];
  const opt = opts[idx];
  activeReviewFilter = opt.filter;
  let base = cards.filter(opt.filter);
  if(opt.shuffle) base = base.sort(()=>Math.random()-.5);
  currentCardList = base;
  renderGrid(base);
  updateCardList(base);
  closeModal();
}
function showModal(html) {
  document.getElementById('import-modal-root').innerHTML = `<div><div class="modal-content">${html}</div></div>`;
}
function closeModal() {
  document.getElementById('import-modal-root').innerHTML = '';
}

// =========== 扩展2：卡片导出 ===========
function exportCards() {
  const data = JSON.stringify(cards,null,2);
  const blob = new Blob([data], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'flashcards_backup_'+Date.now()+'.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
document.addEventListener('keydown', e=>{
  // 快捷键 Ctrl+E 导出
  if(e.ctrlKey && e.key==='e') { e.preventDefault(); exportCards(); }
});

// =========== 扩展3：卡片编辑/删除 ===========
function showEditCard(front) {
  const i = cards.findIndex(c=>c.front===front);
  if(i===-1) return;
  const card = cards[i];
  let html = `
  <h3>编辑卡片</h3>
  <label>题干(正面):<input type="text" id="edit-front" value="${card.front}" style="width:95%;margin-bottom:7px;"></label><br>
  <label>答案(背面):<textarea id="edit-back" style="width:95%;height:70px;">${card.back}</textarea></label><br>
  <label>科目:<input type="text" id="edit-category" value="${card.category}" style="width:45%;"></label>
  <label>章节:<input type="text" id="edit-chapter" value="${card.chapter}" style="width:45%;"></label><br>
  <label>高频:<input type="checkbox" id="edit-high" ${card.examFrequency==='高频'?'checked':''}></label>
  <label>重点:<input type="checkbox" id="edit-key" ${card.level==='重点'?'checked':''}></label>
  <div style="text-align:right;margin-top:13px;">
    <button class="btn-secondary" onclick="closeModal()">取消</button>
    <button class="btn-save" onclick="doEditCard('${front}')">保存</button>
    <button class="btn-primary" style="background:#f44;color:#fff;margin-left:8px;" onclick="deleteCard('${front}')">删除</button>
  </div>`;
  showModal(html);
}
function doEditCard(oldFront) {
  const i = cards.findIndex(c=>c.front===oldFront);
  if(i===-1) return alert('未找到卡片');
  const newFront = document.getElementById('edit-front').value.trim();
  const newBack = document.getElementById('edit-back').value;
  const newCat = document.getElementById('edit-category').value;
  const newChap = document.getElementById('edit-chapter').value;
  cards[i].front = newFront; cards[i].back = newBack; cards[i].category = newCat; cards[i].chapter = newChap;
  cards[i].examFrequency = document.getElementById('edit-high').checked ? '高频' : '低频';
  cards[i].level = document.getElementById('edit-key').checked ? '重点' : '基础';
  localStorage.setItem('flashcards',JSON.stringify(cards));
  const filtered = cards.filter(activeReviewFilter);
  updateCardList(filtered); renderGrid(filtered);
  closeModal();
}
function deleteCard(front) {
  if(!confirm('确认删除？')) return;
  cards = cards.filter(c=>c.front!==front);
  localStorage.setItem('flashcards',JSON.stringify(cards));
  const filtered = cards.filter(activeReviewFilter);
  updateCardList(filtered); renderGrid(filtered);
  closeModal();
}

// 重绘卡片墙及编辑
renderGrid = function(showCards=currentCardList) {
  const grid = document.getElementById('flashcard-grid');
  grid.innerHTML = '';
  showCards.forEach(card => {
    const div = document.createElement('div');
    div.className = 'flashcard-thumb';
    div.innerHTML = `<div class="thumb-title">${truncateText(card.front)}</div>` +
                    `<div class="thumb-clue">${truncateText(card.clue || card.context || '', 24)}</div>`;
    div.onclick = () => openCard(card.front);
    grid.appendChild(div);
  });
};
// 侧边栏章节支持编辑（长按）
document.addEventListener('contextmenu',function(e){
  if(e.target.classList.contains('chapter-item')){
    e.preventDefault();
    const chap = e.target.textContent;
    const catDiv = e.target.closest('.category-item');
    const cat = catDiv.querySelector('.category-header').textContent.replace(/▶/,'').trim();
    const cardsIn = cards.filter(c=>c.category===cat&&c.chapter===chap);
    if(!confirm(`要删除“${cat} > ${chap}”下的${cardsIn.length}张卡片？`)) return;
    cards = cards.filter(c=>!(c.category===cat&&c.chapter===chap));
    localStorage.setItem('flashcards',JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered);
  }
},false);

// =========== 扩展4：历史学习记录简要查看 ===========
function viewNoteHistory() {
  let html = '<h3>历史笔记（最新10条）</h3><ul style="max-height:260px;overflow:auto;">';
  const recs = [];
  Object.values(notes.quick||{}).forEach((txt,date)=>{recs.push({txt,date});});
  Object.values(notes.organized||{}).forEach(arr=>{
    arr.forEach(note=>{recs.push({txt:note.title+' '+note.content,date:note.date});});
  });
  recs.sort((a,b)=>b.date.localeCompare(a.date));
  recs.slice(0,10).forEach(r=>{
    html += `<li style="margin-bottom:9px;font-size:14px;"><b>${r.date||''}</b>：${r.txt.substring(0,80)}...</li>`;
  });
  html += '</ul><div style="text-align:right"><button class="btn-secondary" onclick="closeModal()">关闭</button></div>';
  showModal(html);
}

// =========== 扩展5：自定义倒计时目标日期 ===========
function updateCountdown() {
  let dt = localStorage.getItem('examDate') || '';
  let date = dt ? new Date(dt) : new Date(new Date().getFullYear(), 11, 23);
  const now = new Date();
  let days = Math.ceil((date - now) / 86400000);
  if (days < 0) days = 0;
  document.getElementById('countdown').textContent = days + '天';
  document.querySelector('.countdown-label').onclick = function() {
    const input = prompt('自定义目标日期（格式: 2024-12-21）', dt || '');
    if(input){
      localStorage.setItem('examDate',input);
      updateCountdown();
    }
  }
}

// =========== 扩展6：主界面按钮添加 ===========
const btns = document.createElement('div');
btns.style.margin = "12px 0 0 0";
btns.innerHTML = `
  <button class="btn-primary" onclick="showReviewMenu()" style="width:98%;margin-bottom:8px;">复习模式</button>
  <button class="btn-primary" onclick="exportCards()" style="width:98%;margin-bottom:8px;">导出卡片</button>
`;
document.querySelector('.sidebar .action-buttons').prepend(btns);

// =========== 动画微交互/更多 ===========
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.btn-primary,.btn-secondary,.btn-save,.mastery-btn').forEach(btn=>{
    btn.onmousedown = ()=>{ btn.style.transform="scale(0.97)"; }
    btn.onmouseup = btn.onmouseleave = ()=>{ btn.style.transform=""; }
  });
});
</script>
