<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç§‘å­¦é—ªå¡èƒŒè¯µç³»ç»Ÿ Pro | å…¬å…±ç®¡ç†è€ƒç ”ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="ä¸“ä¸ºå…¬å…±ç®¡ç†è€ƒç ”è®¾è®¡çš„é—´éš”é‡å¤è®°å¿†ç³»ç»Ÿ">
  
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #e0e7ff;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      
      /* å¡ç‰‡èƒŒé¢ä¸“ç”¨é…è‰² */
      --card-paper: #ffffff;
      --card-ink: #334155;
      --highlight-bg: rgba(253, 224, 71, 0.3);
      --highlight-text: #b45309;

      /* å­—ä½“å¤§å°å˜é‡ */
      --fs-card-answer: 1rem; /* é»˜è®¤ç­”æ¡ˆå­—ä½“å¤§å° */
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden; 
      font-size: 16px; /* æ¢å¤å…¨å±€æ ‡å‡†å­—ä½“ */
    }

    /* å¸ƒå±€æ¡†æ¶ */
    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr 300px;
      height: 100vh;
      max-width: 1800px;
      margin: 0 auto;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
      z-index: 10;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ä¸­é—´å¡ç‰‡ç½‘æ ¼ */
    .main-content {
      padding: 24px;
      overflow-y: auto;
      background: var(--bg-body);
      position: relative;
    }
    
    .content-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--bg-body);
      padding-bottom: 10px;
    }

    .flashcard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      padding-bottom: 80px;
    }

    /* å³ä¾§å·¥å…·æ  */
    .tools-panel {
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* é€šç”¨ç»„ä»¶æ ·å¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      user-select: none;
    }
    .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-secondary { background: var(--primary-light); color: var(--primary-dark); }
    .btn-secondary:hover { background: #c7d2fe; }
    .btn-ghost { background: transparent; color: var(--text-sub); }
    .btn-ghost:hover { background: #f1f5f9; }
    .btn-danger { background: #fee2e2; color: var(--danger); }
    .btn-danger:hover { background: #fecaca; }
    .btn-block { width: 100%; }

    .input-group { position: relative; margin-bottom: 12px; }
    .input-field {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-body);
      transition: border-color 0.2s;
      font-size: 1rem;
    }
    .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
    select.input-field { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 30px; }

    /* ä¾§è¾¹æ åˆ†ç±»åˆ—è¡¨ */
    .nav-section { margin-bottom: 20px; }
    .nav-title { font-size: 0.85rem; color: var(--text-sub); font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-main);
      margin-bottom: 4px;
      transition: background 0.2s;
    }
    .nav-item:hover { background: var(--bg-body); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-item i { margin-right: 8px; font-style: normal; width: 20px; text-align: center; }
    .count-badge { margin-left: auto; background: #e2e8f0; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; }

    /* é—ªå¡æ ·å¼ - åˆ—è¡¨è§†å›¾ */
    .card-thumb {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 150px;
      cursor: pointer;
    }
    .card-thumb:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--primary-light); }
    .card-thumb .card-meta { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 8px; display: flex; justify-content: space-between; }
    
    .card-thumb .card-title { 
      font-weight: 600; 
      font-size: 1.1rem; 
      line-height: 1.5; 
      color: var(--text-main); 
      flex: 1; 
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; 
      margin-bottom: 12px;
    }
    
    .card-thumb .card-tags { margin-top: auto; display: flex; flex-wrap: wrap; gap: 4px; }
    .tag-pill { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--bg-body); color: var(--text-sub); margin-right: 4px; }
    
    .card-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      gap: 4px;
    }
    .card-thumb:hover .card-actions { opacity: 1; }
    .icon-btn {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: #f1f5f9;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid #e2e8f0;
    }
    .icon-btn:hover { background: white; color: var(--primary); border-color: var(--primary); }

    /* çŠ¶æ€æŒ‡ç¤ºç¯ */
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .status-new { background: #94a3b8; }
    .status-learning { background: var(--warning); }
    .status-mastered { background: var(--success); }

    /* æ²‰æµ¸å¼å¤ä¹ æ¨¡å¼ (Overlay) */
    #review-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(248, 250, 252, 0.95);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #review-overlay.active { display: flex; animation: fadeIn 0.3s; }

    .review-header { position: absolute; top: 0; left: 0; right: 0; padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 3000;}
    .progress-bar-container { flex: 1; max-width: 400px; height: 6px; background: #e2e8f0; border-radius: 3px; margin: 0 20px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

    /* 3D ç¿»è½¬å¡ç‰‡å®¹å™¨ - ä¿®å¤é•œåƒé—®é¢˜çš„æ ¸å¿ƒä»£ç  */
    .flip-container {
      perspective: 1000px;
      width: 90%;
      max-width: 720px; 
      height: 70vh; 
      min-height: 400px;
      margin: 20px;
      position: relative;
    }
    .flipper {
      transition: 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
      transform-style: preserve-3d;
      position: relative;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .flipper.flipped { transform: rotateY(180deg); }
    
    .front, .back {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden; /* Safari */
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border-radius: 24px;
      background: var(--card-paper);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      padding: 40px;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    /* æ­£é¢ */
    .front { 
      z-index: 2; 
      transform: rotateY(0deg); 
      align-items: center; 
      justify-content: center;
      text-align: center; 
      background: linear-gradient(145deg, #ffffff, #f8fafc);
    }
    
    /* èƒŒé¢ */
    .back { 
      transform: rotateY(180deg); 
      background: #ffffff; 
      overflow-y: auto; 
      justify-content: flex-start; 
      text-align: left;
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    .back::-webkit-scrollbar { width: 6px; }
    .back::-webkit-scrollbar-track { background: transparent; }
    .back::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

    /* å¡ç‰‡å†…å®¹å­—ä½“ */
    .card-content-lg { 
      font-size: 1.6rem; 
      font-weight: 800; 
      color: var(--text-main); 
      line-height: 1.4; 
      margin-bottom: 16px; 
    }
    .card-clue { color: var(--text-sub); font-style: italic; margin-bottom: 20px; font-size: 1rem; }
    
    /* ç­”æ¡ˆå†…å®¹æ’ç‰ˆä¼˜åŒ– - ä½¿ç”¨ CSS å˜é‡æ§åˆ¶å­—ä½“ */
    .answer-container {
      font-size: var(--fs-card-answer); /* è¿™é‡Œçš„å˜é‡ç”± JS åŠ¨æ€ä¿®æ”¹ */
      line-height: 1.8;
      color: var(--card-ink);
      flex: 1; 
      padding-right: 8px;
      transition: font-size 0.2s; /* å¹³æ»‘è¿‡æ¸¡ */
    }
    
    .answer-main p { margin-bottom: 1em; }
    .answer-main strong { 
      color: var(--highlight-text); 
      background: var(--highlight-bg); 
      padding: 0 4px; 
      border-radius: 4px; 
      font-weight: 700;
    }
    .answer-main ul { padding-left: 1.2em; margin-bottom: 1em; }
    .answer-main li { margin-bottom: 0.5em; }

    /* åº•éƒ¨è‹±è¯­è¯æ±‡åŒº */
    .answer-vocab {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px dashed #e2e8f0;
      font-size: 0.9rem; /* è‹±è¯­éƒ¨åˆ†ä¿æŒå°å­—ä½“ï¼Œä¸éšç­”æ¡ˆæ”¾å¤§ */
      color: #64748b;
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
    }
    .vocab-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .vocab-label::before { content: ''; display: block; width: 4px; height: 4px; background: #cbd5e1; border-radius: 50%; }

    .review-controls {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .review-controls.visible { opacity: 1; pointer-events: auto; }
    
    .grade-btn {
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
      color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      flex: 1;
      font-size: 1rem;
    }
    .grade-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .grade-btn:active { transform: scale(0.98); }
    .grade-1 { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .grade-2 { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .grade-3 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .grade-4 { background: linear-gradient(135deg, #22c55e, #16a34a); }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stat-card {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      color: #0c4a6e;
    }
    .stat-card.highlight { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
    .stat-value { font-size: 1.8rem; font-weight: 800; line-height: 1.2; }
    .stat-label { font-size: 0.85rem; opacity: 0.9; }

    /* èŠå¤©ç»„ä»¶ä¼˜åŒ– */
    .chat-widget {
      position: fixed; bottom: 90px; right: 20px;
      width: 380px; height: 550px;
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      display: none;
      flex-direction: column;
      z-index: 1500;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .chat-header { background: var(--primary); color: white; padding: 12px 16px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    .chat-body { flex: 1; padding: 16px; overflow-y: auto; background: #f8fafc; font-size: 0.95rem; }
    .chat-footer { position: relative; padding: 12px; border-top: 1px solid var(--border); background: white; display: flex; gap: 8px; z-index: 5; }
    .chat-settings { padding: 8px 12px; background: #f1f5f9; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; }
    .msg { margin-bottom: 12px; max-width: 85%; padding: 10px 14px; border-radius: 12px; line-height: 1.5; word-wrap: break-word; }
    .msg.user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
    .msg.ai { background: white; border: 1px solid var(--border); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 2px; }
    .msg strong { color: #b91c1c; }

    /* ç®¡ç†é¢æ¿åˆ—è¡¨ */
    .manage-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
    .manage-tab { padding: 8px 16px; cursor: pointer; color: var(--text-sub); font-weight: 500; }
    .manage-tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    
    .manage-list { list-style: none; padding: 0; margin: 0; }
    .manage-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #f1f5f9; background: white; }
    .manage-item:hover { background: #f8fafc; }
    .manage-item:last-child { border-bottom: none; }
    
    .manage-tag-group { background: #fff; border-radius: 8px; padding: 0; margin-bottom: 12px; border: 1px solid var(--border); overflow: hidden; }
    .manage-tag-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f1f5f9; font-weight: 600; color: var(--primary-dark); }
    
    .check-box-wrapper { display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; }
    .item-checkbox { width: 16px; height: 16px; cursor: pointer; }

    /* è®¾ç½®å€’è®¡æ—¶åŒºåŸŸ */
    .countdown-container {
      margin-top: auto; 
      text-align: center; 
      color: var(--text-sub); 
      font-size: 0.85rem;
      background: #f1f5f9;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
    }
    .countdown-container:hover { background: #e2e8f0; }

    /* å“åº”å¼é€‚é… */
    @media (max-width: 1024px) {
      .app-container { grid-template-columns: 240px 1fr; }
      .tools-panel { display: none; }
    }
    @media (max-width: 768px) {
      .app-container { grid-template-columns: 1fr; }
      .sidebar { position: fixed; left: -100%; top: 0; bottom: 0; width: 80%; box-shadow: var(--shadow-lg); z-index: 100; }
      .sidebar.open { left: 0; }
      .mobile-nav-toggle { display: block; position: fixed; top: 16px; left: 16px; z-index: 90; background: white; padding: 8px; border-radius: 8px; box-shadow: var(--shadow-md); }
      .flip-container { width: 95%; height: 50vh; }
      .chat-widget { width: 90%; right: 5%; bottom: 20px; height: 60vh; }
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
<div class="mobile-nav-toggle btn" onclick="toggleSidebar()" style="display:none;">
  <span style="font-size:1.2rem;">â˜°</span>
</div>

<div class="app-container">
  <!-- å·¦ä¾§è¾¹æ  -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span>ğŸ“š ç§‘å­¦é—ªå¡ Pro</span>
      <span style="font-size:0.8rem; color:var(--text-sub); background:#f1f5f9; padding:2px 6px; border-radius:4px;">MPA</span>
    </div>

    <div class="input-group">
      <input type="text" class="input-field" placeholder="æœç´¢çŸ¥è¯†ç‚¹..." oninput="filterCards(this.value)">
    </div>

    <div class="nav-section">
      <div class="nav-title">å­¦ä¹ æ¨¡å¼</div>
      <div class="nav-item active" id="nav-all" onclick="resetFilter()">
        <i>ğŸ—‚ï¸</i> å…¨éƒ¨å¡ç‰‡ <span class="count-badge" id="count-total">0</span>
      </div>
      <div class="nav-item" id="nav-review" onclick="startFocusedReview()">
        <i>ğŸ¯</i> æ²‰æµ¸èƒŒè¯µ <span class="count-badge" style="background:var(--primary); color:white;" id="count-due">0</span>
      </div>
      <div class="nav-item" onclick="filterByStatus('wrong')">
        <i>ğŸ“•</i> é”™é¢˜æœ¬ <span class="count-badge" id="count-wrong">0</span>
      </div>
      <div class="nav-item" onclick="filterByStatus('high_freq')">
        <i>â­</i> é«˜é¢‘è€ƒç‚¹
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-title">ğŸ“š ç§‘ç›®åˆ†ç±»</div>
      <div id="subject-list">
        <!-- åŠ¨æ€ç”Ÿæˆç§‘ç›®åˆ—è¡¨ -->
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-title">ç³»ç»Ÿè®¾ç½®</div>
      <button class="btn btn-secondary btn-block" onclick="showSettingsModal()">âš™ï¸ åå¥½è®¾ç½® (ç­”æ¡ˆå­—å·/å€’è®¡æ—¶)</button>
    </div>

    <div class="nav-section" style="margin-top:auto;">
      <div class="nav-title">å¿«æ·æ“ä½œ</div>
      <button class="btn btn-primary btn-block" onclick="addNewCard()" style="margin-bottom:8px;">+ æ–°å»ºå¡ç‰‡</button>
      <button class="btn btn-secondary btn-block" onclick="showManageModal()" style="margin-bottom:8px;">ğŸ”§ ç®¡ç†é¢˜åº“</button>
      <button class="btn btn-ghost btn-block" onclick="showImportModal()">ğŸ“¥ å¯¼å…¥é¢˜åº“</button>
      <button class="btn btn-ghost btn-block" onclick="exportCards()">ğŸ“¤ å¤‡ä»½æ•°æ®</button>
    </div>
    
    <div id="countdown-box" class="countdown-container" onclick="showSettingsModal()" title="ç‚¹å‡»è®¾ç½®å€’è®¡æ—¶">
      <div id="countdown-title">è·ç¦»è€ƒç ”</div>
      <div style="font-size:1.4rem; font-weight:800; color:var(--primary);" id="countdown-days">--</div>
      <div>å¤©</div>
    </div>
  </div>

  <!-- ä¸­é—´ä¸»å†…å®¹ -->
  <div class="main-content">
    <div class="content-header">
      <h2 style="margin:0; font-size:1.5rem;" id="grid-title">å…¨éƒ¨å¡ç‰‡</h2>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-secondary" onclick="shuffleGrid()" title="æ‰“ä¹±é¡ºåºè¿›è¡ŒéšæœºæŠ½æŸ¥">
          ğŸ”€ éšæœºä¹±åº
        </button>
      </div>
    </div>
    
    <div class="flashcard-grid" id="grid">
      <!-- å¡ç‰‡å°†é€šè¿‡ JS æ¸²æŸ“ -->
    </div>
    
    <!-- ç©ºçŠ¶æ€æç¤º -->
    <div id="empty-state" style="display:none; text-align:center; padding:60px; color:var(--text-sub);">
      <div style="font-size:3rem; margin-bottom:20px;">ğŸƒ</div>
      <p>æš‚æ— å¡ç‰‡ï¼Œå¿«å»æ·»åŠ æˆ–è®© AI ç”Ÿæˆå§ï¼</p>
    </div>
  </div>

  <!-- å³ä¾§æ•°æ®æ  -->
  <div class="tools-panel">
    <div class="nav-title">ä»Šæ—¥æ¦‚è§ˆ</div>
    <div class="stat-card highlight">
      <div class="stat-label">è¿ç»­å­¦ä¹ </div>
      <div class="stat-value" id="stat-streak">0 <span style="font-size:1rem">å¤©</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ä»Šæ—¥å·²å­¦</div>
      <div class="stat-value" id="stat-today">0</div>
    </div>

    <div class="nav-title" style="margin-top:20px;">ç†Ÿç»ƒåº¦åˆ†å¸ƒ</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div class="stat-card" style="background:#f0fdf4; color:#166534; margin:0;">
        <div class="stat-value" id="stat-mastered">0</div>
        <div class="stat-label">å·²æŒæ¡</div>
      </div>
      <div class="stat-card" style="background:#fef2f2; color:#991b1b; margin:0;">
        <div class="stat-value" id="stat-learning">0</div>
        <div class="stat-label">å­¦ä¹ ä¸­</div>
      </div>
    </div>

    <div class="nav-title" style="margin-top:20px;">å¿«é€Ÿç¬”è®°</div>
    <textarea id="quick-note" class="input-field" style="height:150px; resize:none;" placeholder="éšæ‰‹è®°..." onblur="saveNote()"></textarea>
  </div>
</div>

<!-- æ²‰æµ¸å¼å¤ä¹ ç•Œé¢ (Overlay) -->
<div id="review-overlay">
  <div class="review-header">
    <button class="btn btn-ghost" onclick="endReview()">âœ• é€€å‡º</button>
    <div class="progress-bar-container">
      <div class="progress-fill" id="review-progress"></div>
    </div>
    <span style="font-weight:bold; color:var(--text-sub);" id="review-counter">0/0</span>
  </div>

  <div class="flip-container" onclick="flipCard()">
    <div class="flipper" id="review-card-flipper">
      <div class="front">
        <div class="card-content-lg" id="review-front">é¢˜ç›®å†…å®¹</div>
        <div class="card-clue" id="review-clue">çº¿ç´¢...</div>
        <div style="margin-top:auto; color:var(--text-sub); font-size:0.9rem;">(ç‚¹å‡»ç¿»çœ‹ç­”æ¡ˆ)</div>
      </div>
      <div class="back" id="review-back-container">
        <!-- ç­”æ¡ˆå†…å®¹å®¹å™¨ -->
      </div>
    </div>
  </div>

  <div class="review-controls" id="review-controls">
    <button class="grade-btn grade-1" onclick="rateCard(1)">å¿˜è®°/é”™è¯¯ (1)</button>
    <button class="grade-btn grade-2" onclick="rateCard(2)">å›°éš¾ (2)</button>
    <button class="grade-btn grade-3" onclick="rateCard(3)">è‰¯å¥½ (3)</button>
    <button class="grade-btn grade-4" onclick="rateCard(4)">ç®€å• (4)</button>
  </div>
</div>

<!-- èŠå¤©æ‚¬æµ®çƒä¸çª—å£ -->
<button onclick="toggleChat()" style="position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:30px; background:var(--primary); color:white; border:none; box-shadow:var(--shadow-lg); cursor:pointer; z-index:1400; font-size:1.5rem;">ğŸ¤–</button>

<div class="chat-widget" id="chat-widget">
  <div class="chat-header" onmousedown="dragChat(event)">
    <span>ğŸ“ è€ƒç ”ä¼´å­¦ AI (ä¸“ä¸šç‰ˆ)</span>
    <span style="cursor:pointer" onclick="toggleChat()">âœ•</span>
  </div>
  <div class="chat-settings">
    <span style="font-size:0.8rem;">æ¨¡å‹:</span>
    <select id="api-provider" class="input-field" style="padding:4px 24px 4px 8px; font-size:0.8rem; height:auto; width:auto;" onchange="updateApiProvider()">
      <option value="deepseek">DeepSeek V3</option>
      <option value="gemini">Google Gemini</option>
    </select>
  </div>
  <div class="chat-body" id="chat-body">
    <div class="msg ai">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±è€ƒç ”å¯¼å¸ˆã€‚æˆ‘å¯ä»¥ï¼š<br>1. ç”Ÿæˆä¸“ä¸šè¯¾é—ªå¡ï¼ˆå«è‹±è¯­è¯æ±‡ç§¯ç´¯ï¼Œå¦‚ *meticulous* ä¸€ä¸ä¸è‹Ÿçš„ï¼‰ã€‚<br>2. æ·±åº¦è§£æå…¬ç®¡è€ƒç‚¹ä¸æ—¶æ”¿ã€‚<br>è¯·åœ¨ä¸Šæ–¹é€‰æ‹©æ¨¡å‹å¹¶è®¾ç½® Keyã€‚</div>
  </div>
  <div class="chat-footer">
    <input type="text" id="chat-input" class="input-field" style="margin:0;" placeholder="è¾“å…¥å†…å®¹... (Enterå‘é€)" onkeydown="if(event.key==='Enter') sendMessage()">
    <button class="btn btn-primary" onclick="sendMessage()">å‘é€</button>
  </div>
  <div style="padding:8px 12px 12px; background:white; text-align:right; border-top:1px solid #f1f5f9; position:relative; z-index:10;">
     <button class="btn btn-ghost btn-sm" id="btn-set-key" onclick="setApiKey()">ğŸ”‘ è®¾ç½® API Key</button>
  </div>
</div>

<!-- é€šç”¨æ¨¡æ€æ¡† -->
<div id="modal-root" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
  <div style="background:white; padding:24px; border-radius:12px; width:90%; max-width:600px; max-height:85vh; overflow-y:auto; box-shadow:var(--shadow-lg); display:flex; flex-direction:column;">
    <h3 id="modal-title" style="margin-top:0;">æ ‡é¢˜</h3>
    <div id="modal-content" style="flex:1; overflow-y:auto;"></div>
    <div style="margin-top:20px; text-align:right; border-top:1px solid #f1f5f9; padding-top:12px;">
      <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
    </div>
  </div>
</div>

<script>
// ================= æ•°æ®å±‚ =================
const STORAGE_KEY = 'mpa_flashcards_pro';
const STATS_KEY = 'mpa_stats_pro';
const NOTES_KEY = 'mpa_quick_notes';
const SETTINGS_KEY = 'mpa_settings_v1';

const API_CONFIG = {
  deepseek: {
    name: 'DeepSeek',
    storageKey: 'deepseek_api_key',
    url: 'https://api.deepseek.com/chat/completions'
  },
  gemini: {
    name: 'Gemini',
    storageKey: 'gemini_api_key',
    url: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent'
  }
};
let currentProvider = 'deepseek';

let cards = [];
let reviewQueue = []; 
let currentReviewIndex = 0;
let currentFilter = 'all'; 
let manageViewMode = 'subject';
let appSettings = {
  cardFontSize: 'normal', // normal, medium, large
  examName: 'ç ”ç©¶ç”Ÿè€ƒè¯•',
  examDate: new Date(new Date().getFullYear(), 11, 21).toISOString().split('T')[0]
};

function initData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    cards = raw ? JSON.parse(raw) : getInitialData();
    cards.forEach(c => {
      if (!c.tags) c.tags = [];
      if (!c.category) c.category = "æœªåˆ†ç±»"; 
      if (!c.fs) c.fs = 2.5; 
      if (!c.interval) c.interval = 0;
    });
    
    const rawSettings = localStorage.getItem(SETTINGS_KEY);
    if(rawSettings) appSettings = JSON.parse(rawSettings);
    
  } catch (e) {
    console.error("Data load error", e);
    cards = getInitialData();
  }
  
  applySettings(); 
  updateStats();
  updateSubjectList(); 
  renderGrid();
  loadNote();
  
  const savedProvider = localStorage.getItem('preferred_api_provider');
  if (savedProvider && API_CONFIG[savedProvider]) {
    document.getElementById('api-provider').value = savedProvider;
    updateApiProvider();
  }
}

function getInitialData() {
  return [{
    id: Date.now(),
    front: "å…¬å…±ç®¡ç†çš„æ ¸å¿ƒä¸»ä½“æ˜¯ä»€ä¹ˆï¼Ÿ",
    back: "**æ”¿åºœ**æ˜¯å…¬å…±ç®¡ç†çš„æ ¸å¿ƒä¸»ä½“ã€‚\n\n1. æ”¿åºœæ‹¥æœ‰åˆæ³•çš„å¼ºåˆ¶åŠ›ã€‚\n2. åŒæ—¶ä¹ŸåŒ…æ‹¬éæ”¿åºœå…¬å…±ç»„ç»‡ï¼ˆNGO/NPOï¼‰ã€‚\n\n--- \n*mitigate (v. å‡è½»)*: Effective management helps mitigate social conflicts.",
    category: "å…¬å…±ç®¡ç†å­¦",
    tags: ["åŸºç¡€", "æ ¸å¿ƒæ¦‚å¿µ", "é«˜é¢‘"],
    nextReview: new Date().toISOString(),
    mastery: 0, 
    interval: 0,
    fs: 2.5
  }];
}

function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
  updateStats();
  updateSubjectList();
}

function saveSettings() {
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
  applySettings();
}

function applySettings() {
  // åº”ç”¨å¡ç‰‡ä¸“ç”¨å­—ä½“
  const root = document.documentElement;
  if(appSettings.cardFontSize === 'medium') {
    root.style.setProperty('--fs-card-answer', '1.2rem');
  } else if(appSettings.cardFontSize === 'large') {
    root.style.setProperty('--fs-card-answer', '1.4rem');
  } else {
    root.style.setProperty('--fs-card-answer', '1rem');
  }
  
  // åº”ç”¨å€’è®¡æ—¶
  document.getElementById('countdown-title').textContent = `è·ç¦»${appSettings.examName}`;
  const now = new Date();
  const target = new Date(appSettings.examDate);
  const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
  document.getElementById('countdown-days').textContent = diff > 0 ? diff : 0;
}

// ================= UI æ¸²æŸ“å±‚ =================

function updateSubjectList() {
  const subjects = {};
  cards.forEach(c => {
    const cat = c.category || "æœªåˆ†ç±»";
    subjects[cat] = (subjects[cat] || 0) + 1;
  });

  const listEl = document.getElementById('subject-list');
  listEl.innerHTML = '';
  
  Object.keys(subjects).sort().forEach(sub => {
    const div = document.createElement('div');
    div.className = 'nav-item';
    div.onclick = () => filterBySubject(sub);
    div.innerHTML = `<i>ğŸ“–</i> ${sub} <span class="count-badge">${subjects[sub]}</span>`;
    listEl.appendChild(div);
  });
}

function renderGrid(sourceCards = null) {
  let displayCards = sourceCards;
  if (!displayCards) {
    if (currentFilter === 'all') displayCards = cards;
    else if (currentFilter === 'wrong') displayCards = cards.filter(c => c.mastery < 2 && c.interval > 0);
    else if (currentFilter === 'high_freq') displayCards = cards.filter(c => (c.tags||[]).includes("é«˜é¢‘"));
    else if (currentFilter.startsWith('subject:')) {
      const sub = currentFilter.split(':')[1];
      displayCards = cards.filter(c => c.category === sub);
    }
  }

  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  
  if (!displayCards || displayCards.length === 0) {
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('count-total').textContent = cards.length;
    return;
  } else {
    document.getElementById('empty-state').style.display = 'none';
  }

  displayCards.forEach(card => {
    const el = document.createElement('div');
    el.className = 'card-thumb';
    el.onclick = () => previewSingleCard(card.id);
    
    let statusClass = 'status-new';
    if (card.mastery >= 4) statusClass = 'status-mastered';
    else if (card.interval > 0) statusClass = 'status-learning';

    const catBadge = card.category ? `<span class="tag-pill" style="background:#f3f4f6;color:#4b5563;">${card.category}</span>` : '';
    const tagsHtml = card.tags.slice(0,3).map(t => {
      const style = t === 'é«˜é¢‘' ? 'background:#fef3c7;color:#d97706;' : '';
      return `<span class="tag-pill" style="${style}">${t}</span>`;
    }).join('');
    
    el.innerHTML = `
      <div class="card-actions">
        <div class="icon-btn" title="ç¼–è¾‘" onclick="event.stopPropagation(); editCard(${card.id})">âœ</div>
      </div>
      <div class="card-meta">
        <span><span class="status-dot ${statusClass}"></span>${new Date(card.nextReview).toLocaleDateString()}</span>
        <span>${card.mastery}/4</span>
      </div>
      <div class="card-title">${escapeHtml(card.front)}</div>
      <div class="card-tags">${catBadge} ${tagsHtml}</div>
    `;
    grid.appendChild(el);
  });
  
  updateSidebarCounts();
}

function previewSingleCard(id) {
  const card = cards.find(c => c.id === id);
  if (!card) return;
  reviewQueue = [card]; 
  currentReviewIndex = 0;
  document.getElementById('review-overlay').classList.add('active');
  showReviewCard();
}

function shuffleGrid() {
  let currentCards = [];
  if (currentFilter === 'all') currentCards = [...cards];
  else if (currentFilter === 'wrong') currentCards = cards.filter(c => c.mastery < 2 && c.interval > 0);
  else if (currentFilter === 'high_freq') currentCards = cards.filter(c => (c.tags||[]).includes("é«˜é¢‘"));
  else if (currentFilter.startsWith('subject:')) {
    const sub = currentFilter.split(':')[1];
    currentCards = cards.filter(c => c.category === sub);
  }

  for (let i = currentCards.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [currentCards[i], currentCards[j]] = [currentCards[j], currentCards[i]];
  }
  
  renderGrid(currentCards);
  alert("ğŸ”€ å·²æ‰“ä¹±å¡ç‰‡é¡ºåºï¼Œç‚¹å‡»ä»»æ„å¡ç‰‡å¼€å§‹èƒŒè¯µï¼");
}

function updateSidebarCounts() {
  document.getElementById('count-total').textContent = cards.length;
  document.getElementById('count-wrong').textContent = cards.filter(c => c.mastery < 2 && c.interval > 0).length;
  const now = new Date();
  const dueCount = cards.filter(c => new Date(c.nextReview) <= now).length;
  document.getElementById('count-due').textContent = dueCount;
}

function updateStats() {
  const stats = JSON.parse(localStorage.getItem(STATS_KEY) || '{"streak":0, "lastDate":null, "todayCount":0}');
  const today = new Date().toDateString();
  if (stats.lastDate !== today) {
    if (stats.lastDate === new Date(Date.now() - 86400000).toDateString()) {
      stats.streak++;
    } else {
      stats.streak = 1; 
    }
    stats.todayCount = 0;
    stats.lastDate = today;
    localStorage.setItem(STATS_KEY, JSON.stringify(stats));
  }
  document.getElementById('stat-streak').textContent = stats.streak + ' å¤©';
  document.getElementById('stat-today').textContent = stats.todayCount;
  document.getElementById('stat-mastered').textContent = cards.filter(c => c.mastery >= 4).length;
  document.getElementById('stat-learning').textContent = cards.filter(c => c.interval > 0 && c.mastery < 4).length;
}

// ================= æ²‰æµ¸å¼å¤ä¹ é€»è¾‘ =================

function startFocusedReview() {
  const now = new Date();
  reviewQueue = cards.filter(c => new Date(c.nextReview) <= now)
                     .sort((a,b) => a.mastery - b.mastery) 
                     .slice(0, 50); 
  
  if (reviewQueue.length === 0) {
    alert("å¤ªæ£’äº†ï¼å½“å‰æ²¡æœ‰å¾…å¤ä¹ çš„å¡ç‰‡ã€‚\nä½ å¯ä»¥ç‚¹å‡»â€œå…¨éƒ¨å¡ç‰‡â€æˆ–â€œéšæœºä¹±åºâ€è¿›è¡Œå·©å›ºã€‚");
    return;
  }

  currentReviewIndex = 0;
  document.getElementById('review-overlay').classList.add('active');
  showReviewCard();
}

function showReviewCard() {
  if (currentReviewIndex >= reviewQueue.length) {
    endReview(true);
    return;
  }
  
  const card = reviewQueue[currentReviewIndex];
  const flipper = document.getElementById('review-card-flipper');
  const controls = document.getElementById('review-controls');
  
  // å…³é”®ï¼šé‡ç½® flipper çŠ¶æ€
  flipper.classList.remove('flipped');
  controls.classList.remove('visible');
  
  document.getElementById('review-front').innerHTML = `<div style="font-size:0.9rem;color:#6366f1;margin-bottom:8px;">${card.category||'æœªåˆ†ç±»'}</div>` + card.front;
  document.getElementById('review-clue').textContent = card.clue || "";
  
  document.getElementById('review-back-container').innerHTML = parseCardAnswer(card.back);
  
  const progress = ((currentReviewIndex) / reviewQueue.length) * 100;
  document.getElementById('review-progress').style.width = `${progress}%`;
  document.getElementById('review-counter').textContent = `${currentReviewIndex + 1}/${reviewQueue.length}`;
}

function flipCard() {
  const flipper = document.getElementById('review-card-flipper');
  if (!flipper.classList.contains('flipped')) {
    flipper.classList.add('flipped');
    setTimeout(() => {
      document.getElementById('review-controls').classList.add('visible');
    }, 300);
  }
}

function rateCard(quality) {
  const card = reviewQueue[currentReviewIndex];
  
  if (quality >= 3) {
    if (card.interval === 0) card.interval = 1;
    else if (card.interval === 1) card.interval = 6;
    else card.interval = Math.round(card.interval * card.fs);
    card.mastery = Math.min(4, card.mastery + 1);
  } else {
    card.interval = 1;
    card.mastery = Math.max(0, card.mastery - 1);
  }
  
  card.fs = card.fs + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
  if (card.fs < 1.3) card.fs = 1.3;

  const nextDate = new Date();
  nextDate.setDate(nextDate.getDate() + card.interval);
  card.nextReview = nextDate.toISOString();
  
  const originalIndex = cards.findIndex(c => c.id === card.id);
  if (originalIndex !== -1) {
    cards[originalIndex] = card;
  }

  recordStudyAction();
  saveData();

  currentReviewIndex++;
  showReviewCard();
}

function endReview(finished = false) {
  if (finished) alert("ğŸ‰ å¤ä¹ å®Œæˆï¼çœŸæ£’ï¼");
  document.getElementById('review-overlay').classList.remove('active');
  renderGrid(); 
}

function recordStudyAction() {
  const stats = JSON.parse(localStorage.getItem(STATS_KEY));
  stats.todayCount++;
  localStorage.setItem(STATS_KEY, JSON.stringify(stats));
  document.getElementById('stat-today').textContent = stats.todayCount;
}

// ================= è®¾ç½®åŠŸèƒ½ =================

function showSettingsModal() {
  const modal = document.getElementById('modal-root');
  const content = document.getElementById('modal-content');
  document.getElementById('modal-title').textContent = "âš™ï¸ ç³»ç»Ÿè®¾ç½®";
  
  content.innerHTML = `
    <div style="margin-bottom:20px;">
      <h4 style="margin-bottom:10px;">ğŸ“– å¡ç‰‡ç­”æ¡ˆå­—å·</h4>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-secondary ${appSettings.cardFontSize === 'normal' ? 'btn-primary' : ''}" onclick="updateFontSize('normal')">æ ‡å‡†</button>
        <button class="btn btn-secondary ${appSettings.cardFontSize === 'medium' ? 'btn-primary' : ''}" onclick="updateFontSize('medium')">ä¸­å·</button>
        <button class="btn btn-secondary ${appSettings.cardFontSize === 'large' ? 'btn-primary' : ''}" onclick="updateFontSize('large')">å¤§å· (æŠ¤çœ¼)</button>
      </div>
    </div>
    <div style="margin-bottom:20px;">
      <h4 style="margin-bottom:10px;">â³ è€ƒç ”å€’è®¡æ—¶</h4>
      <div class="input-group">
        <label style="display:block;margin-bottom:5px;font-size:0.9rem;">ç›®æ ‡åç§°:</label>
        <input type="text" id="set-exam-name" class="input-field" value="${appSettings.examName}">
      </div>
      <div class="input-group">
        <label style="display:block;margin-bottom:5px;font-size:0.9rem;">ç›®æ ‡æ—¥æœŸ:</label>
        <input type="date" id="set-exam-date" class="input-field" value="${appSettings.examDate}">
      </div>
      <button class="btn btn-primary btn-block" onclick="updateCountdownSetting()">ä¿å­˜å€’è®¡æ—¶</button>
    </div>
  `;
  modal.style.display = 'flex';
}

function updateFontSize(size) {
  appSettings.cardFontSize = size;
  saveSettings();
  showSettingsModal(); 
}

function updateCountdownSetting() {
  const name = document.getElementById('set-exam-name').value;
  const date = document.getElementById('set-exam-date').value;
  if(name && date) {
    appSettings.examName = name;
    appSettings.examDate = date;
    saveSettings();
    alert('è®¾ç½®å·²ä¿å­˜ï¼');
    closeModal();
  } else {
    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
  }
}

// ================= åŠŸèƒ½å‡½æ•°ï¼šç®¡ç†ä¸å¯¼å…¥ =================

function showManageModal(mode = 'subject') {
  manageViewMode = mode;
  const modal = document.getElementById('modal-root');
  const content = document.getElementById('modal-content');
  document.getElementById('modal-title').textContent = "ğŸ”§ é¢˜åº“ç®¡ç†";
  
  let html = `
    <div class="manage-tabs">
      <div class="manage-tab ${mode === 'subject' ? 'active' : ''}" onclick="showManageModal('subject')">æŒ‰ç§‘ç›®åˆ†ç»„</div>
      <div class="manage-tab ${mode === 'list' ? 'active' : ''}" onclick="showManageModal('list')">å…¨éƒ¨åˆ—è¡¨ (æ‰¹é‡)</div>
    </div>
    <div style="max-height: 60vh; overflow-y: auto;">
  `;

  if (mode === 'subject') {
    const grouped = {};
    cards.forEach(c => {
      const cat = c.category || "æœªåˆ†ç±»";
      if(!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(c);
    });
    
    Object.keys(grouped).forEach(cat => {
      html += `
        <div class="manage-tag-group">
          <div class="manage-tag-header">
            <span>ğŸ“– ${cat} (${grouped[cat].length})</span>
            <button class="btn btn-danger btn-sm" onclick="deleteByCategory('${cat}')">åˆ é™¤æ­¤ç§‘ç›®</button>
          </div>
          <ul class="manage-list">
            ${grouped[cat].map(c => `
              <li class="manage-item">
                <span style="font-size:0.9rem; color:#334155;">${escapeHtml(c.front).substring(0, 30)}...</span>
                <button class="btn btn-ghost btn-sm" onclick="editCard(${c.id})">âœ</button>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    });
  } else {
    html += `
      <div style="margin-bottom:10px; display:flex; gap:10px;">
        <button class="btn btn-danger btn-sm" onclick="batchDelete()">åˆ é™¤é€‰ä¸­</button>
        <input type="text" class="input-field" style="padding:4px 8px;" placeholder="ç­›é€‰..." oninput="filterManageList(this.value)">
      </div>
      <ul class="manage-list" id="manage-all-list">
        ${cards.map(c => `
          <li class="manage-item" data-text="${c.front.toLowerCase()}">
            <div class="check-box-wrapper">
              <input type="checkbox" class="item-checkbox" value="${c.id}">
              <div style="display:flex; flex-direction:column;">
                <span style="font-size:0.9rem; color:#334155;">${escapeHtml(c.front).substring(0, 35)}...</span>
                <span style="font-size:0.75rem; color:#64748b;">${c.category} | ${c.tags.join(', ')}</span>
              </div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="editCard(${c.id})">âœ</button>
          </li>
        `).join('')}
      </ul>
    `;
  }
  
  if (cards.length === 0) html += '<p style="text-align:center;color:#94a3b8;">æš‚æ— å¡ç‰‡æ•°æ®</p>';
  html += '</div>';
  content.innerHTML = html;
  modal.style.display = 'flex';
}

function filterManageList(text) {
  const items = document.querySelectorAll('#manage-all-list .manage-item');
  items.forEach(item => {
    item.style.display = item.dataset.text.includes(text.toLowerCase()) ? 'flex' : 'none';
  });
}

function batchDelete() {
  const checkboxes = document.querySelectorAll('.item-checkbox:checked');
  if (checkboxes.length === 0) return alert("è¯·å…ˆé€‰æ‹©å¡ç‰‡");
  if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} å¼ å¡ç‰‡å—ï¼Ÿ`)) return;
  
  const idsToDelete = Array.from(checkboxes).map(cb => parseFloat(cb.value));
  cards = cards.filter(c => !idsToDelete.includes(c.id));
  saveData();
  renderGrid();
  showManageModal('list');
}

function deleteByCategory(cat) {
  if(!confirm(`ç¡®å®šè¦åˆ é™¤ç§‘ç›® "${cat}" ä¸‹çš„æ‰€æœ‰å¡ç‰‡å—ï¼Ÿ`)) return;
  cards = cards.filter(c => (c.category || "æœªåˆ†ç±»") !== cat);
  saveData();
  renderGrid();
  showManageModal('subject');
}

function deleteSingleCard(id) {
  if (!confirm("ç¡®å®šåˆ é™¤æ­¤å¡ç‰‡ï¼Ÿ")) return;
  cards = cards.filter(c => c.id !== id);
  saveData();
  renderGrid();
  if(document.getElementById('modal-root').style.display === 'flex') {
    showManageModal(manageViewMode);
  }
}

function addNewCard() {
  const front = prompt("è¾“å…¥é—®é¢˜ (Front):");
  if (!front) return;
  const back = prompt("è¾“å…¥ç­”æ¡ˆ (Back) - å¦‚æœåŒ…å«è‹±è¯­ç§¯ç´¯ï¼Œè¯·åœ¨æœ€åç”¨ '---' åˆ†éš”:");
  if (!back) return;
  const category = prompt("è¾“å…¥ç§‘ç›®åˆ†ç±»:", "å…¬å…±ç®¡ç†å­¦");
  const tagsStr = prompt("è¾“å…¥æ ‡ç­¾:", "åŸºç¡€, é«˜é¢‘");
  
  const tags = tagsStr ? tagsStr.split(/,|ï¼Œ/).map(t=>t.trim()).filter(t=>t) : [];

  const newCard = {
    id: Date.now(),
    front: front,
    back: back,
    category: category || "æœªåˆ†ç±»",
    tags: tags,
    nextReview: new Date().toISOString(),
    mastery: 0,
    interval: 0,
    fs: 2.5
  };
  
  cards.unshift(newCard);
  saveData();
  renderGrid();
}

function editCard(id) {
  const card = cards.find(c => c.id === id);
  if(!confirm(`ç¼–è¾‘å¡ç‰‡ï¼š${card.front}\nç‚¹å‡»ç¡®å®šè¿›å…¥ç¼–è¾‘ï¼Œç‚¹å‡»å–æ¶ˆåˆ é™¤å¡ç‰‡`)) {
    if(confirm("ç¡®å®šè¦åˆ é™¤è¿™å¼ å¡ç‰‡å—ï¼Ÿ")) {
      deleteSingleCard(id);
    }
    return;
  }
  
  const newFront = prompt("ä¿®æ”¹é—®é¢˜:", card.front);
  const newBack = prompt("ä¿®æ”¹ç­”æ¡ˆ (ç”¨ --- åˆ†éš”è‹±è¯­è¯æ±‡):", card.back);
  const newCat = prompt("ä¿®æ”¹ç§‘ç›®:", card.category);
  const newTags = prompt("ä¿®æ”¹æ ‡ç­¾ (é€—å·åˆ†éš”):", card.tags.join(", "));
  
  if (newFront && newBack) {
    card.front = newFront;
    card.back = newBack;
    card.category = newCat || card.category;
    if (newTags !== null) {
       card.tags = newTags.split(/,|ï¼Œ/).map(t=>t.trim()).filter(t=>t);
    }
    saveData();
    renderGrid();
    if(document.getElementById('modal-root').style.display === 'flex') {
        showManageModal(manageViewMode);
    }
  }
}

function showImportModal() {
  const modal = document.getElementById('modal-root');
  const content = document.getElementById('modal-content');
  document.getElementById('modal-title').textContent = "å¯¼å…¥é¢˜åº“ (JSON)";
  
  content.innerHTML = `
    <div style="background:#f0f9ff; border:1px solid #bae6fd; color:#0c4a6e; padding:10px; border-radius:6px; font-size:0.85rem; margin-bottom:10px;">
      <strong>âš ï¸ ç­”æ¡ˆæ ¼å¼æç¤ºï¼š</strong><br>
      JSON æ•°ç»„ã€‚<code>back</code> å­—æ®µå¯ç”¨ <code>---</code> åˆ†éš”è‹±è¯­è¯æ±‡ã€‚<br>
    </div>
    <textarea id="import-area" class="input-field" style="height:150px;font-family:monospace;font-size:12px;" placeholder='[{"front":"é¢˜ç›®","back":"ç­”æ¡ˆ... \\n--- \\nè‹±è¯­å•è¯","category":"æ”¿æ²»","tags":["é«˜é¢‘"]}]'></textarea>
    <button class="btn btn-primary btn-block" onclick="executeImport()">ç¡®è®¤å¯¼å…¥</button>
  `;
  modal.style.display = 'flex';
}

function executeImport() {
  try {
    const json = document.getElementById('import-area').value;
    const data = JSON.parse(json);
    if (!Array.isArray(data)) throw new Error("æ ¼å¼ä¸æ˜¯æ•°ç»„");
    
    let count = 0;
    data.forEach(item => {
      if (item.front && item.back) {
        let tags = item.tags || [];
        if (typeof tags === 'string') tags = [tags];
        if (item.front.includes("é«˜é¢‘") && !tags.includes("é«˜é¢‘")) tags.push("é«˜é¢‘");

        cards.push({
          id: Date.now() + Math.random(),
          front: item.front,
          back: item.back,
          category: item.category || "æœªåˆ†ç±»",
          tags: tags,
          nextReview: new Date().toISOString(),
          mastery: 0,
          interval: 0,
          fs: 2.5
        });
        count++;
      }
    });
    saveData();
    closeModal();
    renderGrid();
    alert(`æˆåŠŸå¯¼å…¥ ${count} å¼ å¡ç‰‡`);
  } catch (e) {
    alert("å¯¼å…¥å¤±è´¥ï¼ŒJSON æ ¼å¼é”™è¯¯");
  }
}

function exportCards() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cards));
  const node = document.createElement('a');
  node.setAttribute("href", dataStr);
  node.setAttribute("download", "mpa_flashcards_backup.json");
  document.body.appendChild(node);
  node.click();
  node.remove();
}

function closeModal() {
  document.getElementById('modal-root').style.display = 'none';
}

function filterCards(keyword) {
  if (!keyword) {
    renderGrid();
    return;
  }
  const lower = keyword.toLowerCase();
  const filtered = cards.filter(c => c.front.toLowerCase().includes(lower) || c.back.toLowerCase().includes(lower));
  renderGrid(filtered);
}

function filterByStatus(type) {
  currentFilter = type;
  updateNavActiveState();
  document.getElementById('grid-title').textContent = type === 'wrong' ? 'é”™é¢˜æœ¬' : 'é«˜é¢‘è€ƒç‚¹';
  renderGrid();
}

function filterBySubject(subject) {
  currentFilter = 'subject:' + subject;
  updateNavActiveState();
  document.getElementById('grid-title').textContent = subject;
  renderGrid();
}

function resetFilter() {
  currentFilter = 'all';
  updateNavActiveState();
  document.getElementById('grid-title').textContent = 'å…¨éƒ¨å¡ç‰‡';
  renderGrid();
}

function updateNavActiveState() {
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  if (currentFilter === 'all') document.getElementById('nav-all').classList.add('active');
}

function loadNote() {
  document.getElementById('quick-note').value = localStorage.getItem(NOTES_KEY) || "";
}
function saveNote() {
  localStorage.setItem(NOTES_KEY, document.getElementById('quick-note').value);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function parseCardAnswer(text) {
  let rawHtml = escapeHtml(text);
  const parts = rawHtml.split('---');
  let mainContent = parts[0];
  let vocabContent = parts.length > 1 ? parts.slice(1).join('---') : '';
  
  const mdToHtml = (str) => {
    return str.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
              .replace(/\*(.*?)\*/g, '<em>$1</em>') 
              .replace(/\n/g, '<br>'); 
  };

  let html = `<div class="answer-main">${mdToHtml(mainContent)}</div>`;
  
  if (vocabContent && vocabContent.trim()) {
    html += `<div class="answer-vocab">
              <div class="vocab-label">è€ƒç ”è‹±è¯­ç§¯ç´¯</div>
              ${mdToHtml(vocabContent.trim())}
             </div>`;
  }
  
  return html;
}

function parseMarkdown(text) {
  let html = escapeHtml(text);
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
  html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); 
  html = html.replace(/\n/g, '<br>'); 
  return html;
}

// ================= AI åŠ©æ‰‹é€»è¾‘ =================

let chatVisible = false;
function toggleChat() {
  const w = document.getElementById('chat-widget');
  chatVisible = !chatVisible;
  w.style.display = chatVisible ? 'flex' : 'none';
}

function updateApiProvider() {
  const select = document.getElementById('api-provider');
  currentProvider = select.value;
  localStorage.setItem('preferred_api_provider', currentProvider);
  
  const btn = document.getElementById('btn-set-key');
  btn.textContent = `ğŸ”‘ è®¾ç½® ${API_CONFIG[currentProvider].name} Key`;
}

function setApiKey() {
  const config = API_CONFIG[currentProvider];
  const oldKey = localStorage.getItem(config.storageKey) || "";
  const key = prompt(`è¯·è¾“å…¥ ${config.name} API Key:`, oldKey);
  if (key) {
    localStorage.setItem(config.storageKey, key);
    alert(`${config.name} Key å·²ä¿å­˜ï¼`);
  }
}

function dragChat(e) {
  const el = document.getElementById('chat-widget');
  let shiftX = e.clientX - el.getBoundingClientRect().left;
  let shiftY = e.clientY - el.getBoundingClientRect().top;
  function moveAt(pageX, pageY) {
    el.style.left = pageX - shiftX + 'px';
    el.style.top = pageY - shiftY + 'px';
    el.style.bottom = 'auto';
    el.style.right = 'auto';
  }
  function onMouseMove(event) { moveAt(event.pageX, event.pageY); }
  document.addEventListener('mousemove', onMouseMove);
  el.onmouseup = function() {
    document.removeEventListener('mousemove', onMouseMove);
    el.onmouseup = null;
  };
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  
  addMsg('user', text);
  input.value = '';

  const config = API_CONFIG[currentProvider];
  const apiKey = localStorage.getItem(config.storageKey);
  
  if (!apiKey) {
    addMsg('ai', `è¯·å…ˆç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®¾ç½® ${config.name} API Keyã€‚`);
    return;
  }

  addMsg('ai', 'æ­£åœ¨æ€è€ƒ...', true); 
  
  try {
    const systemPrompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ä¸­å›½å…¬å…±ç®¡ç†è€ƒç ”å‘½é¢˜ç»„ä¸“å®¶å’Œé˜…å·ç»„é•¿ã€‚ä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©è€ƒç”Ÿç”Ÿæˆé«˜è´¨é‡çš„é—ªå¡ï¼Œå¹¶è§£ç­”ä¸“ä¸šé—®é¢˜ã€‚

ã€ä½œç­”æ ‡å‡†ã€‘ï¼š
1. **ç»“æ„åŒ–è¾“å‡º**ï¼šéµå¾ªã€å®šä¹‰ -> æ ¸å¿ƒè¦ç´  -> æ„ä¹‰ -> ç»“è®ºã€‘çš„é€»è¾‘ã€‚
2. **ç»“åˆæ—¶æ”¿**ï¼šè”ç³»ä¸­å›½çƒ­ç‚¹ï¼ˆå¦‚ï¼šæ•°å­—æ”¿åºœã€å…±åŒå¯Œè£•ç­‰ï¼‰ã€‚
3. **è‹±è¯­æ¤å…¥**ï¼šåœ¨å›ç­”ç»“æŸï¼Œä½¿ç”¨åˆ†å‰²çº¿ "---" å¦èµ·ä¸€è¡Œï¼Œåˆ—å‡º 1-2 ä¸ªè€ƒç ”è‹±è¯­é«˜é¢‘éš¾è¯ã€‚
4. **JSONæ ¼å¼**ï¼šå¦‚ç”¨æˆ·è¦æ±‚ç”Ÿæˆå¡ç‰‡ï¼Œè¯·è¿”å› [{"front":"...","back":"...","category":"...","tags":["..."]}]ã€‚`;

    let response, data;
    
    if (currentProvider === 'deepseek') {
      response = await fetch(config.url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: [{role: "system", content: systemPrompt}, {role: "user", content: text}],
          stream: false
        })
      });
      data = await response.json();
    } else if (currentProvider === 'gemini') {
      const url = `${config.url}?key=${apiKey}`;
      response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ role: "user", parts: [{ text: systemPrompt + "\n\nUser Question: " + text }] }]
        })
      });
      data = await response.json();
    }

    const loadingMsg = document.querySelector('.msg.ai:last-child');
    if (loadingMsg && loadingMsg.textContent === 'æ­£åœ¨æ€è€ƒ...') loadingMsg.remove();

    let reply = '';
    if (currentProvider === 'deepseek' && data.choices) {
      reply = data.choices[0].message.content;
    } else if (currentProvider === 'gemini' && data.candidates) {
      reply = data.candidates[0].content.parts[0].text;
    } else {
      reply = 'API è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æˆ–ç½‘ç»œã€‚';
      console.error(data);
    }

    addMsg('ai', reply);
    
    if (reply.includes('[') && reply.includes(']')) {
       try {
          const jsonStart = reply.indexOf('[');
          const jsonEnd = reply.lastIndexOf(']') + 1;
          const jsonStr = reply.substring(jsonStart, jsonEnd);
          JSON.parse(jsonStr); 
          const btnId = 'btn-import-' + Date.now();
          addMsg('ai', `<button id="${btnId}" class="btn btn-primary btn-sm">æ£€æµ‹åˆ°é—ªå¡æ•°æ®ï¼Œç‚¹å‡»ä¸€é”®å¯¼å…¥</button>`);
          document.getElementById(btnId).onclick = function() {
             document.getElementById('import-area').value = jsonStr;
             executeImport();
             this.disabled = true;
             this.textContent = "å·²å¯¼å…¥";
          };
       } catch(e) {}
    }

  } catch (e) {
    console.error(e);
    addMsg('ai', 'ç½‘ç»œè¯·æ±‚å‡ºé”™ã€‚');
  }
}

function addMsg(role, text, isLoading=false) {
  const body = document.getElementById('chat-body');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  if (!isLoading && role === 'ai') {
      div.innerHTML = parseMarkdown(text); 
  } else {
      div.innerHTML = text; 
  }
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

window.onload = initData;

document.addEventListener('keydown', (e) => {
  if (document.getElementById('review-overlay').classList.contains('active')) {
    if (e.key === ' ' || e.key === 'Enter') flipCard();
    if (document.getElementById('review-controls').classList.contains('visible')) {
      if (e.key === '1') rateCard(1);
      if (e.key === '2') rateCard(2);
      if (e.key === '3') rateCard(3);
      if (e.key === '4') rateCard(4);
    }
    if (e.key === 'Escape') endReview();
  }
});
</script>
</body>
</html>
