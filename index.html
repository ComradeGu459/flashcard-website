<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç§‘å­¦é—ªå¡èƒŒè¯µç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--
    æœ¬åº”ç”¨æ˜¯ä¸€ä¸ªåŸºäºæµè§ˆå™¨çš„é—ªå¡å­¦ä¹ å·¥å…·ã€‚å®ƒæ”¯æŒåˆ†ç±»ã€ç« èŠ‚å’Œæ ‡ç­¾ç®¡ç†ï¼Œ
    å†…ç½®é—´éš”é‡å¤ç®—æ³•ï¼Œæ”¯æŒæ‰¹é‡å¯¼å…¥/å¯¼å‡ºã€é”™é¢˜æœ¬ã€å¤ä¹ æ¨¡å¼ã€ç¬”è®°ç³»ç»Ÿç­‰åŠŸèƒ½ã€‚
    åœ¨åŸæœ‰åŠŸèƒ½çš„åŸºç¡€ä¸Šå¼•å…¥äº†æ ‡ç­¾è¿‡æ»¤å’Œå¡ç‰‡é“¾æ¥åŠŸèƒ½ï¼Œæ–¹ä¾¿ç”¨æˆ·æ„å»ºè‡ªå·±çš„çŸ¥è¯†ç½‘ç»œã€‚
  -->
  <style>
    html,body { height: 100%; margin: 0; padding: 0; background: #f5f7fa; color: #222; }
    body { font-family: 'Roboto Slab', 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; }
    .container {
      display: grid;
      grid-template-columns: 300px 1fr 320px;
      gap: 28px;
      max-width: 1480px;
      margin: 0 auto;
      padding: 24px 14px 38px 14px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .sidebar, .tools-section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 20px #24335608, 0 1px 2px #24335611;
      padding: 28px 20px 22px 20px;
      min-width: 0;
      min-height: 650px;
      max-height: 92vh;
      position: sticky;
      top: 22px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow-y: auto;
    }
    .sidebar { align-self: start; }
    .tools-section { align-self: start; }
    .flashcard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      grid-auto-rows: max-content;
      gap: 28px;
      align-items: stretch;
      justify-items: stretch;
      padding: 20px;
      padding-bottom: 40px;
      max-height: 92vh;
      overflow-y: auto;
    }
    /* ç¼©ç•¥å¡ç‰‡æ ·å¼ */
    .flashcard-thumb {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      min-height: 120px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      text-align: left;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform .2s;
    }
    .flashcard-thumb:hover { transform: scale(1.05); }
    .flashcard-thumb .thumb-title { font-weight: 600; color: #334155; font-size: 1.05em; margin-bottom: 4px; }
    .flashcard-thumb .thumb-clue { color: #64748b; font-size: 0.9em; line-height: 1.4; }

    /* é«˜é¢‘æ ‡è®°æ˜Ÿæ˜Ÿ */
    .thumb-star {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 18px;
      color: #cbd5e1;
      cursor: pointer;
      transition: color 0.2s;
    }
    .thumb-star.active {
      color: #facc15;
    }
    .thumb-star:hover {
      color: #fcd34d;
    }
    /* å¡ç‰‡æ¨¡æ€å¼¹çª— */
    #card-modal {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(3px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 40px;
      overflow-y: auto;
      z-index: 1500;
      transition: opacity 0.3s ease;
      opacity: 1;
    }
    #card-modal.active { display: flex; animation: fadeIn 0.25s; }
    #card-modal .card-popup {
      background: #fff;
      max-width: 720px;
      width: 100%;
      max-height: 80vh;
      padding: 32px;
      border-radius: 20px;
      position: relative;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
    }
    #card-modal .close-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      background: #f8fafc;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      cursor: pointer;
    }
    #card-modal .popup-title { font-size: 1.3em; font-weight: 700; margin-bottom: 12px; }
    #card-modal .popup-content { flex: 1; overflow-y: auto; line-height: 1.6; margin-bottom: 18px; color: #374151; }
    /* ä¼˜åŒ–ç­”æ¡ˆå†…å®¹æ’ç‰ˆ */
    #card-modal .popup-content p {
      margin: 8px 0;
      line-height: 1.65;
    }
    #card-modal .popup-content strong {
      display: block;
      margin-top: 12px;
      font-weight: 600;
      font-size: 1.05em;
      color: #1f2937;
    }
    #card-modal .popup-content em {
      font-style: italic;
      color: #475569;
    }
    #card-modal .popup-clue { color: #64748b; margin-bottom: 12px; }
    #card-modal .mastery-buttons { justify-content: center; margin-top: 10px; }
    /* æ ‡ç­¾è¿‡æ»¤åŒºæ ·å¼ */
    .tag-filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      color: #374151;
      background: #f8fafc;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }
    .tag-filter-header:hover {
      background: #eef2ff;
    }
    #tag-list {
      margin-top: 6px;
      flex-wrap: wrap;
      gap: 6px;
    }
    #tag-list.collapsed {
      display: none;
    }
    #tag-list.expanded {
      display: flex;
      max-height: 160px;
      overflow-y: auto;
    }
    .tag-item {
      display: inline-block;
      background: #e5e7eb;
      color: #374151;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .tag-item:hover {
      background: #dbeafe;
      color: #3730a3;
    }
    /* æ´»è·ƒæ ‡ç­¾æ ·å¼ä¸æ¸…é™¤æŒ‰é’® */
    .tag-item.active {
      background: #6366f1;
      color: #fff;
    }
    .tag-clear {
      background: #f3f4f6;
      color: #374151;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .tag-clear:hover {
      background: #e5e7eb;
    }
    /* å­¦ä¹ ç»Ÿè®¡åŒº */
    .progress-ring { position: relative; width: 60px; height: 60px; }
    .progress-ring-circle-bg { fill: none; stroke: #e2e8f0; stroke-width: 4; }
    .progress-ring-circle {
      fill: none;
      /* ä½¿ç”¨æ¸å˜ä½œä¸ºè¿›åº¦é¢œè‰²ï¼Œå‘ˆç°è“ç´«è¿‡æ¸¡ */
      stroke: url(#progressGradient);
      stroke-width: 4;
      transform: rotate(-90deg);
      transform-origin: center;
      transition: stroke-dashoffset 0.3s ease;
    }
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
      color: #4c1d95;
      pointer-events: none;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-item {
      /* å¡ç‰‡åŒ–å¸ƒå±€ï¼Œæ¸å˜èƒŒæ™¯å¹¶ç•¥å¸¦é˜´å½± */
      background: linear-gradient(135deg, #f0f7ff 0%, #eef5ff 100%);
      padding: 14px 0 10px 0;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.17s;
      font-size: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.06);
    }
    .stat-item.highlight { background: linear-gradient(135deg,#6366f1,#3b82f6); color: #fff; }
    .stat-label { font-size: 13px; color: #64748b; }
    .stat-item.highlight .stat-label, .stat-item.highlight .stat-value { color: #fff; }
    .stat-value { font-size: 20px; font-weight: 600; color: #1a202c; }
    .study-streak { display: flex; justify-content: space-between; background: #f8fafc; padding: 13px 16px; border-radius: 12px; }
    .streak-info, .today-count { display: flex; flex-direction: column; align-items: center; }
    .streak-label, .today-label { font-size: 13px; color: #64748b; }
    .streak-value, .today-value { font-size: 16px; font-weight: 600; color: #6366f1; }

    /* è¿ç»­å­¦ä¹ é“¾æ¡ï¼šå°åœ†ç‚¹ï¼Œæ´»è·ƒæ—¶ä¸ºè“è‰²ï¼Œéæ´»è·ƒä¸ºæ·¡è‰² */
    .chain-icon {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #c7d2fe;
      display: inline-block;
    }
    .chain-icon.active {
      background: #6366f1;
    }
    /* æœç´¢è¾“å…¥ä¸ä¾§è¾¹æ åˆ†ç±»æ ·å¼ */
    .search-input { width: 100%; padding: 11px 14px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 15px; background: #f8fafc; margin-bottom: 8px; }
    .search-input:focus { border-color: #6366f1; box-shadow: 0 0 0 2px #c7d2fe; }
    .search-box { position: relative; }
    .search-icon { position: absolute; right: 17px; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
    .card-list { list-style: none; padding: 0; margin: 0; }
    .category-item { margin-bottom: 14px; }
    .category-header { display: flex; align-items: center; padding: 7px 12px; background: #f8fafc; border-radius: 8px; cursor: pointer; transition: all 0.18s; }
    .category-header:hover { background: #f1f5f9; }
    .category-header i { margin-right: 8px; transition: transform 0.2s; }
    .category-header.expanded i { transform: rotate(90deg); }
    .category-content { margin-left: 20px; padding: 8px 0; display: none; }
    .category-content.expanded { display: block; }
    .chapter-item { margin: 4px 0; padding: 4px 12px; border-radius: 7px; cursor: pointer; transition: all 0.18s; }
    .chapter-item:hover { background: #e0e7ff; color: #6366f1; }
    /* æŒ‰é’®æ ·å¼ */
    .btn-primary, .btn-secondary, .btn-save {
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.18s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      outline: none;
    }
    .btn-primary { background: linear-gradient(135deg, #6366f1, #3b82f6); color: #fff; }
    .btn-secondary { background: #f1f5f9; color: #1e293b; }
    .btn-save { background: #dcfce7; color: #15803d; margin-top: 12px; }
    .btn-primary:hover, .btn-secondary:hover, .btn-save:hover { filter: brightness(1.1); }
    .action-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 18px; }

    /* è®¾ç½®ç›®æ ‡æŒ‰é’®æ ·å¼ */
    .set-goal-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #7c3aed, #6366f1);
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .set-goal-btn:hover { filter: brightness(1.1); }
    /* ç›®æ ‡ä¿¡æ¯ */
    .goal-info { font-size: 14px; line-height: 1.4; color: #475569; }
    /* è¿ç»­å­¦ä¹ é“¾æ¡å›¾æ ‡ */
    .chain-icon {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e2e8f0;
    }
    .chain-icon.active { background: #6366f1; }
    .chain-icon.inactive { background: #e2e8f0; }
    /* å›é¡¾æ¨¡å¼æŒ‰é’® */
    .review-btn {
      padding: 6px 14px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #60a5fa, #818cf8);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .review-btn:hover { filter: brightness(1.1); }
    /* ç¬”è®°ç³»ç»ŸUI */
    /* ç¬”è®°åŒºåŸŸä½¿ç”¨æ¸©æš–ç±³ç™½é…è‰²ï¼Œå¹¶åŠ å…¥è½»å¾®é˜´å½±ï¼Œè¥é€ èˆ’é€‚é˜…è¯»æ„Ÿ */
    .note-section { background: #fdf7e8; border-radius: 16px; padding: 18px 14px 12px 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .note-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 9px; }
    .tab-btn { padding: 8px 18px; border: none; border-radius: 20px; background: #e8f5e9; color: #3b7d3b; cursor: pointer; }
    .tab-btn.active { background: #34d399; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .note-controls { display: flex; gap: 10px; margin-bottom: 13px; }
    .note-select { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; background: #f9fafb; }
    .btn-new-category { padding: 8px 16px; background: #60a5fa; color: white; border: none; border-radius: 20px; cursor: pointer; }
    .note-editor { display: flex; flex-direction: column; gap: 10px; }
    .note-title { padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: #ffffff; }
    .note-editor textarea { height: 120px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; resize: vertical; font-size: 14px; line-height: 1.6; background: #ffffff; }
    .note-actions { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 12px; border-top: 1px solid #e2e8f0; }

    /* æ ‡ç­¾äº‘æ ·å¼ */
    .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0;
    }
    .tag-cloud .tag-item {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      background: #e0f2fe;
      color: #0369a1;
      cursor: pointer;
    }
    .tag-cloud .tag-item:hover {
      background: #bae6fd;
    }
    /* åˆ†é¡µæŒ‰é’® */
    .page-btn { cursor: pointer; }
    /* ç®¡ç†è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
    .manage-table {
      width: 100%;
      border-collapse: collapse;
    }
    .manage-table thead th {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
    }
    .manage-table tbody td {
      padding: 6px 8px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }
    .manage-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .manage-table tbody tr:hover {
      background: #f3f4f6;
    }
    /* åŠ¨ç”» */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .flashcard-thumb, .sidebar, .tools-section, .modal-content { animation: fadeIn 0.4s; }

    /* å¯¼å…¥/é€šç”¨æ¨¡æ€é®ç½©æ ·å¼ */
    #import-modal-root > div {
      position: fixed;
      z-index: 1200;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.19);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #import-modal-root .modal-content {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      position: relative;
      animation: fadeIn 0.3s;
    }
  </style>
  <style>
    /* Chat widget styles */
    .chat-toggle-btn {
        position: fixed;
        right: 24px;
        bottom: 24px;
        background-color: #6f58c9;
        color: white;
        padding: 10px 16px;
        border: none;
        border-radius: 24px;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    .chat-widget {
        position: fixed;
        right: 24px;
        bottom: 80px;
        width: 420px;
        height: 520px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        flex-direction: column;
        z-index: 1000;
        overflow: hidden;
    }
    .chat-widget-header {
        background: #6f58c9;
        color: white;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: move;
        user-select: none;
    }
    .chat-widget-header button {
        background: transparent;
        color: white;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }
    .chat-task-tabs {
        display: flex;
        border-bottom: 1px solid #eee;
    }
    .chat-tab {
        flex: 1;
        text-align: center;
        padding: 8px 0;
        cursor: pointer;
        font-size: 14px;
        color: #555;
    }
    .chat-tab.active {
        background: #f5f5fc;
        color: #6f58c9;
        font-weight: 600;
        border-bottom: 2px solid #6f58c9;
    }
    .chat-widget-body {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
        background: #fafafa;
        display: flex;
        flex-direction: column;
    }
    .chat-message {
        margin-bottom: 10px;
        max-width: 90%;
        word-wrap: break-word;
        position: relative;
        padding: 8px 10px;
    }
    .chat-message.user {
        align-self: flex-end;
        background: #e5e5f7;
        color: #333;
        border-radius: 10px 10px 0 10px;
    }
    .chat-message.assistant {
        align-self: flex-start;
        background: #f1f1f1;
        color: #333;
        border-radius: 10px 10px 10px 0;
    }
    .chat-copy-btn {
        position: absolute;
        right: 6px;
        bottom: 6px;
        font-size: 12px;
        color: #6f58c9;
        cursor: pointer;
    }
    .chat-widget-footer {
        display: flex;
        border-top: 1px solid #eee;
        padding: 8px;
    }
    #chat-input {
        flex: 1;
        resize: none;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 6px;
        font-size: 14px;
        min-height: 40px;
        max-height: 100px;
        overflow-y: auto;
    }
    .chat-widget-footer button {
        margin-left: 8px;
        background: #6f58c9;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
    }

    /* ä¼šè¯æ§åˆ¶åŒºåŸŸ */
    .chat-session-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    background: #f8f8fb;
    border-bottom: 1px solid #eee;
    /* Allow controls to wrap onto the next line when there is not enough space */
    flex-wrap: wrap;
    }
    .chat-session-controls select {
        flex: 1;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background: #fff;
    }
    .chat-session-controls button {
        padding: 4px 8px;
        background: #6f58c9;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
      <h3 style="margin-bottom:14px;">çŸ¥è¯†å¯¼èˆª</h3>
      <div class="search-box">
        <input type="text" class="search-input" placeholder="æœç´¢å¡ç‰‡..." oninput="filterCards(this.value)">
        <i class="search-icon">ğŸ”</i>
      </div>
      <div class="card-list" id="card-list"></div>
      <!-- æ ‡ç­¾è¿‡æ»¤ï¼šå¯æŠ˜å çš„æ ‡ç­¾åˆ—è¡¨ -->
      <div class="tag-filter-header" onclick="toggleTagList()">
        <span>æ ‡ç­¾è¿‡æ»¤</span><span id="tag-arrow" style="margin-left:4px;">â–¼</span>
      </div>
      <div id="tag-list" class="collapsed"></div>
      <div class="action-buttons">
        <button id="btn-import" class="btn-primary"><i>ğŸ“¥</i>å¯¼å…¥é¢˜åº“</button>
        <button id="btn-new" class="btn-secondary"><i>âœ¨</i>æ–°å»ºå¡ç‰‡</button>
        <button id="btn-manage" class="btn-primary"><i>ğŸ—‚</i>ç®¡ç†é—ªå¡</button>
        <button id="btn-review" class="btn-primary"><i>ğŸ”</i>å¤ä¹ æ¨¡å¼</button>
      </div>
    </div>
    <!-- ä¸»å¡ç‰‡åŒºåŸŸ -->
    <div class="flashcard-grid" id="flashcard-grid"></div>
    <!-- å·¥å…·æ  -->
    <div class="tools-section">
      <div class="tool-card countdown">
        <span class="countdown-label">è·ç¦»è€ƒç ”è¿˜æœ‰</span>
        <span class="countdown-value" id="countdown">è®¡ç®—ä¸­...</span>
      </div>
      <div class="study-stats">
        <div class="stats-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <h4 style="margin:0;">å­¦ä¹ è¿›åº¦</h4>
            <!-- è®¾ç½®ç›®æ ‡æŒ‰é’® -->
            <button class="set-goal-btn" onclick="setStudyGoal()">è®¾å®šç›®æ ‡</button>
          </div>
          <div class="progress-ring">
            <svg width="60" height="60" viewBox="0 0 60 60">
              <!-- å®šä¹‰æ¸å˜ï¼Œè“ç´«è¿‡æ¸¡ç”¨äºè¿›åº¦æ¡ -->
              <defs>
                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#6366f1"></stop>
                  <stop offset="100%" stop-color="#8b5cf6"></stop>
                </linearGradient>
              </defs>
              <circle class="progress-ring-circle-bg" cx="30" cy="30" r="24" />
              <circle class="progress-ring-circle" cx="30" cy="30" r="24" />
            </svg>
            <span class="progress-text">0%</span>
          </div>
        </div>
        <!-- ç›®æ ‡å’Œè®¡åˆ’ä¿¡æ¯ -->
        <div id="goal-info" class="goal-info" style="margin-bottom:12px; font-size:14px; color:#64748b;"></div>
        <div class="stats-grid">
          <div class="stat-item"><span class="stat-label">å·²æŒæ¡</span><span class="stat-value" id="stat-mastered">0</span></div>
          <div class="stat-item"><span class="stat-label">å¤ä¹ ä¸­</span><span class="stat-value" id="stat-reviewing">0</span></div>
          <div class="stat-item"><span class="stat-label">æœªå­¦ä¹ </span><span class="stat-value" id="stat-new">0</span></div>
          <div class="stat-item highlight"><span class="stat-label">é«˜é¢‘è€ƒç‚¹</span><span class="stat-value" id="stat-high">0</span></div>
        </div>
        <div class="study-streak">
          <div class="streak-info" style="display:flex; flex-direction:column; align-items:flex-start;">
            <span class="streak-label">è¿ç»­å­¦ä¹ </span>
            <span class="streak-value" id="stat-streak">0å¤©</span>
          </div>
          <!-- è¿ç»­å­¦ä¹ é“¾æ¡ -->
          <div id="streak-chain" class="streak-chain" style="display:flex; align-items:center; gap:4px; flex:1; justify-content:center;"></div>
          <div class="today-count" style="display:flex; flex-direction:column; align-items:flex-end;">
            <span class="today-label">ä»Šæ—¥å·²å­¦</span>
            <span class="today-value" id="stat-today">0å¼ </span>
          </div>
        </div>
      <!-- æ–°å¢ï¼šå½“æ—¥å­¦ä¹ ç»Ÿè®¡ï¼ŒåŒ…å«ä»Šæ—¥æ–°å­¦å’Œä»Šæ—¥ä¸ç†Ÿçš„å¡ç‰‡æ•°é‡ -->
      <div class="stats-grid">
        <div class="stat-item"><span class="stat-label">ä»Šæ—¥æ–°å­¦</span><span class="stat-value" id="stat-today-new">0</span></div>
        <div class="stat-item"><span class="stat-label">ä»Šæ—¥ä¸ç†Ÿ</span><span class="stat-value" id="stat-today-difficult">0</span></div>
      </div>
      <!-- å›é¡¾æ¨¡å¼æŒ‰é’® -->
      <div class="progress-controls" style="margin-top:12px; text-align:right;">
        <button class="review-btn" onclick="openReviewModal()">å›é¡¾æ¨¡å¼</button>
      </div>
      </div>
      <div class="tool-card note-section">
        <h4>å­¦ä¹ ç¬”è®°</h4>
        <div class="note-tabs">
          <button class="tab-btn active" data-tab="quick" onclick="switchNoteTab('quick')">å¿«é€Ÿç¬”è®°</button>
          <button class="tab-btn" data-tab="organized" onclick="switchNoteTab('organized')">ç³»ç»Ÿç¬”è®°</button>
        </div>
        <div class="tab-content active" id="quick-note">
          <textarea placeholder="è®°å½•ä¸´æ—¶æƒ³æ³•å’Œç¬”è®°..." id="quick-textarea"></textarea>
        </div>
        <div class="tab-content" id="organized-note">
          <div class="note-controls">
            <select id="note-category" class="note-select"></select>
            <button class="btn-new-category" onclick="addNoteCategory()">æ–°å»ºåˆ†ç±»</button>
          </div>
          <!-- æ¨¡æ¿é€‰æ‹© -->
          <div id="template-select-container" style="margin-bottom:8px;">
            <select id="note-template-select" class="note-select" onchange="applyNoteTemplate()">
              <option value="">é€‰æ‹©æ¨¡æ¿</option>
              <option value="summary">è€ƒç‚¹æ€»ç»“æ¨¡æ¿</option>
              <option value="case">æ¡ˆä¾‹åˆ†ææ¨¡æ¿</option>
            </select>
          </div>
          <div class="note-editor">
            <input type="text" class="note-title" placeholder="ç¬”è®°æ ‡é¢˜...">
            <textarea id="organized-textarea" placeholder="ç³»ç»ŸåŒ–çš„å­¦ä¹ ç¬”è®°..."></textarea>
            <!-- æ ‡ç­¾è¾“å…¥ -->
            <input type="text" id="note-tags" placeholder="æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰" style="padding:8px; border:1px solid #e2e8f0; border-radius:8px; font-size:14px; background:#ffffff;">
            <!-- é™„ä»¶ä¸Šä¼  -->
            <input type="file" id="note-attachment" accept="image/*" multiple style="padding:6px;">
            <div id="note-attachments-preview" style="display:flex; flex-wrap:wrap; gap:4px; margin-top:6px;"></div>
            <!-- æ ‡ç­¾äº‘æ˜¾ç¤º -->
            <div id="tag-cloud" class="tag-cloud"></div>
          </div>
        </div>
        <div class="note-actions">
          <button class="btn-save" onclick="saveNote()">ä¿å­˜ç¬”è®°</button>
          <button class="btn-secondary" onclick="viewNoteHistory()">æŸ¥çœ‹å†å²</button>
        </div>
      </div>
    </div>
  </div>
  <!-- å¡ç‰‡è¯¦æƒ…æ¨¡æ€ -->
  <div id="card-modal" onclick="closeCardModal(event)"></div>
  <!-- å¯¼å…¥å¼¹çª—å®¹å™¨ -->
  <div id="import-modal-root"></div>
  <script>
  // ============ æ•°æ®åˆå§‹åŒ–ä¸æœ¬åœ°å­˜å‚¨ ==============
  let cards = JSON.parse(localStorage.getItem('flashcards') || '[]');
  if (!cards.length) {
    // é»˜è®¤åˆå§‹å¡ç‰‡
    cards = [{
      front: "å…¬å…±ç®¡ç†çš„åŸºæœ¬ç‰¹å¾",
      back: "1ã€å…¬å…±æ€§ï¼šæœåŠ¡å¯¹è±¡å’Œç›®æ ‡çš„å…¬å…±æ€§\n2ã€æƒåŠ›æ€§ï¼šè¡Œæ”¿æƒåŠ›å’Œæ³•å¾‹ä¿éšœ\n3ã€æœåŠ¡æ€§ï¼šä»¥æœåŠ¡å…¬ä¼—ä¸ºæ ¹æœ¬å®—æ—¨\n4ã€ä¸“ä¸šæ€§ï¼šéœ€è¦ä¸“ä¸šçŸ¥è¯†å’ŒæŠ€èƒ½",
      category: "å…¬å…±ç®¡ç†",
      chapter: "ç¬¬ä¸€ç«  å…¬å…±ç®¡ç†æ¦‚è®º",
      level: "é‡ç‚¹",
      examFrequency: "é«˜é¢‘",
      cardType: "ç‰¹å¾åˆ†æ",
      clue: "æ€è€ƒï¼šä»€ä¹ˆä½¿å…¬å…±ç®¡ç†åŒºåˆ«äºä¸€èˆ¬ç®¡ç†ï¼Ÿ",
      context: "å…¬å…±ç®¡ç†æ˜¯ä¸€é—¨ä¸“é—¨ç ”ç©¶æ”¿åºœç®¡ç†æ´»åŠ¨çš„å­¦ç§‘ï¼Œå…¶ç‰¹å¾åæ˜ äº†å…¶æœ¬è´¨å±æ€§",
      lastReview: null,
      nextReview: null,
      reviewCount: 0,
      difficulty: 0,
      mastery: 0,
      wrongCount: 0,
      tags: ["ç®¡ç†", "ç‰¹å¾"],
      links: []
    }];
  }
  // å…¼å®¹æ—§æ•°æ®ç»“æ„ï¼Œç¡®ä¿æ¯å¼ å¡ç‰‡éƒ½æœ‰ tags å’Œ links å­—æ®µ
  cards.forEach(c => {
    if (!c.tags) c.tags = [];
    if (!c.links) c.links = [];
  });

  // å½“å‰é€‰æ‹©çš„æ ‡ç­¾ï¼Œç”¨äºé«˜äº®å’Œæ¸…é™¤è¿‡æ»¤
  let selectedTag = null;

  // ============ å­¦ä¹ è¿›åº¦/ç»Ÿè®¡ ==============
  function statSummary() {
    const total = cards.length;
    let mastered = 0, reviewing = 0, unlearned = 0, high = 0;
    cards.forEach(card => {
      if (card.mastery >= 4) mastered++;
      else if (card.mastery >= 1) reviewing++;
      else unlearned++;
      if (card.examFrequency === 'é«˜é¢‘') high++;
    });
    return { total, mastered, reviewing, unlearned, high };
  }
  function updateStats() {
    const s = statSummary();
    document.getElementById('stat-mastered').textContent = s.mastered;
    document.getElementById('stat-reviewing').textContent = s.reviewing;
    document.getElementById('stat-new').textContent = s.unlearned;
    document.getElementById('stat-high').textContent = s.high;
    // è¿›åº¦ç¯
    const percent = s.total ? Math.round((s.mastered + s.reviewing) / s.total * 100) : 0;
    const circle = document.querySelector('.progress-ring-circle');
    const radius = 24, circumference = 2 * Math.PI * radius;
    circle.setAttribute('stroke-dasharray', circumference);
    circle.setAttribute('stroke-dashoffset', circumference * (1 - percent / 100));
    document.querySelector('.progress-text').textContent = percent + '%';
    document.getElementById('stat-today').textContent = getTodayStudyCount() + 'å¼ ';
    document.getElementById('stat-streak').textContent = getStudyStreak() + 'å¤©';
    // æ¸²æŸ“è¿ç»­å­¦ä¹ é“¾æ¡å’Œç›®æ ‡ä¿¡æ¯
    renderStreakChain();
    updateGoalInfo();
    // æ£€æŸ¥æˆå°±
    checkAchievements();
    // ç»Ÿè®¡ä»Šæ—¥æ–°å­¦å’Œä»Šæ—¥ä¸ç†Ÿçš„å¡ç‰‡æ•°é‡
    const todayDateStr = new Date().toDateString();
    let todayNew = 0, todayDifficult = 0;
    cards.forEach(card => {
      if (card.lastReview && new Date(card.lastReview).toDateString() === todayDateStr) {
        // æ–°å­¦ï¼šä»Šæ—¥ç¬¬ä¸€æ¬¡å­¦ä¹ ï¼ˆreviewCount å°äºç­‰äº 1ï¼‰
        if ((card.reviewCount || 0) <= 1) todayNew++;
        // ä¸ç†Ÿï¼šä»Šæ—¥å¤ä¹ ä½†å‡ºç°é”™è¯¯æˆ–æŒæ¡åº¦åä½
        if ((card.wrongCount || 0) > 0 || card.mastery < 3) todayDifficult++;
      }
    });
    const todayNewEl = document.getElementById('stat-today-new');
    const todayDiffEl = document.getElementById('stat-today-difficult');
    if (todayNewEl) todayNewEl.textContent = todayNew;
    if (todayDiffEl) todayDiffEl.textContent = todayDifficult;
  }

  // ============ ä¾§è¾¹æ  åˆ†ç±»-ç« èŠ‚ äºŒçº§å±•å¼€ ==============
  let activeReviewFilter = () => true;
  let currentCardList = cards;
  function updateCardList(listCards = cards.filter(activeReviewFilter)) {
    // å°† AI ç”Ÿæˆçš„å¡ç‰‡åˆ†ç¦»ï¼Œä»¥ä¾¿å•ç‹¬å±•ç¤º
    const aiCards = listCards.filter(c => c.isAI);
    const normalCards = listCards.filter(c => !c.isAI);
    // æŒ‰ç§‘ç›®å’Œç« èŠ‚å¯¹æ™®é€šå¡ç‰‡åˆ†ç»„
    const grouped = normalCards.reduce((acc, card) => {
      if (!acc[card.category]) acc[card.category] = {};
      if (!acc[card.category][card.chapter]) acc[card.category][card.chapter] = [];
      acc[card.category][card.chapter].push(card);
      return acc;
    }, {});
    const list = document.getElementById('card-list');
    list.innerHTML = '';
    // å…¨éƒ¨å¡ç‰‡é¡¹
    const allItem = document.createElement('div');
    allItem.className = 'chapter-item';
    allItem.textContent = 'å…¨éƒ¨å¡ç‰‡';
    allItem.onclick = () => { currentCardList = listCards; renderGrid(currentCardList); };
    list.appendChild(allItem);
    // æ™®é€šå¡ç‰‡çš„åˆ†ç±»ä¸ç« èŠ‚å±•ç¤º
    for (let cat in grouped) {
      const catDiv = document.createElement('div');
      catDiv.className = 'category-item';
      const catHeader = document.createElement('div');
      catHeader.className = 'category-header';
      catHeader.innerHTML = `<i>â–¶</i>${cat}`;
      const catContent = document.createElement('div');
      catContent.className = 'category-content';
      catHeader.onclick = () => {
        catHeader.classList.toggle('expanded');
        catContent.classList.toggle('expanded');
        currentCardList = Object.values(grouped[cat]).flat();
        renderGrid(currentCardList);
      };
      for (let chap in grouped[cat]) {
        const chapDiv = document.createElement('div');
        chapDiv.className = 'chapter-item';
        chapDiv.textContent = chap;
        chapDiv.onclick = () => {
          currentCardList = grouped[cat][chap];
          renderGrid(currentCardList);
        };
        catContent.appendChild(chapDiv);
      }
      catDiv.appendChild(catHeader);
      catDiv.appendChild(catContent);
      list.appendChild(catDiv);
    }
    // AI ç”Ÿæˆå¡ç‰‡å•ç‹¬æ˜¾ç¤º
    if (aiCards.length) {
      const aiDiv = document.createElement('div');
      aiDiv.className = 'category-item';
      const aiHeader = document.createElement('div');
      aiHeader.className = 'category-header';
      aiHeader.innerHTML = `<i>â–¶</i>AIç”Ÿæˆ`;
      const aiContent = document.createElement('div');
      aiContent.className = 'category-content';
      aiHeader.onclick = () => {
        aiHeader.classList.toggle('expanded');
        aiContent.classList.toggle('expanded');
        currentCardList = aiCards;
        renderGrid(currentCardList);
      };
      aiCards.forEach(c => {
        const item = document.createElement('div');
        item.className = 'chapter-item';
        item.textContent = c.front;
        item.onclick = () => {
          currentCardList = [c];
          renderGrid(currentCardList);
        };
        aiContent.appendChild(item);
      });
      aiDiv.appendChild(aiHeader);
      aiDiv.appendChild(aiContent);
      list.appendChild(aiDiv);
    }
    updateTagList();
  }

  // ============ æ ‡ç­¾è¿‡æ»¤ ==============
  function updateTagList() {
    const tagListDiv = document.getElementById('tag-list');
    const tagSet = new Set();
    cards.forEach(c => {
      (c.tags || []).forEach(t => tagSet.add(t));
    });
    const tags = Array.from(tagSet).sort();
    let html = '';
    // å¦‚æœæœ‰é€‰ä¸­çš„æ ‡ç­¾ï¼Œæ·»åŠ æ¸…é™¤æŒ‰é’®
    if (selectedTag) {
      html += `<span class="tag-clear" onclick="clearTagFilter()">å…¨éƒ¨</span>`;
    }
    html += tags.map(t => {
      const activeClass = selectedTag === t ? ' active' : '';
      return `<span class="tag-item${activeClass}" onclick="filterByTag('${t}')">${t}</span>`;
    }).join('');
    tagListDiv.innerHTML = html;
  }

  // åˆ‡æ¢æ ‡ç­¾åˆ—è¡¨æŠ˜å /å±•å¼€
  function toggleTagList() {
    const list = document.getElementById('tag-list');
    const arrow = document.getElementById('tag-arrow');
    if (list.classList.contains('collapsed')) {
      list.classList.remove('collapsed');
      list.classList.add('expanded');
      if (arrow) arrow.textContent = 'â–²';
    } else {
      list.classList.remove('expanded');
      list.classList.add('collapsed');
      if (arrow) arrow.textContent = 'â–¼';
    }
    // æ›´æ–°å¤´éƒ¨ç®­å¤´æ–‡æœ¬å¦‚æœæ˜¾ç¤ºå½“å‰æ ‡ç­¾ä¹Ÿéœ€è¦åæ˜ ç®­å¤´å˜åŒ–
    const header = document.querySelector('.tag-filter-header');
    if (header && !selectedTag) {
      // Only update arrow when not filtering by tag
      header.innerHTML = `<span>æ ‡ç­¾è¿‡æ»¤</span><span id="tag-arrow" style="margin-left:4px;">${list.classList.contains('collapsed') ? 'â–¼' : 'â–²'}</span>`;
    }
  }
  function filterByTag(tag) {
    // é€‰ä¸­æŒ‡å®šæ ‡ç­¾å¹¶åº”ç”¨ç­›é€‰
    selectedTag = tag;
    activeReviewFilter = card => (card.tags || []).includes(tag);
    currentCardList = cards.filter(activeReviewFilter);
    updateCardList(currentCardList);
    renderGrid(currentCardList);
    updateTagList();
    // å±•å¼€æ ‡ç­¾åˆ—è¡¨ï¼Œæç¤ºç”¨æˆ·å¯æ¸…é™¤ç­›é€‰
    const list = document.getElementById('tag-list');
    if (list) {
      list.classList.remove('collapsed');
      list.classList.add('expanded');
    }
    const arrow = document.getElementById('tag-arrow');
    if (arrow) arrow.textContent = 'â–²';
    // å¦‚æœåœ¨æ¨¡æ€ä¸­ç‚¹å‡»æ ‡ç­¾ï¼Œå…³é—­æ¨¡æ€
    closeCardModal();
    // åœ¨æ ‡ç­¾å¤´éƒ¨æ˜¾ç¤ºå½“å‰ç­›é€‰å¹¶æä¾›æ¸…é™¤æŒ‰é’®
    const header = document.querySelector('.tag-filter-header');
    if (header) {
      // åœ¨æ ‡é¢˜ä¸­æ˜¾ç¤ºå½“å‰æ ‡ç­¾ï¼Œå¹¶æ·»åŠ å¯ç‚¹å‡»çš„æ¸…é™¤æŒ‰é’®ã€‚ä½¿ç”¨ event ä¼ å…¥æ¸…é™¤å‡½æ•°ï¼Œé¿å…å†’æ³¡ã€‚
      header.innerHTML = `<span>æ ‡ç­¾è¿‡æ»¤ï¼š${tag}</span><span style="margin-left:4px;cursor:pointer;" title="æ¸…é™¤ç­›é€‰" onclick="clearTagFilter(event)">âœ•</span>`;
    }
  }

  // æ¸…é™¤æ ‡ç­¾ç­›é€‰
  /**
   * æ¸…é™¤å½“å‰çš„æ ‡ç­¾ç­›é€‰ã€‚å¦‚æœç”±é¼ æ ‡äº‹ä»¶è§¦å‘ï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è¯¯è§¦æ ‡ç­¾å¤´çš„å±•å¼€/æŠ˜å ã€‚
   * æ¢å¤é»˜è®¤çš„è¿‡æ»¤å™¨ã€å¡ç‰‡åˆ—è¡¨å’Œæ ‡ç­¾æ ‡é¢˜ã€‚
   * @param {Event} e å¯é€‰çš„äº‹ä»¶å¯¹è±¡ï¼Œç”¨äºé˜»æ­¢å†’æ³¡ã€‚
   */
  function clearTagFilter(e) {
    if (e && typeof e.stopPropagation === 'function') {
      e.stopPropagation();
    }
    selectedTag = null;
    activeReviewFilter = () => true;
    currentCardList = cards;
    updateCardList(cards);
    renderGrid(cards);
    updateTagList();
    // æ¢å¤æ ‡ç­¾è¿‡æ»¤å¤´éƒ¨æ–‡æœ¬å’Œç®­å¤´çŠ¶æ€
    const header = document.querySelector('.tag-filter-header');
    if (header) {
      const listCollapsed = document.getElementById('tag-list').classList.contains('collapsed');
      header.innerHTML = `<span>æ ‡ç­¾è¿‡æ»¤</span><span id="tag-arrow" style="margin-left:4px;">${listCollapsed ? 'â–¼' : 'â–²'}</span>`;
    }
  }

  // ============ ä¸»å¡ç‰‡æ¸²æŸ“ ==============
  function truncateText(t, len = 15) {
    return t && t.length > len ? t.slice(0, len) + 'â€¦' : (t || '');
  }
  function renderGrid(showCards = currentCardList) {
    const grid = document.getElementById('flashcard-grid');
    grid.innerHTML = '';
    showCards.forEach(card => {
      const div = document.createElement('div');
      div.className = 'flashcard-thumb';
      // æ„å»ºå¡ç‰‡ç¼©ç•¥å›¾ï¼ŒåŒ…å«æ ‡é¢˜ã€çº¿ç´¢å’Œé«˜é¢‘æ ‡è®°
      const starActive = card.examFrequency === 'é«˜é¢‘';
      div.innerHTML = `<div class="thumb-title">${truncateText(card.front, 40)}</div>` +
                      `<div class="thumb-clue">${truncateText(card.clue || card.context || '', 40)}</div>` +
                      `<div class="thumb-star ${starActive ? 'active' : ''}" title="æ ‡è®°ä¸ºé«˜é¢‘è€ƒç‚¹">â˜…</div>`;
      div.onclick = () => openCard(card.front);
      // ç»‘å®šé«˜é¢‘æ ‡è®°ç‚¹å‡»äº‹ä»¶
      const star = div.querySelector('.thumb-star');
      star.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleHighFrequency(card.front);
        // åˆ‡æ¢çŠ¶æ€
        this.classList.toggle('active');
      });
      grid.appendChild(div);
    });
  }
  // æ ¼å¼åŒ–å¡ç‰‡å†…å®¹ï¼šæ”¯æŒç¼–å·ã€å¤‡æ³¨ç­‰
  function formatCardContent(content) {
    let mainContent = content;
    let notes = '';
    // æå–æ‹¬å·ä¸­çš„æ³¨é‡Šåˆ°å•ç‹¬çš„ notes
    const noteMatches = content.match(/ï¼ˆ[^ï¼‰]+ï¼‰/g);
    if (noteMatches) {
      notes = noteMatches.join(' ');
      mainContent = content.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, '');
    }
    // å°† Markdown ç²—ä½“å’Œæ–œä½“è½¬æ¢ä¸º HTML
    mainContent = mainContent
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/\*([^*]+)\*/g, '<em>$1</em>');
    // å¤„ç†ç¼–å·åˆ—è¡¨
    if (/1[\.ã€ï¼]/.test(mainContent)) {
      const points = mainContent.split(/(?=\d+[\.ã€ï¼])/)
        .map(point => point.trim()).filter(point => point.length > 0);
      let html = '<div class="numbered-list">';
      points.forEach(point => {
        const match = point.match(/^(\d+[\.ã€ï¼])\s*(.+)$/);
        if (match) {
          html += `<div class="list-item"><span class="number">${match[1]}</span><span class="content">${match[2]}</span></div>`;
        } else {
          html += `<div class="list-item"><span class="content">${point}</span></div>`;
        }
      });
      html += '</div>';
      if (notes) html += `<div class="note">${notes}</div>`;
      return html;
    }
    // éç¼–å·å†…å®¹æŒ‰æ®µè½åˆ†å‰²ï¼ŒåŒæ¢è¡Œåˆ†æ®µï¼Œå•æ¢è¡Œä¿ç•™ä¸ºæ¢è¡Œ
    const paragraphs = mainContent.split(/\n\s*\n/).map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
    return paragraphs + (notes ? `<div class="note">${notes}</div>` : '');
  }
  function openCard(front) {
    const card = cards.find(c => c.front === front);
    if (!card) return;
    const modal = document.getElementById('card-modal');
    // æ¸²æŸ“æ ‡ç­¾å’Œé“¾æ¥ã€‚ä½¿ç”¨åŒå¼•å·åŒ…è£¹ onclick ä»¥é¿å…è½¬ä¹‰é—®é¢˜ã€‚
    const tagsHtml = card.tags && card.tags.length ? `<div style="margin-top:8px;">æ ‡ç­¾ï¼š${card.tags.map(t => `<span class="tag-item" onclick="filterByTag('${t}')">${t}</span>`).join(' ')}</div>` : '';
    const linksHtml = card.links && card.links.length ? `<div style="margin-top:8px;">ç›¸å…³å¡ç‰‡ï¼š${card.links.map(l => `<a href="#" onclick="openCard('${l}');return false;">${l}</a>`).join('ï¼Œ')}</div>` : '';
    // æ„å»ºå¡ç‰‡è¯¦æƒ…HTMLï¼Œå»æ‰å†…è” onclickï¼Œä½¿ç”¨ data-mastery å­˜å‚¨æŒæ¡åº¦
    modal.innerHTML = `
      <div class="card-popup" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closeCardModal(event)">Ã—</button>
        <div class="popup-title">${card.front}</div>
        <div class="popup-content">
          ${card.clue ? `<div class="popup-clue">${card.clue}</div>` : ''}
          <div>${formatCardContent(card.back)}</div>
          ${tagsHtml}
          ${linksHtml}
        </div>
        <div class="mastery-buttons">
          <button class="btn-primary" data-mastery="1" style="background:#fde68a;color:#b45309;"><span>ğŸ˜…</span>å›°éš¾</button>
          <button class="btn-primary" data-mastery="3" style="background:#bae6fd;color:#0369a1;"><span>ğŸ¤”</span>æ¨¡ç³Š</button>
          <button class="btn-primary" data-mastery="5" style="background:#bbf7d0;color:#166534;"><span>âœ¨</span>æ¸…æ™°</button>
        </div>
      </div>`;
    modal.onclick = closeCardModal;
    modal.classList.add('active');
    modal.style.opacity = '1';
    // ç»‘å®šæŒæ¡åº¦æŒ‰é’®äº‹ä»¶
    const btns = modal.querySelectorAll('.mastery-buttons button');
    btns.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const mastery = parseInt(this.getAttribute('data-mastery'), 10);
        updateMastery(card.front, mastery, e);
      });
    });
  }
  function closeCardModal(e) {
    if (e) e.stopPropagation();
    const modal = document.getElementById('card-modal');
    modal.classList.remove('active');
    modal.innerHTML = '';
  }

  // ============ æœç´¢è¿‡æ»¤ ==============
  function filterCards(query) {
    const q = query.trim().toLowerCase();
    const base = cards.filter(activeReviewFilter);
    if (!q) {
      renderGrid(base);
      currentCardList = base;
      return;
    }
    const filtered = base.filter(card =>
      card.front.toLowerCase().includes(q) ||
      card.back.toLowerCase().includes(q) ||
      card.category.toLowerCase().includes(q) ||
      card.chapter.toLowerCase().includes(q) ||
      (card.level || '').toLowerCase().includes(q) ||
      (card.tags || []).some(t => t.toLowerCase().includes(q))
    );
    currentCardList = filtered;
    renderGrid(filtered);
  }

  // ============ é—´éš”é‡å¤ç®—æ³• ==============
  function spacedRepetition(card, mastery) {
    const now = new Date();
    const interval = Math.pow(2, card.reviewCount || 0) * (mastery / 5);
    card.lastReview = now.toISOString();
    card.reviewCount = (card.reviewCount || 0) + 1;
    card.mastery = mastery;
    const next = new Date(now);
    next.setDate(now.getDate() + Math.max(1, Math.round(interval)));
    card.nextReview = next.toISOString();
    card.difficulty = Math.max(0, Math.min(5, (card.difficulty || 0) + (mastery <= 2 ? 1 : mastery >= 4 ? -1 : 0)));
    return card;
  }
  function updateMastery(front, mastery, event) {
    event.stopPropagation();
    const i = cards.findIndex(c => c.front === front);
    if (i === -1) return;
    cards[i] = spacedRepetition(cards[i], mastery);
    if (mastery <= 2) cards[i].wrongCount = (cards[i].wrongCount || 0) + 1;
    localStorage.setItem('flashcards', JSON.stringify(cards));
    incrementTodayStudyCount();
    updateStats();
    // åˆ·æ–°å¡ç‰‡åˆ—è¡¨
    document.querySelectorAll('.flashcard-thumb').forEach(f => f.classList.remove('flipped'));
    const modal = document.getElementById('card-modal');
    if (modal.classList.contains('active')) {
      modal.style.transition = 'opacity 0.3s ease';
      modal.style.opacity = '0';
      setTimeout(() => {
        closeCardModal();
      }, 300);
    }
    setTimeout(() => {
      const grid = document.getElementById('flashcard-grid');
      grid.style.transition = 'opacity 0.3s ease';
      grid.style.opacity = '0';
      renderGrid(currentCardList);
      setTimeout(() => { grid.style.opacity = '1'; }, 100);
    }, 330);
  }

  // ============ å­¦ä¹ å¤©æ•°/æ‰“å¡ç»Ÿè®¡ ==============
  function getTodayStudyCount() {
    const today = new Date().toISOString().split('T')[0];
    return parseInt(localStorage.getItem(`study_count_${today}`) || '0');
  }
  function incrementTodayStudyCount() {
    const today = new Date().toISOString().split('T')[0];
    const count = getTodayStudyCount();
    localStorage.setItem(`study_count_${today}`, count + 1);
  }
  function getStudyStreak() {
    let streak = 0;
    const today = new Date();
    const curr = new Date(today);
    while (true) {
      const dateStr = curr.toISOString().split('T')[0];
      if (parseInt(localStorage.getItem(`study_count_${dateStr}`) || '0') === 0) break;
      streak++;
      curr.setDate(curr.getDate() - 1);
    }
    return streak;
  }

  // åˆ‡æ¢é«˜é¢‘è€ƒç‚¹æ ‡è®°ï¼šåœ¨å¡ç‰‡ç¼©ç•¥å›¾ç‚¹å‡»æ˜Ÿæ ‡æ—¶è°ƒç”¨
  function toggleHighFrequency(front) {
    const idx = cards.findIndex(c => c.front === front);
    if (idx === -1) return;
    const card = cards[idx];
    // åˆ‡æ¢ examFrequency å±æ€§
    if (card.examFrequency === 'é«˜é¢‘') {
      card.examFrequency = 'ä½é¢‘';
    } else {
      card.examFrequency = 'é«˜é¢‘';
    }
    localStorage.setItem('flashcards', JSON.stringify(cards));
    // æ›´æ–°ç»Ÿè®¡å’Œæ ‡ç­¾åˆ—è¡¨
    updateStats();
    updateTagList();
  }

  // ============ å­¦ä¹ ç›®æ ‡ä¸è®¡åˆ’ ==============
  let studyGoal = null;
  // åŠ è½½ç›®æ ‡
  function loadStudyGoal() {
    const data = localStorage.getItem('studyGoal');
    studyGoal = data ? JSON.parse(data) : null;
    updateGoalInfo();
  }
  // è®¾ç½®ç›®æ ‡ï¼šæç¤ºç”¨æˆ·è¾“å…¥æ€»ç›®æ ‡å¼ æ•°ï¼Œè®¡ç®—æ¯æ—¥/æ¯å‘¨è®¡åˆ’
  function setStudyGoal() {
    const current = studyGoal && studyGoal.target ? studyGoal.target : '';
    const input = prompt('è¯·è¾“å…¥è€ƒç ”å¤ä¹ çš„æ€»ç›®æ ‡å¡ç‰‡æ•°é‡ï¼Œä¾‹å¦‚ 200ï¼š', current);
    if (!input) return;
    const target = parseInt(input, 10);
    if (isNaN(target) || target <= 0) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
      return;
    }
    // è®¡ç®—å‰©ä½™å¤©æ•°
    const examDateStr = localStorage.getItem('examDate') || '';
    const examDate = examDateStr ? new Date(examDateStr) : new Date(new Date().getFullYear(), 11, 23);
    const now = new Date();
    let days = Math.ceil((examDate - now) / 86400000);
    if (days < 1) days = 1;
    studyGoal = { target, setDate: now.toISOString() };
    localStorage.setItem('studyGoal', JSON.stringify(studyGoal));
    updateGoalInfo();
    alert('ç›®æ ‡å·²è®¾ç½®ï¼ç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—æ¯æ—¥å’Œæ¯å‘¨è®¡åˆ’ã€‚');
  }
  // æ›´æ–°ç›®æ ‡ä¿¡æ¯æ˜¾ç¤º
  function updateGoalInfo() {
    const infoEl = document.getElementById('goal-info');
    if (!infoEl) return;
    if (!studyGoal) {
      infoEl.textContent = '';
      return;
    }
    const examDateStr = localStorage.getItem('examDate') || '';
    const examDate = examDateStr ? new Date(examDateStr) : new Date(new Date().getFullYear(), 11, 23);
    const now = new Date();
    let days = Math.ceil((examDate - now) / 86400000);
    if (days < 1) days = 1;
    const daily = Math.ceil(studyGoal.target / days);
    const weekly = daily * 7;
    infoEl.innerHTML = `ç›®æ ‡ï¼šæŒæ¡<strong>${studyGoal.target}</strong>å¼ <br>æ¯æ—¥è®¡åˆ’ï¼š<strong>${daily}</strong>å¼  &nbsp; æ¯å‘¨è®¡åˆ’ï¼š<strong>${weekly}</strong>å¼ `;
  }

  // æ¸²æŸ“è¿ç»­å­¦ä¹ é“¾æ¡ï¼Œæ˜¾ç¤ºå½©è‰²åœ†ç‚¹è¡¨ç¤ºè¿ç»­å­¦ä¹ å¤©æ•°
  function renderStreakChain() {
    const container = document.getElementById('streak-chain');
    if (!container) return;
    const streak = getStudyStreak();
    const count = Math.max(streak, 7);
    container.innerHTML = '';
    for (let i = 1; i <= count; i++) {
      const span = document.createElement('span');
      span.className = 'chain-icon ' + (i <= streak ? 'active' : 'inactive');
      container.appendChild(span);
    }
  }

  // æˆå°±æ£€æµ‹ï¼šè¿ç»­å­¦ä¹ è¾¾åˆ°é‡Œç¨‹ç¢‘æ—¶å¼¹çª—æç¤º
  function checkAchievements() {
    const streak = getStudyStreak();
    if (streak >= 30 && !localStorage.getItem('badge30')) {
      alert('ğŸ‰ æ­å–œä½ è¿ç»­å­¦ä¹ 30å¤©ï¼ä½ è·å¾—äº†30å¤©å­¦ä¹ å¾½ç« ï¼');
      localStorage.setItem('badge30', '1');
    } else if (streak >= 7 && !localStorage.getItem('badge7')) {
      alert('ğŸ‰ å¤ªæ£’äº†ï¼ä½ å·²ç»è¿ç»­å­¦ä¹ 7å¤©ï¼Œç»§ç»­ä¿æŒï¼');
      localStorage.setItem('badge7', '1');
    }
  }

  // æ‰“å¼€å›é¡¾æ¨¡å¼ï¼šåˆ†æå¼±é¡¹å¹¶å±•ç¤º
  function openReviewModal() {
    // æŒ‰ç« èŠ‚ç»Ÿè®¡æŒæ¡ç‡
    const summary = {};
    cards.forEach(card => {
      const key = `${card.category}/${card.chapter}`;
      if (!summary[key]) summary[key] = { total: 0, mastered: 0 };
      summary[key].total++;
      if ((card.mastery || 0) >= 4) summary[key].mastered++;
    });
    const list = Object.entries(summary).map(([key, val]) => {
      const rate = val.total ? val.mastered / val.total : 0;
      return { key, rate };
    }).sort((a, b) => a.rate - b.rate);
    let html = '<h3>å¼±é¡¹åˆ†æ</h3><table style="width:100%; border-collapse:collapse; margin-top:8px; font-size:14px;">';
    html += '<tr style="background:#f8fafc;"><th style="text-align:left;padding:6px;">ç« èŠ‚</th><th style="text-align:left;padding:6px;">æŒæ¡ç‡</th></tr>';
    list.forEach(item => {
      html += `<tr><td style="padding:6px; border-bottom:1px solid #f1f5f9;">${item.key}</td><td style="padding:6px; border-bottom:1px solid #f1f5f9;">${Math.round(item.rate * 100)}%</td></tr>`;
    });
    html += '</table><div style="text-align:right; margin-top:12px;"><button class="btn-secondary" onclick="closeModal()">å…³é—­</button></div>';
    showModal(html);
  }

  // ============ AI é—ªå¡è§£æä¸å¯¼å…¥ ==============
  // ä»åŠ©æ‰‹å›å¤æ–‡æœ¬ä¸­æå– JSON æ•°ç»„å¹¶è§£æä¸ºå¯¹è±¡
  function parseJsonArray(text) {
    try {
      const start = text.indexOf('[');
      const end   = text.lastIndexOf(']');
      if (start !== -1 && end !== -1 && end > start) {
        const jsonStr = text.substring(start, end + 1);
        return JSON.parse(jsonStr);
      }
    } catch (err) {
      console.error('è§£æ AI è¾“å‡ºå¤±è´¥', err);
    }
    return null;
  }

  // å¯¼å…¥ AI ç”Ÿæˆçš„å¡ç‰‡æ•°ç»„
  function importAICards(arr) {
    if (!Array.isArray(arr)) return;
    let imported = 0;
    arr.forEach(item => {
      if (!item || !item.front || !item.back) return;
      // å»é‡ï¼šå¦‚æœå·²æœ‰åŒåé¢˜å¹²åˆ™è·³è¿‡
      const exists = cards.some(c => c.front === item.front);
      if (exists) return;
      const newCard = {
        front: item.front,
        back: item.back,
        category: item.category || 'å…¬å…±ç®¡ç†å­¦',
        chapter: item.chapter || 'AIç”Ÿæˆ',
        tags: item.tags || [],
        links: item.links || [],
        level: 'é‡ç‚¹',
        examFrequency: 'ä½é¢‘',
        cardType: '',
        clue: '',
        context: '',
        lastReview: null,
        nextReview: null,
        reviewCount: 0,
        difficulty: 0,
        mastery: 0,
        wrongCount: 0,
        isAI: true
      };
      cards.push(newCard);
      imported++;
    });
    if (imported > 0) {
      localStorage.setItem('flashcards', JSON.stringify(cards));
      // æ›´æ–°ç•Œé¢ï¼šåªåˆ·æ–° AI åˆ—è¡¨æ˜¾ç¤º
      const filtered = cards.filter(activeReviewFilter);
      updateCardList(filtered);
      renderGrid(filtered);
      updateStats();
      updateTagList();
      alert('å·²æˆåŠŸå¯¼å…¥ ' + imported + ' å¼  AI ç”Ÿæˆçš„é—ªå¡');
    }
  }

  // ============ å€’è®¡æ—¶ ==============
  function updateCountdown() {
    let dt = localStorage.getItem('examDate') || '';
    let date = dt ? new Date(dt) : new Date(new Date().getFullYear(), 11, 23);
    const now = new Date();
    let days = Math.ceil((date - now) / 86400000);
    if (days < 0) days = 0;
    document.getElementById('countdown').textContent = days + 'å¤©';
    document.querySelector('.countdown-label').onclick = function() {
      const input = prompt('è‡ªå®šä¹‰ç›®æ ‡æ—¥æœŸï¼ˆæ ¼å¼: 2024-12-21ï¼‰', dt || '');
      if (input) {
        localStorage.setItem('examDate', input);
        updateCountdown();
      }
    };
  }

  // ============ å¯¼å…¥ä¸å¯¼å‡º ==============
  function showImportModal() {
    const modalRoot = document.getElementById('import-modal-root');
    modalRoot.innerHTML = `
    <div>
      <div class="modal-content" style="max-width:440px;max-height:80vh;overflow-y:auto;">
        <h3>æ‰¹é‡å¯¼å…¥é¢˜åº“</h3>
        <p>ç²˜è´´ç¬¦åˆæ ¼å¼çš„JSONæ•°ç»„ï¼Œæˆ–ä¸Šä¼ .jsonæ–‡ä»¶ï¼š</p>
        <pre class="import-hint" style="background:#f8fafc;border:1px dashed #d1d5db;padding:8px;font-size:13px;margin:8px 0;white-space:pre-wrap;">[
  {"front":"é¢˜å¹²","back":"ç­”æ¡ˆ","category":"ç§‘ç›®","chapter":"ç« èŠ‚","tags":["æ ‡ç­¾1","æ ‡ç­¾2"],"links":["å…³è”å¡ç‰‡"]}
]</pre>
        <textarea id="import-json" style="width:98%;min-height:96px;border-radius:8px;border:1px solid #e0e0e0;padding:7px 10px;font-size:15px;"></textarea>
        <input type="file" id="import-file" accept=".json" style="margin:10px 0;">
        <div style="text-align:right;margin-top:10px;">
          <button class="btn-secondary" onclick="document.getElementById('import-modal-root').innerHTML=''">å–æ¶ˆ</button>
          <button class="btn-primary" onclick="processImport()">å¯¼å…¥</button>
        </div>
      </div>
    </div>`;
    document.getElementById('import-file').onchange = function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        document.getElementById('import-json').value = ev.target.result;
      };
      reader.readAsText(file);
    };
  }
  function processImport() {
    let importData;
    try {
      importData = JSON.parse(document.getElementById('import-json').value);
      if (!Array.isArray(importData)) throw Error('è¯·ç²˜è´´JSONæ•°ç»„æ ¼å¼');
      importData.forEach(card => {
        if (!card.front || !card.back || !card.category || !card.chapter) throw Error('æ¯æ¡éœ€å«front,back,category,chapter');
        card.lastReview = null; card.nextReview = null; card.reviewCount = 0; card.difficulty = 0; card.mastery = 0; card.wrongCount = 0;
        if (!card.tags) card.tags = [];
        if (!card.links) card.links = [];
      });
      // å»é‡
      const fronts = new Set(cards.map(c => c.front));
      const newCards = importData.filter(card => !fronts.has(card.front));
      cards = cards.concat(newCards);
      localStorage.setItem('flashcards', JSON.stringify(cards));
      document.getElementById('import-modal-root').innerHTML = '';
      // å¯¼å…¥åé‡ç½®è¿‡æ»¤å™¨ï¼Œåˆ·æ–°ç›®å½•
      activeReviewFilter = () => true;
      updateCardList(cards);
      renderGrid(cards);
      updateStats();
      updateTagList();
      alert('å¯¼å…¥æˆåŠŸï¼æ–°å¢' + newCards.length + 'æ¡');
    } catch (e) {
      alert('å¯¼å…¥å¤±è´¥:' + e.message);
    }
  }
  function exportCards() {
    const data = JSON.stringify(cards, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'flashcards_backup_' + Date.now() + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // ============ æ–°å»ºå¡ç‰‡ ==============
  function addNewCard() {
    const front = prompt('è¾“å…¥é¢˜å¹²(æ­£é¢)...');
    if (!front) return;
    const back = prompt('è¾“å…¥ç­”æ¡ˆ(èƒŒé¢)...');
    if (!back) return;
    const category = prompt('æ‰€å±ç§‘ç›®/åˆ†ç±»?', 'æœªåˆ†ç±»') || 'æœªåˆ†ç±»';
    const chapter = prompt('æ‰€å±ç« èŠ‚?', 'æœªåˆ†ç« ') || 'æœªåˆ†ç« ';
    const tagStr = prompt('è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”(å¯é€‰)...', '');
    const linkStr = prompt('è¾“å…¥å…³è”å¡ç‰‡é¢˜å¹²ï¼Œç”¨é€—å·åˆ†éš”(å¯é€‰)...', '');
    const tags = tagStr ? tagStr.split(',').map(s => s.trim()).filter(Boolean) : [];
    const links = linkStr ? linkStr.split(',').map(s => s.trim()).filter(Boolean) : [];
    cards.push({
      front, back, category, chapter,
      level: 'åŸºç¡€', examFrequency: 'ä½é¢‘', lastReview: null, nextReview: null, reviewCount: 0,
      difficulty: 0, mastery: 0, wrongCount: 0,
      tags, links
    });
    localStorage.setItem('flashcards', JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
  }

  // ============ ç¬”è®°ç³»ç»Ÿ ==============
  let notes = JSON.parse(localStorage.getItem('flashcardNotes') || '{"quick":{},"organized":{}}');
  function switchNoteTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('.tab-btn[data-tab="' + tab + '"]').classList.add('active');
    document.getElementById(tab + '-note').classList.add('active');
  }
  function saveNote() {
    const tab = document.querySelector('.tab-btn.active').dataset.tab;
    const today = new Date().toISOString().split('T')[0];
    if (tab === 'quick') {
      notes.quick[today] = document.getElementById('quick-textarea').value;
    } else {
      const cat = document.getElementById('note-category').value;
      const title = document.querySelector('.note-title').value;
      const content = document.getElementById('organized-textarea').value;
      if (!cat) return alert('è¯·é€‰æ‹©åˆ†ç±»');
      // è·å–æ ‡ç­¾æ•°ç»„
      const tagsStr = document.getElementById('note-tags').value || '';
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : [];
      // é™„ä»¶
      const attachments = currentNoteAttachments && currentNoteAttachments.length ? currentNoteAttachments.slice() : [];
      if (!notes.organized[cat]) notes.organized[cat] = [];
      notes.organized[cat].push({ title, content, date: today, tags, attachments });
      // æ¸…ç©ºé™„ä»¶ç¼“å­˜
      currentNoteAttachments = [];
      // æ¸…ç©ºé™„ä»¶é¢„è§ˆ
      const preview = document.getElementById('note-attachments-preview');
      if (preview) preview.innerHTML = '';
      // é‡ç½®æ–‡ä»¶è¾“å…¥
      const attachInput = document.getElementById('note-attachment');
      if (attachInput) attachInput.value = '';
      // æ¸…ç©ºæ ‡ç­¾è¾“å…¥
      document.getElementById('note-tags').value = '';
    }
    localStorage.setItem('flashcardNotes', JSON.stringify(notes));
    alert('ç¬”è®°å·²ä¿å­˜');
    // æ›´æ–°æ ‡ç­¾äº‘æ˜¾ç¤º
    renderTagCloud();
  }
  function addNoteCategory() {
    // æ”¯æŒå¤šå±‚çº§åˆ†ç±»ï¼Œç”¨æ–œæ åˆ†éš”ï¼Œå¦‚ â€œå…¬å…±ç®¡ç†ç†è®º/æ”¿ç­–æ‰§è¡Œæ¡ˆä¾‹â€
    let catPath = prompt('è¾“å…¥æ–°åˆ†ç±»åç§°ï¼ˆå¯ä½¿ç”¨â€œ/â€åˆ›å»ºå±‚çº§ï¼Œä¾‹å¦‚ å…¬å…±ç®¡ç†ç†è®º/æ”¿ç­–æ‰§è¡Œæ¡ˆä¾‹ï¼‰');
    if (!catPath) return;
    catPath = catPath.trim();
    if (!catPath) return;
    if (!notes.organized[catPath]) notes.organized[catPath] = [];
    updateNoteCategories();
  }
  function updateNoteCategories() {
    const sel = document.getElementById('note-category');
    if (!sel) return;
    // æ„å»ºé€‰é¡¹ï¼Œå¸¦ç¼©è¿›è¡¨ç¤ºå±‚çº§
    let options = '<option value="">é€‰æ‹©åˆ†ç±»...</option>';
    Object.keys(notes.organized).forEach(path => {
      const parts = path.split('/');
      const indent = '&nbsp;&nbsp;'.repeat(parts.length - 1);
      const name   = parts[parts.length - 1];
      options += `<option value="${path}">${indent}${name}</option>`;
    });
    sel.innerHTML = options;
  }

  // ============ ç¬”è®°é™„ä»¶å¤„ç† ==============
  // å­˜å‚¨å½“å‰æ·»åŠ çš„é™„ä»¶ï¼Œä¿å­˜åé‡ç½®
  let currentNoteAttachments = [];
  // å¤„ç†é™„ä»¶æ–‡ä»¶é€‰æ‹©ï¼Œç”Ÿæˆç¼©ç•¥å›¾å¹¶å­˜å‚¨ Base64 æ•°æ®
  function handleAttachmentChange(event) {
    const files = event.target.files;
    currentNoteAttachments = [];
    const preview = document.getElementById('note-attachments-preview');
    if (preview) preview.innerHTML = '';
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function() {
        const dataUrl = reader.result;
        currentNoteAttachments.push({ name: file.name, data: dataUrl });
        if (preview) {
          const img = document.createElement('img');
          img.src = dataUrl;
          img.style.width = '48px';
          img.style.height = '48px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '4px';
          preview.appendChild(img);
        }
      };
      reader.readAsDataURL(file);
    });
  }
  function viewNoteHistory(tagFilter = null) {
    // æ„å»ºæ—¶é—´è½´å¼çš„å†å²ç¬”è®°å±•ç¤º
    let html = '<h3>å†å²ç¬”è®°</h3><div class="timeline" style="max-height:70vh; overflow:auto; padding:6px;">';
    const records = [];
    // å¿«é€Ÿç¬”è®°ï¼ˆä¸å‚ä¸æ ‡ç­¾è¿‡æ»¤ï¼‰
    Object.keys(notes.quick || {}).forEach(date => {
      // å¦‚æœè¿‡æ»¤æ ‡ç­¾ï¼Œåˆ™ä¸åŒ…å«å¿«é€Ÿç¬”è®°
      if (!tagFilter) {
        records.push({
          title: 'å¿«é€Ÿç¬”è®°',
          content: notes.quick[date],
          date,
          tags: [],
          attachments: []
        });
      }
    });
    // ç³»ç»Ÿç¬”è®°
    Object.keys(notes.organized || {}).forEach(cat => {
      (notes.organized[cat] || []).forEach(note => {
        // å¦‚æœæœ‰æ ‡ç­¾è¿‡æ»¤ä¸”å½“å‰ç¬”è®°ä¸åŒ…å«è¯¥æ ‡ç­¾ï¼Œåˆ™è·³è¿‡
        if (tagFilter && (!note.tags || !note.tags.includes(tagFilter))) return;
        records.push({
          title: `${cat} - ${note.title || ''}`,
          content: note.content,
          date: note.date,
          tags: note.tags || [],
          attachments: note.attachments || []
        });
      });
    });
    records.sort((a, b) => b.date.localeCompare(a.date));
    records.forEach(item => {
      // ç”Ÿæˆæ ‡ç­¾HTMLï¼Œç‚¹å‡»æ ‡ç­¾å¯è¿›ä¸€æ­¥è¿‡æ»¤
      const tagsHtml = item.tags && item.tags.length ? item.tags.map(t => `<span class="tag-item" style="display:inline-block;background:#d9f99d;color:#365314;padding:2px 6px;border-radius:6px;font-size:12px;margin-right:4px;" onclick="filterNotesByTag('${t}')">#${t}</span>`).join('') : '';
      // ç”Ÿæˆé™„ä»¶ç¼©ç•¥å›¾
      const attachHtml = item.attachments && item.attachments.length ? item.attachments.map(att => `<img src="${att.data}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;margin-right:4px;">`).join('') : '';
      html += `<div class="timeline-item" style="margin-bottom:12px; border-bottom:1px solid #f1f5f9; padding-bottom:8px;">
        <div class="timeline-header" style="display:flex; align-items:center; justify-content:space-between; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
          <div>
            <span style="font-weight:600; color:#334155;">${item.date}</span>
            <span style="margin-left:8px; color:#475569;">${item.title}</span>
          </div>
          <span style="font-size:18px; color:#94a3b8;">â–¼</span>
        </div>
        <div class="timeline-content" style="display:none; padding:6px 0 0 0; font-size:14px; color:#475569; line-height:1.5;">
          <div>${item.content.replace(/\n/g, '<br>')}</div>
          <div style="margin-top:6px;">${tagsHtml} ${attachHtml}</div>
        </div>
      </div>`;
    });
    html += '</div><div style="text-align:right; margin-top:8px;"><button class="btn-secondary" onclick="closeModal()">å…³é—­</button></div>';
    showModal(html);
  }

  // ============ æ ‡ç­¾äº‘ä¸æ¨¡æ¿åŠŸèƒ½ ==============
  // é¢„å®šä¹‰ç¬”è®°æ¨¡æ¿ï¼Œæ–¹ä¾¿ç³»ç»ŸåŒ–è®°å½•
  const noteTemplates = {
    summary: `### è€ƒç‚¹æ¦‚è¿°\n\n- **èƒŒæ™¯**ï¼šç®€è¿°èƒŒæ™¯ä¸æ„ä¹‰ã€‚\n- **è¦ç‚¹**ï¼šåˆ†ç‚¹åˆ—å‡ºæ ¸å¿ƒå†…å®¹ã€‚\n- **å½±å“**ï¼šè®¨è®ºæ”¿ç­–æˆ–ç†è®ºçš„å®é™…å½±å“ã€‚\n- **è®°å¿†**ï¼šæä¾›ä¸€å¥è®°å¿†å°æŠ€å·§æˆ–è”æƒ³ã€‚`,
    case: `### æ¡ˆä¾‹åˆ†æ\n\n**æ¡ˆä¾‹èƒŒæ™¯**ï¼šæè¿°æ¡ˆä¾‹å‘ç”Ÿçš„èƒŒæ™¯åŠç›¸å…³æ”¿ç­–ã€‚\n\n**å†³ç­–è¿‡ç¨‹**ï¼šæ¦‚è¿°æ”¿ç­–æ‰§è¡Œçš„è¿‡ç¨‹å’Œå‚ä¸è€…ã€‚\n\n**ç»“æœè¯„ä»·**ï¼šè¯„ä¼°æ¡ˆä¾‹ç»“æœçš„æˆæ•ˆä¸ä¸è¶³ã€‚\n\n**å¯ç¤º**ï¼šæ€»ç»“æ¡ˆä¾‹å¯¹å…¬å…±ç®¡ç†çš„å¯ç¤ºã€‚`
  };

  // åº”ç”¨æ‰€é€‰æ¨¡æ¿åˆ°ç¬”è®°ç¼–è¾‘åŒº
  function applyNoteTemplate() {
    const sel = document.getElementById('note-template-select');
    if (!sel) return;
    const val = sel.value;
    const textarea = document.getElementById('organized-textarea');
    if (val && noteTemplates[val]) {
      textarea.value = noteTemplates[val];
    }
  }

  // æ¸²æŸ“æ ‡ç­¾äº‘ï¼Œå±•ç¤ºæœ€å¸¸ä½¿ç”¨çš„æ ‡ç­¾
  function renderTagCloud() {
    const container = document.getElementById('tag-cloud');
    if (!container) return;
    const tagCounts = {};
    // ç»Ÿè®¡ç³»ç»Ÿç¬”è®°çš„æ ‡ç­¾
    Object.keys(notes.organized || {}).forEach(cat => {
      (notes.organized[cat] || []).forEach(note => {
        (note.tags || []).forEach(t => {
          tagCounts[t] = (tagCounts[t] || 0) + 1;
        });
      });
    });
    const sorted = Object.entries(tagCounts).sort((a,b) => b[1] - a[1]).slice(0, 30);
    container.innerHTML = sorted.map(([tag]) => `<span class="tag-item" onclick="filterNotesByTag('${tag}')">#${tag}</span>`).join('');
  }

  // ç‚¹å‡»æ ‡ç­¾äº‘ä¸­çš„æ ‡ç­¾ï¼Œè¿‡æ»¤å†å²ç¬”è®°
  function filterNotesByTag(tag) {
    viewNoteHistory(tag);
  }

  // ============ å¤ä¹ æ¨¡å¼ ==============
  function showReviewMenu() {
    // æ–°å¢æ›´å¤šå¤ä¹ æ¨¡å¼ï¼Œç»“åˆè®°å¿†æ›²çº¿å’Œæ—¥å¸¸å­¦ä¹ éœ€æ±‚
    const opts = [
      // é»˜è®¤æ¨¡å¼ï¼šæ‰€æœ‰åº”å¤ä¹ çš„å¡ç‰‡
      { name: 'åº”å¤ä¹ ', filter: card => !card.nextReview || new Date(card.nextReview) <= new Date() },
      // ä»Šæ—¥å­¦ä¹ è¿‡çš„æ‰€æœ‰å¡ç‰‡
      { name: 'ä»Šæ—¥å·²å­¦', filter: card => card.lastReview && new Date(card.lastReview).toDateString() === new Date().toDateString() },
      // æœ¬å‘¨å­¦ä¹ è¿‡çš„å¡ç‰‡
      { name: 'æœ¬å‘¨å·²å­¦', filter: card => card.lastReview && (new Date() - new Date(card.lastReview)) <= 7 * 86400000 },
      // ä»Šæ—¥æ–°å­¦ï¼šä»Šæ—¥å¤ä¹ æ¬¡æ•°ä¸º 1 çš„å¡ç‰‡
      { name: 'ä»Šæ—¥æ–°å­¦', filter: card => card.lastReview && new Date(card.lastReview).toDateString() === new Date().toDateString() && (card.reviewCount || 0) <= 1 },
      // ä»Šæ—¥ä¸ç†Ÿï¼šä»Šæ—¥å¤ä¹ è¿‡ä½†å‡ºç°é”™è¯¯æˆ–æŒæ¡åº¦ä½
      { name: 'ä»Šæ—¥ä¸ç†Ÿ', filter: card => card.lastReview && new Date(card.lastReview).toDateString() === new Date().toDateString() && ((card.wrongCount || 0) > 0 || card.mastery < 3) },
      // å³å°†åˆ°æœŸï¼šæœªæ¥ä¸‰å¤©å†…éœ€å¤ä¹ çš„å¡ç‰‡
      { name: 'å³å°†åˆ°æœŸ', filter: card => card.nextReview && ((new Date(card.nextReview) - new Date()) / 86400000) <= 3 },
      // é«˜é¢‘è€ƒç‚¹
      { name: 'é«˜é¢‘è€ƒç‚¹', filter: card => card.examFrequency === 'é«˜é¢‘' },
      // é”™é¢˜æœ¬ï¼šé”™è¯¯æ¬¡æ•°å¤šæˆ–æŒæ¡åº¦ä½
      { name: 'é”™é¢˜æœ¬', filter: card => (card.wrongCount || 0) >= 2 || card.mastery < 3 },
      // å…¨éƒ¨å¡ç‰‡
      { name: 'å…¨éƒ¨å¡ç‰‡', filter: () => true },
      // ä¹±åºï¼šéšæœºæ’åºæ‰€æœ‰å¡ç‰‡
      { name: 'ä¹±åº', filter: () => true, shuffle: true }
    ];
    let html = '<h3>é€‰æ‹©å¤ä¹ æ¨¡å¼</h3>';
    opts.forEach((opt, i) => {
      html += `<button class="btn-primary" style="margin:7px 0;width:100%;" onclick="applyReviewMode(${i})">${opt.name}</button>`;
    });
    html += `<div style="text-align:right;margin-top:8px;"><button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button></div>`;
    showModal(html);
  }
  function applyReviewMode(idx) {
    // å¤ä¹ æ¨¡å¼åˆ—è¡¨éœ€ä¸ showReviewMenu ä¿æŒä¸€è‡´
    const opts = [
      { name: 'åº”å¤ä¹ ', filter: card => !card.nextReview || new Date(card.nextReview) <= new Date() },
      { name: 'ä»Šæ—¥å·²å­¦', filter: card => card.lastReview && new Date(card.lastReview).toDateString() === new Date().toDateString() },
      { name: 'æœ¬å‘¨å·²å­¦', filter: card => card.lastReview && (new Date() - new Date(card.lastReview)) <= 7 * 86400000 },
      { name: 'ä»Šæ—¥æ–°å­¦', filter: card => card.lastReview && new Date(card.lastReview).toDateString() === new Date().toDateString() && (card.reviewCount || 0) <= 1 },
      { name: 'ä»Šæ—¥ä¸ç†Ÿ', filter: card => card.lastReview && new Date(card.lastReview).toDateString() === new Date().toDateString() && ((card.wrongCount || 0) > 0 || card.mastery < 3) },
      { name: 'å³å°†åˆ°æœŸ', filter: card => card.nextReview && ((new Date(card.nextReview) - new Date()) / 86400000) <= 3 },
      { name: 'é«˜é¢‘è€ƒç‚¹', filter: card => card.examFrequency === 'é«˜é¢‘' },
      { name: 'é”™é¢˜æœ¬', filter: card => (card.wrongCount || 0) >= 2 || card.mastery < 3 },
      { name: 'å…¨éƒ¨å¡ç‰‡', filter: () => true },
      { name: 'ä¹±åº', filter: () => true, shuffle: true }
    ];
    const opt = opts[idx];
    activeReviewFilter = opt.filter;
    let base = cards.filter(opt.filter);
    if (opt.shuffle) base = base.sort(() => Math.random() - 0.5);
    currentCardList = base;
    renderGrid(base);
    updateCardList(base);
    closeModal();
  }

  // ============ ç®¡ç†é¢˜åº“ç•Œé¢ ==============
  function showManageLibrary() {
    let html = '<h3 style="margin-bottom:12px;">ç®¡ç†é¢˜åº“</h3>';
    html += '<div style="display:flex; gap:10px; margin-bottom:12px;">';
    html += '<input type="text" id="manage-search" placeholder="æœç´¢é¢˜å¹²/ç­”æ¡ˆ/ç§‘ç›®..." oninput="renderManageTable(this.value)" style="flex:1; padding:8px; border:1px solid #e2e8f0; border-radius:8px;">';
    html += '<select id="manage-sort" onchange="renderManageTable()" style="padding:8px; border:1px solid #e2e8f0; border-radius:8px;">';
    html += '<option value="mastery">æŒ‰æŒæ¡åº¦é™åº</option>';
    html += '<option value="wrongCount">æŒ‰é”™é¢˜æ¬¡æ•°é™åº</option>';
    html += '<option value="nextReview">æŒ‰å¤ä¹ æ—¶é—´å‡åº</option>';
    html += '<option value="lastReview">æŒ‰æœ€åå¤ä¹ æ—¶é—´é™åº</option>';
    html += '<option value="reviewCount">æŒ‰å¤ä¹ æ¬¡æ•°é™åº</option>';
    html += '<option value="front">æŒ‰é¢˜å¹²A-Z</option>';
    html += '</select></div>';
    html += '<table class="manage-table" id="manage-table" style="width:100%;margin-bottom:16px;font-size:14px;"></table>';
    html += '<div class="pagination" id="manage-pagination"></div>';
    html += '<div style="display:flex; flex-wrap:wrap; justify-content:flex-end; gap:10px; margin-top:16px;">';
    html += '<button class="btn-secondary" onclick="closeModal()">å…³é—­</button>';
    html += '<button class="btn-primary" onclick="deleteByCategoryOrChapter()" style="background:#fbbf24; color:#fff;">åˆ é™¤ç« èŠ‚/ç§‘ç›®</button>';
    html += '<button class="btn-primary" onclick="clearAllCards()" style="background:#ef4444; color:#fff;">æ¸…é™¤æ‰€æœ‰</button>';
    html += '<button class="btn-primary" onclick="batchExportSelected()" style="background:#4ade80;">å¯¼å‡ºé€‰ä¸­</button>';
    html += '<button class="btn-primary" onclick="batchDeleteSelected()" style="background:#ef4444;color:#fff;">æ‰¹é‡åˆ é™¤</button>';
    html += '</div>';
    showModal(html);
    renderManageTable();
  }
  function renderManageTable(query = '', page = 1) {
    const q = query.toLowerCase();
    let filtered = cards.filter(card => {
      const text = q;
      const inFront   = card.front.toLowerCase().includes(text);
      const inBack    = card.back.toLowerCase().includes(text);
      const inCat     = card.category.toLowerCase().includes(text) || card.chapter.toLowerCase().includes(text);
      const inTags    = (card.tags || []).some(tag => tag.toLowerCase().includes(text));
      return inFront || inBack || inCat || inTags;
    });
    const sort = document.getElementById('manage-sort').value;
    if (sort === 'mastery') {
      filtered.sort((a,b) => b.mastery - a.mastery);
    } else if (sort === 'wrongCount') {
      filtered.sort((a,b) => (b.wrongCount || 0) - (a.wrongCount || 0));
    } else if (sort === 'nextReview') {
      filtered.sort((a,b) => (new Date(a.nextReview || '9999-12-31') - new Date(b.nextReview || '9999-12-31')));
    } else if (sort === 'lastReview') {
      // æœ€è¿‘å¤ä¹ æ—¶é—´é™åºï¼Œæœªå¤ä¹ çš„æ’åœ¨æœ€å
      filtered.sort((a,b) => {
        const da = a.lastReview ? new Date(a.lastReview) : new Date(0);
        const db = b.lastReview ? new Date(b.lastReview) : new Date(0);
        return db - da;
      });
    } else if (sort === 'reviewCount') {
      filtered.sort((a,b) => (b.reviewCount || 0) - (a.reviewCount || 0));
    } else if (sort === 'front') {
      filtered.sort((a,b) => a.front.localeCompare(b.front));
    }
    const perPage = 15;
    const start = (page - 1) * perPage;
    const paginated = filtered.slice(start, start + perPage);
    let tableHtml = '<thead><tr>' +
      '<th style="width:5%;"><input type="checkbox" onclick="toggleAllCheck(this)"></th>' +
      '<th style="width:25%;">é¢˜å¹²</th>' +
      '<th style="width:15%;">ç§‘ç›®/ç« èŠ‚</th>' +
      '<th style="width:10%;">æŒæ¡åº¦</th>' +
      '<th style="width:10%;">é”™é¢˜æ•°</th>' +
      '<th style="width:15%;">ä¸‹æ¬¡å¤ä¹ </th>' +
      '<th style="width:15%;">æ ‡ç­¾</th>' +
      '<th style="width:10%;">æ“ä½œ</th>' +
      '</tr></thead><tbody>';
    paginated.forEach(card => {
      const nextReview = card.nextReview ? new Date(card.nextReview).toLocaleDateString() : 'æœªå¤ä¹ ';
      const tagStr = (card.tags || []).join(', ');
      tableHtml += `<tr>` +
        `<td><input type="checkbox" data-front="${card.front}"></td>` +
        `<td>${truncateText(card.front, 40)}</td>` +
        `<td>${card.category}/${card.chapter}</td>` +
        `<td>${card.mastery}</td>` +
        `<td>${card.wrongCount || 0}</td>` +
        `<td>${nextReview}</td>` +
        `<td>${truncateText(tagStr, 20)}</td>` +
        `<td>` +
          `<button class="btn-primary" style="padding:4px 8px; font-size:12px;" onclick="showEditCard('${card.front}')">ç¼–è¾‘</button> ` +
          `<button class="btn-secondary" style="padding:4px 8px; font-size:12px; background:#ef4444; color:#fff;" onclick="deleteCard('${card.front}')">åˆ é™¤</button> ` +
          `<button class="btn-secondary" style="padding:4px 8px; font-size:12px; background:#6366f1; color:#fff;" onclick="openCard('${card.front}')">æŸ¥çœ‹</button>` +
        `</td>` +
      `</tr>`;
    });
    tableHtml += '</tbody>';
    document.getElementById('manage-table').innerHTML = tableHtml;
    // åˆ†é¡µ
    const pages = Math.ceil(filtered.length / perPage);
    let pagHtml = '';
    for (let i = 1; i <= pages; i++) {
      pagHtml += `<span class="page-btn ${i === page ? 'active' : ''}" onclick="renderManageTable('${query}', ${i})" style="padding:6px 12px; background:${i === page ? '#6366f1' : '#f1f5f9'}; color:${i === page ? '#fff' : '#1e293b'}; border-radius:8px; cursor:pointer; margin:0 4px;">${i}</span>`;
    }
    document.getElementById('manage-pagination').innerHTML = pagHtml;
  }
  function toggleAllCheck(checkbox) {
    document.querySelectorAll('.manage-table input[type="checkbox"]').forEach(cb => cb.checked = checkbox.checked);
  }
  function batchDeleteSelected() {
    const selected = Array.from(document.querySelectorAll('.manage-table input[type="checkbox"]:checked')).map(cb => cb.dataset.front);
    if (selected.length === 0 || !confirm(`ç¡®è®¤åˆ é™¤${selected.length}å¼ å¡ç‰‡ï¼Ÿ`)) return;
    cards = cards.filter(c => !selected.includes(c.front));
    localStorage.setItem('flashcards', JSON.stringify(cards));
    renderManageTable();
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
  }
  function batchExportSelected() {
    const selected = Array.from(document.querySelectorAll('.manage-table input[type="checkbox"]:checked')).map(cb => cb.dataset.front);
    if (selected.length === 0) return alert('è¯·é€‰æ‹©å¡ç‰‡');
    const exportCards = cards.filter(c => selected.includes(c.front));
    const data = JSON.stringify(exportCards, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'selected_flashcards_' + Date.now() + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // åˆ é™¤å…¨éƒ¨é—ªå¡ï¼Œè°¨æ…æ“ä½œ
  function clearAllCards() {
    if (!confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰é—ªå¡å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼')) return;
    cards = [];
    localStorage.removeItem('flashcards');
    // æ›´æ–°ç•Œé¢
    updateCardList([]);
    renderGrid([]);
    updateStats();
    updateTagList();
    closeModal();
    alert('æ‰€æœ‰é—ªå¡å·²åˆ é™¤');
  }

  // æ ¹æ®ç§‘ç›®æˆ–ç« èŠ‚æ‰¹é‡åˆ é™¤é—ªå¡
  function deleteByCategoryOrChapter() {
    let cat = prompt('è¾“å…¥è¦åˆ é™¤çš„ç§‘ç›®åç§°ï¼ˆå¯ç•™ç©ºï¼‰');
    let chap = prompt('è¾“å…¥è¦åˆ é™¤çš„ç« èŠ‚åç§°ï¼ˆå¯ç•™ç©ºï¼‰');
    if (!cat && !chap) return;
    cat = cat ? cat.trim() : '';
    chap = chap ? chap.trim() : '';
    if (!cat && !chap) return;
    // åˆ é™¤åŒ¹é…çš„å¡ç‰‡
    cards = cards.filter(card => {
      if (cat && chap) {
        return !(card.category === cat && card.chapter === chap);
      } else if (cat) {
        return card.category !== cat;
      } else {
        return card.chapter !== chap;
      }
    });
    localStorage.setItem('flashcards', JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered);
    renderGrid(filtered);
    updateStats();
    updateTagList();
    closeModal();
    alert('å·²åˆ é™¤æŒ‡å®šçš„é—ªå¡');
  }

  // ============ ç¼–è¾‘/åˆ é™¤ å¡ç‰‡ ==============
  function showEditCard(front) {
    const i = cards.findIndex(c => c.front === front);
    if (i === -1) return;
    const card = cards[i];
    let html = `
    <h3>ç¼–è¾‘å¡ç‰‡</h3>
    <label>é¢˜å¹²(æ­£é¢):<input type="text" id="edit-front" value="${card.front}" style="width:95%;margin-bottom:7px;"></label><br>
    <label>ç­”æ¡ˆ(èƒŒé¢):<textarea id="edit-back" style="width:95%;height:70px;">${card.back}</textarea></label><br>
    <label>ç§‘ç›®:<input type="text" id="edit-category" value="${card.category}" style="width:45%;"></label>
    <label>ç« èŠ‚:<input type="text" id="edit-chapter" value="${card.chapter}" style="width:45%;"></label><br>
    <label>é«˜é¢‘:<input type="checkbox" id="edit-high" ${card.examFrequency === 'é«˜é¢‘' ? 'checked' : ''}></label>
    <label>é‡ç‚¹:<input type="checkbox" id="edit-key" ${card.level === 'é‡ç‚¹' ? 'checked' : ''}></label><br>
    <label>æ ‡ç­¾(é€—å·åˆ†éš”):<input type="text" id="edit-tags" value="${(card.tags || []).join(', ')}" style="width:95%;margin:6px 0;"></label><br>
    <label>é“¾æ¥(å…³è”é¢˜å¹²,é€—å·åˆ†éš”):<input type="text" id="edit-links" value="${(card.links || []).join(', ')}" style="width:95%;"></label>
    <div style="text-align:right;margin-top:13px;">
      <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn-save" onclick="doEditCard('${front}')">ä¿å­˜</button>
      <button class="btn-primary" style="background:#f44;color:#fff;margin-left:8px;" onclick="deleteCard('${front}')">åˆ é™¤</button>
    </div>`;
    showModal(html);
  }
  function doEditCard(oldFront) {
    const i = cards.findIndex(c => c.front === oldFront);
    if (i === -1) return alert('æœªæ‰¾åˆ°å¡ç‰‡');
    const newFront = document.getElementById('edit-front').value.trim();
    const newBack = document.getElementById('edit-back').value;
    const newCat = document.getElementById('edit-category').value;
    const newChap = document.getElementById('edit-chapter').value;
    cards[i].front = newFront;
    cards[i].back = newBack;
    cards[i].category = newCat;
    cards[i].chapter = newChap;
    cards[i].examFrequency = document.getElementById('edit-high').checked ? 'é«˜é¢‘' : 'ä½é¢‘';
    cards[i].level = document.getElementById('edit-key').checked ? 'é‡ç‚¹' : 'åŸºç¡€';
    cards[i].tags = document.getElementById('edit-tags').value.split(',').map(s => s.trim()).filter(Boolean);
    cards[i].links = document.getElementById('edit-links').value.split(',').map(s => s.trim()).filter(Boolean);
    localStorage.setItem('flashcards', JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
    closeModal();
  }
  function deleteCard(front) {
    if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
    cards = cards.filter(c => c.front !== front);
    localStorage.setItem('flashcards', JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
    closeModal();
  }

  // ============ é€šç”¨æ¨¡æ€ ==============
  function showModal(html) {
    document.getElementById('import-modal-root').innerHTML = `<div><div class="modal-content" style="max-width:800px; max-height:80vh; overflow-y:auto;">${html}</div></div>`;
  }
  function closeModal() {
    document.getElementById('import-modal-root').innerHTML = '';
  }

  // é¡µé¢åˆå§‹åŒ–
  function initializeApp() {
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered);
    renderGrid(filtered);
    updateStats();
    updateCountdown();
    // åŠ è½½å­¦ä¹ ç›®æ ‡å’Œæ¸²æŸ“ç›®æ ‡ä¿¡æ¯
    loadStudyGoal();
    updateNoteCategories();
    // ç»‘å®šé™„ä»¶é€‰æ‹©äº‹ä»¶
    const attachInput = document.getElementById('note-attachment');
    if (attachInput) attachInput.addEventListener('change', handleAttachmentChange);
    // æ¢å¤ç¬”è®°è¾“å…¥
    if (notes.quick) {
      const latest = Object.keys(notes.quick).sort().pop();
      if (latest) document.getElementById('quick-textarea').value = notes.quick[latest];
    }
    // ç»‘å®šä¾§è¾¹æ æŒ‰é’®äº‹ä»¶
    const importBtn = document.getElementById('btn-import');
    const newBtn    = document.getElementById('btn-new');
    const manageBtn = document.getElementById('btn-manage');
    if (importBtn) importBtn.addEventListener('click', showImportModal);
    if (newBtn)    newBtn.addEventListener('click', addNewCard);
    if (manageBtn) manageBtn.addEventListener('click', showManageLibrary);
    const reviewBtn = document.getElementById('btn-review');
    if (reviewBtn) reviewBtn.addEventListener('click', showReviewMenu);
    // æ¸²æŸ“æ ‡ç­¾äº‘
    renderTagCloud();
    // æŒ‰é”®ç»‘å®šï¼šCtrl+E å¯¼å‡º
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportCards(); }
    });
  }
  window.onload = initializeApp;
  </script>

  <!-- Chat Assistant -->
  <button class="chat-toggle-btn" onclick="toggleChatWidget()">è€ƒç ”å°åŠ©æ‰‹</button>
  <div class="chat-widget" id="chatWidget">
    <div class="chat-widget-header" id="chatHeader" onmousedown="startDrag(event)">
      <span>è€ƒç ”å°åŠ©æ‰‹</span>
      <button onclick="toggleChatWidget()">âœ•</button>
    </div>
    <div class="chat-task-tabs">
      <div class="chat-tab" data-task="generate" onclick="changeChatTab('generate')">ç”Ÿæˆé—ªå¡</div>
      <div class="chat-tab" data-task="recommend" onclick="changeChatTab('recommend')">å¤ä¹ æ¨è</div>
      <div class="chat-tab" data-task="summary" onclick="changeChatTab('summary')">ç¬”è®°æ€»ç»“</div>
      <div class="chat-tab" data-task="qa" onclick="changeChatTab('qa')">ç­”ç–‘è§£æƒ‘</div>
      <div class="chat-tab" data-task="progress" onclick="changeChatTab('progress')">è¿›åº¦æ¿€åŠ±</div>
    </div>
    <div class="chat-session-controls">
      <select id="sessionSelect" onchange="changeChatSession(this.value)"></select>
      <button onclick="newChatSession()" style="white-space: nowrap;">æ–°å»ºå¯¹è¯</button>
      <!-- Button to set API key. Allows user to input a new DeepSeek API key at runtime -->
      <button onclick="setApiKey()" style="white-space: nowrap;">è®¾ç½®Key</button>
    </div>
    <div class="chat-widget-body" id="chatBody"></div>
    <div class="chat-widget-footer">
      <textarea id="chat-input" placeholder="è¯·è¾“å…¥å†…å®¹ï¼ŒæŒ‰Shift+Enteræ¢è¡Œ" onkeydown="chatInputKeyDown(event)"></textarea>
      <button onclick="sendChatMessage()">å‘é€</button>
    </div>
  </div>
  <script>
  // Chat Assistant Implementation
  // API keyï¼Œå¯é€šè¿‡ç”¨æˆ·è®¾ç½®è¦†ç›–
  let deepseekKey = localStorage.getItem('deepseekApiKey') || 'sk-4c1305b56d93428e9b821586e2df8751';
  let chatVisible = false;
  let chatTask = 'generate';
  const taskPrompts = {
    generate: `ä½ æ˜¯ä¸€ä¸ªå…¬å…±ç®¡ç†è€ƒç ”é—ªå¡ç”ŸæˆAIåŠ©æ‰‹ï¼Œä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆ JSON æ ¼å¼çš„é—ªå¡ã€‚è¯·éµå¾ªä»¥ä¸‹è§„èŒƒï¼š\n1. **è¾“å…¥**ï¼šç”¨æˆ·æä¾›çš„å…³é”®è¯æˆ–é¢˜å¹²ï¼Œå¦‚â€œæ”¿ç­–æ‰§è¡Œçš„æ ¸å¿ƒè¦ç´ â€ã€‚\n2. **è¾“å‡º**ï¼šå¿…é¡»æ˜¯ä¸€ä¸ª JSON æ•°ç»„ï¼Œæ•°ç»„åªåŒ…å«ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡å­—æ®µä¸º frontã€backã€categoryã€chapterã€tagsã€linksï¼Œä¸å¾—è¾“å‡ºä»»ä½•å…¶ä»–æ–‡æœ¬ã€‚\n3. **front**ï¼šç”¨ç–‘é—®å¥æ¦‚æ‹¬é¢˜æ„ï¼Œ50 å­—ä»¥å†…ï¼Œä¾‹å¦‚â€œä»€ä¹ˆæ˜¯æ”¿ç­–æ‰§è¡Œï¼Ÿå…¶æ ¸å¿ƒè¦ç´ åŒ…æ‹¬å“ªäº›ï¼Ÿâ€ã€‚\n4. **back**ï¼šç­”æ¡ˆéœ€è¦è¯¦å°½ï¼ˆ200â€‘300 å­—ï¼‰ï¼Œé‡‡ç”¨ Markdown æ’ç‰ˆï¼Œå¹¶å°†å†…å®¹ç»†è‡´æ‹†åˆ†ï¼š\n   - **å®šä¹‰**ï¼šç”¨ä¸€ä¸¤å¥è¯ç²¾ç‚¼è§£é‡Šæ¦‚å¿µã€‚\n   - **æ ¸å¿ƒè¦ç´ /æœºåˆ¶**ï¼šç”¨æœ‰åºæˆ–æ— åºåˆ—è¡¨æ·±å…¥åˆ†è§£å…³é”®è¦ç´ ï¼Œæ¯ä¸ªè¦ç´ ç”¨ä¸€åˆ°ä¸¤å¥è¯è§£é‡Šï¼Œæ¡ç›®å°½é‡ç»†å°ã€‚\n   - **å®é™…æ¡ˆä¾‹**ï¼šç»“åˆå…¬å…±ç®¡ç†çƒ­ç‚¹ï¼ˆå¦‚â€œåŒç¢³ç›®æ ‡â€ï¼‰å†™ä¸€ä¸ªæ¡ˆä¾‹ï¼Œè¯´æ˜å…¶ä¸ä¸»é¢˜çš„å…³è”ã€‚\n   - **ä¼˜ç¼ºç‚¹åˆ†æ**ï¼šåˆ†åˆ«åˆ—ä¸¾ä¼˜åŠ¿ä¸å±€é™ï¼Œå¯ç»“åˆå®é™…é—®é¢˜è¿›è¡Œåˆ†æã€‚\n   - **è®°å¿†æŠ€å·§**ï¼šæä¾›å£è¯€æˆ–è”æƒ³ï¼Œé¼“åŠ±ä½¿ç”¨è¡¨æƒ…ç¬¦å·æå‡è¶£å‘³æ€§ã€‚\n5. **category**ï¼šæ‰€å±ç§‘ç›®ï¼Œå¦‚â€œå…¬å…±ç®¡ç†å­¦â€ï¼›**chapter**ï¼šæ‰€å±ç« èŠ‚ï¼Œå¦‚â€œå†³ç­–ç†è®ºâ€ï¼›**tags**ï¼š2â€‘5 ä¸ªå…³é”®è¯çš„æ•°ç»„ï¼›**links**ï¼šå…³è”å¡ç‰‡é¢˜å¹²æˆ– URL çš„æ•°ç»„ï¼Œæ— åˆ™ä¸º []ã€‚\n6. ä¿è¯ç”Ÿæˆçš„ JSON è¯­æ³•æ­£ç¡®ï¼Œå†…å®¹è´´åˆå…¬å…±ç®¡ç†è€ƒç ”å¤§çº²ï¼Œè¯­è¨€é€šä¿—æ˜“æ‡‚ï¼Œä¾¿äºç†è§£è®°å¿†ã€‚`,
    recommend: `ä½ æ˜¯ä¸€ä¸ªå…¬å…±ç®¡ç†è€ƒç ”åŠ©æ‰‹ï¼Œä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·å­¦ä¹ è¿›åº¦æ¨èå¤ä¹ å†…å®¹ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚ï¼š\n1. è¾“å…¥ï¼šç”¨æˆ·å­¦ä¹ æ•°æ®ï¼ˆå¦‚å·²æŒæ¡å¤šå°‘å¼ ï¼Œå¤ä¹ ä¸­å¤šå°‘å¼ ï¼Œæœªå­¦ä¹ å¤šå°‘å¼ ï¼Œæœ€è¿‘ç­”é”™çš„çŸ¥è¯†ç‚¹åŠæ¬¡æ•°ï¼‰ã€‚\n2. åˆ†æè–„å¼±ç‚¹ï¼Œæ¨è3-5å¼ é—ªå¡æˆ–çŸ¥è¯†ç‚¹ï¼Œä¼˜å…ˆçº§ä¸ºï¼šç­”é”™ç‡é«˜çš„ > æœªå­¦ä¹ çš„ > å¤ä¹ ä¸­çš„ã€‚\n3. è¾“å‡ºæ ¼å¼ï¼š\n   - æ¨èå†…å®¹ï¼šçŸ¥è¯†ç‚¹æˆ–é—ªå¡æ ‡é¢˜\n   - åŸå› ï¼šä¸ºä»€ä¹ˆæ¨èï¼ˆ50å­—ä»¥å†…ï¼‰\n   - å¤ä¹ å»ºè®®ï¼šå¦‚ä½•è®°å¿†ï¼ˆå¦‚è”æƒ³ã€ä¾‹é¢˜ï¼‰\n4. ç¡®ä¿æ¨èå†…å®¹ä¸å…¬å…±ç®¡ç†è€ƒç ”ç›¸å…³ï¼Œè¯­è¨€ç®€æ´ã€‚`,
    summary: `ä½ æ˜¯ä¸€ä¸ªå…¬å…±ç®¡ç†è€ƒç ”åŠ©æ‰‹ï¼Œä»»åŠ¡æ˜¯ä»ç”¨æˆ·è¾“å…¥æˆ–ä¸Šä¼ èµ„æ–™ä¸­ç”Ÿæˆç®€æ´ç¬”è®°ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚ï¼š\n1. è¾“å…¥ï¼šç”¨æˆ·ä¸Šä¼ çš„èµ„æ–™ç‰‡æ®µæˆ–è¾“å…¥çš„æ–‡å­—ã€‚\n2. æå–3-5ä¸ªå…³é”®ç‚¹ï¼Œæ¯ç‚¹ä¸è¶…è¿‡50å­—ï¼Œçªå‡ºå…¬å…±ç®¡ç†è€ƒç ”è€ƒç‚¹ã€‚\n3. è¾“å‡ºæ ¼å¼ï¼š\n   - æ ‡é¢˜ï¼šç« èŠ‚æˆ–ä¸»é¢˜\n   - å…³é”®ç‚¹ï¼šç¼–å·åˆ—å‡º\n   - å¤‡æ³¨ï¼šé€‚ç”¨åœºæ™¯æˆ–è®°å¿†å»ºè®®\n4. è¯­è¨€ç®€æ´ï¼Œç¬¦åˆè€ƒç ”ç”Ÿé˜…è¯»ä¹ æƒ¯ã€‚`,
    qa: `ä½ æ˜¯ä¸€ä¸ªå…¬å…±ç®¡ç†è€ƒç ”åŠ©æ‰‹ï¼Œä»»åŠ¡æ˜¯å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼Œæä¾›ç®€æ˜è§£æã€‚è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚ï¼š\n1. è¾“å…¥ï¼šç”¨æˆ·çš„é—®é¢˜ã€‚\n2. è¾“å‡ºï¼š\n   - ç­”æ¡ˆï¼š100-200å­—ï¼Œç®€æ´è§£é‡Šæ¦‚å¿µï¼ŒåŒ…å«1ä¸ªå®é™…æ¡ˆä¾‹ã€‚\n   - è®°å¿†å»ºè®®ï¼šç®€çŸ­å£è¯€æˆ–è”æƒ³ã€‚\n3. ç¡®ä¿ç­”æ¡ˆç¬¦åˆå…¬å…±ç®¡ç†è€ƒç ”çŸ¥è¯†ä½“ç³»ï¼Œè¯­è¨€é€šä¿—ã€‚`,
    progress: `ä½ æ˜¯ä¸€ä¸ªå…¬å…±ç®¡ç†è€ƒç ”åŠ©æ‰‹ï¼Œä»»åŠ¡æ˜¯ç”Ÿæˆå­¦ä¹ è¿›åº¦æŠ¥å‘Šå’Œæ¿€åŠ±åé¦ˆã€‚è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚ï¼š\n1. è¾“å…¥ï¼šç”¨æˆ·å­¦ä¹ æ•°æ®ï¼ˆå¦‚ä»Šæ—¥å·²å­¦å¤šå°‘å¼ ï¼Œè¿ç»­å­¦ä¹ å¤šå°‘å¤©ï¼ŒæŒæ¡æ¯”ä¾‹ï¼‰ã€‚\n2. è¾“å‡ºï¼š\n   - è¿›åº¦æŠ¥å‘Šï¼šæ€»ç»“ä»Šæ—¥å®Œæˆã€è¿ç»­å¤©æ•°ã€æŒæ¡æ¯”ä¾‹ï¼ˆ50å­—ä»¥å†…ï¼‰ã€‚\n   - æ¿€åŠ±åé¦ˆï¼šé¼“åŠ±æ€§çŸ­è¯­ï¼ˆ20å­—ä»¥å†…ï¼‰ã€‚\n   - å›¾è¡¨å»ºè®®ï¼šæè¿°ä¸€ä¸ªç®€å•å›¾è¡¨ï¼ˆå¦‚é¥¼å›¾ï¼Œæ˜¾ç¤ºæŒæ¡/æœªæŒæ¡æ¯”ä¾‹ï¼‰ã€‚\n3. è¯­è¨€ç§¯æï¼Œé€‚åˆè€ƒç ”ç”Ÿã€‚`
  };
  let chatHistories = {};
  // å½“å‰ä¼šè¯ç´¢å¼•ï¼Œç”¨äºæ¯ä¸ªä»»åŠ¡è·Ÿè¸ªé€‰æ‹©çš„å†å²å¯¹è¯
  let currentSessionIndex = {};
  function loadChatHistories() {
    const data = localStorage.getItem('chatHistories');
    chatHistories = data ? JSON.parse(data) : {};
    ['generate','recommend','summary','qa','progress'].forEach(t => {
      if (!chatHistories[t]) chatHistories[t] = [];
      // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼ˆç›´æ¥å­˜å‚¨æ¶ˆæ¯æ•°ç»„ï¼‰ï¼Œåˆ™è½¬æ¢ä¸ºåŒ…å«å•ä¸ªä¼šè¯çš„æ•°ç»„
      if (chatHistories[t].length > 0 && chatHistories[t][0] && chatHistories[t][0].role) {
        const msgs = chatHistories[t];
        const title = msgs[0] && msgs[0].text ? msgs[0].text.substring(0, 20) : 'ä¼šè¯1';
        chatHistories[t] = [{ title: title, messages: msgs }];
      }
      // å¦‚æœä¸ºç©ºåˆ™åˆå§‹åŒ–è‡³å°‘ä¸€ä¸ªä¼šè¯
      if (chatHistories[t].length === 0) {
        chatHistories[t].push({ title: 'ä¼šè¯1', messages: [] });
      }
      // åˆå§‹åŒ–å½“å‰ä¼šè¯ç´¢å¼•
      if (typeof currentSessionIndex[t] === 'undefined') currentSessionIndex[t] = 0;
    });
  }
  function saveChatHistories() {
    localStorage.setItem('chatHistories', JSON.stringify(chatHistories));
  }
  function toggleChatWidget() {
    chatVisible = !chatVisible;
    const widget = document.getElementById('chatWidget');
    widget.style.display = chatVisible ? 'flex' : 'none';
    if (chatVisible) {
      renderSessionOptions();
      renderChatHistory();
    }
  }
  function changeChatTab(task) {
    chatTask = task;
    updateTabUI();
    renderSessionOptions();
    renderChatHistory();
  }
  function updateTabUI() {
    const tabs = document.querySelectorAll('.chat-tab');
    tabs.forEach(tab => {
      if (tab.getAttribute('data-task') === chatTask) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });
  }

  // æ¸²æŸ“ä¼šè¯ä¸‹æ‹‰åˆ—è¡¨
  function renderSessionOptions() {
    const select = document.getElementById('sessionSelect');
    if (!select) return;
    select.innerHTML = '';
    const sessions = chatHistories[chatTask] || [];
    sessions.forEach((session, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = session.title || ('ä¼šè¯' + (idx + 1));
      select.appendChild(option);
    });
    select.value = currentSessionIndex[chatTask] || 0;
  }

  // æ–°å»ºå¯¹è¯
  function newChatSession() {
    if (!chatHistories[chatTask]) chatHistories[chatTask] = [];
    const newIndex = chatHistories[chatTask].length + 1;
    const newSession = { title: 'ä¼šè¯' + newIndex, messages: [] };
    chatHistories[chatTask].push(newSession);
    currentSessionIndex[chatTask] = chatHistories[chatTask].length - 1;
    saveChatHistories();
    renderSessionOptions();
    renderChatHistory();
  }

  // åˆ‡æ¢å½“å‰å¯¹è¯
  function changeChatSession(idx) {
    const index = parseInt(idx);
    if (isNaN(index)) return;
    currentSessionIndex[chatTask] = index;
    renderChatHistory();
  }
  function renderChatHistory() {
    const chatBody = document.getElementById('chatBody');
    chatBody.innerHTML = '';
    const sessions = chatHistories[chatTask] || [];
    const sessionIdx = currentSessionIndex[chatTask] || 0;
    const messages = sessions[sessionIdx] ? sessions[sessionIdx].messages : [];
    messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'chat-message ' + msg.role;
      div.textContent = msg.text;
      if (msg.role === 'assistant') {
        const copyBtn = document.createElement('div');
        copyBtn.className = 'chat-copy-btn';
        copyBtn.textContent = 'å¤åˆ¶';
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(msg.text);
        });
        div.appendChild(copyBtn);
      }
      chatBody.appendChild(div);
    });
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  function appendMessage(role, text) {
    if (!chatHistories[chatTask]) chatHistories[chatTask] = [];
    // ç¡®ä¿å½“å‰ä¼šè¯å­˜åœ¨
    const sessions = chatHistories[chatTask];
    const idx = currentSessionIndex[chatTask] || 0;
    if (!sessions[idx]) {
      sessions[idx] = { title: 'ä¼šè¯' + (idx + 1), messages: [] };
    }
    // è¿½åŠ æ¶ˆæ¯
    sessions[idx].messages.push({ role, text });
    // å¦‚æœè¿™æ˜¯ä¼šè¯çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å¹¶ä¸”æ¥è‡ªç”¨æˆ·ï¼Œåˆ™ç”¨è¯¥æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
    if (role === 'user' && sessions[idx].messages.length === 1) {
      sessions[idx].title = text.substring(0, 20);
    }
    saveChatHistories();
    const chatBody = document.getElementById('chatBody');
    const div = document.createElement('div');
    div.className = 'chat-message ' + role;
    div.textContent = text;
    if (role === 'assistant') {
      const copyBtn = document.createElement('div');
      copyBtn.className = 'chat-copy-btn';
      copyBtn.textContent = 'å¤åˆ¶';
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(text);
      });
      div.appendChild(copyBtn);
    }
    chatBody.appendChild(div);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  function chatInputKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChatMessage();
    }
  }
  function sendChatMessage() {
    const textarea = document.getElementById('chat-input');
    const content = textarea.value.trim();
    if (!content) return;
    appendMessage('user', content);
    textarea.value = '';
    const messages = [];
    messages.push({ role: 'system', content: taskPrompts[chatTask] });
    const sessions = chatHistories[chatTask] || [];
    const idx = currentSessionIndex[chatTask] || 0;
    const historyMsgs = sessions[idx] ? sessions[idx].messages : [];
    historyMsgs.forEach(msg => {
      messages.push({ role: msg.role === 'user' ? 'user' : 'assistant', content: msg.text });
    });
    messages.push({ role: 'user', content });
    const payload = {
      // ä½¿ç”¨å®˜æ–¹æ¨èæ¨¡å‹ deepseek-chatã€44111126585802â€ L65-L69ã€‘ã€44111126585802â€ L173-L177ã€‘
      model: 'deepseek-chat',
      messages: messages,
      stream: false
    };
    fetch('https://api.deepseek.com/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + deepseekKey
      },
      body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
      const assistantReply = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content.trim() : 'æŠ±æ­‰ï¼Œæ— æ³•è·å–å›ç­”ã€‚';
      appendMessage('assistant', assistantReply);
      // å¦‚æœæ˜¯ç”Ÿæˆé—ªå¡ä»»åŠ¡ï¼Œåˆ™å°è¯•è§£æå¹¶å¯¼å…¥å¡ç‰‡
      if (chatTask === 'generate') {
        const arr = parseJsonArray(assistantReply);
        if (arr && Array.isArray(arr) && arr.length) {
          importAICards(arr);
        }
      }
    })
    .catch(err => {
      console.error(err);
      appendMessage('assistant', 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚');
    });
  }

  // Allow user to set a new DeepSeek API key at runtime. Prompts the user for a key,
  // updates the global variable and persists it to localStorage. A success alert
  // is shown when the key is updated. If the input is empty or cancelled, the
  // key remains unchanged.
  function setApiKey() {
    const newKey = prompt('è¯·è¾“å…¥æ–°çš„ DeepSeek API å¯†é’¥ï¼š', deepseekKey);
    if (newKey && newKey.trim()) {
      deepseekKey = newKey.trim();
      localStorage.setItem('deepseekApiKey', deepseekKey);
      alert('API å¯†é’¥å·²æ›´æ–°ï¼');
    }
  }
  // Dragging support
  let dragOffsetX = 0;
  let dragOffsetY = 0;
  function startDrag(event) {
    const widget = document.getElementById('chatWidget');
    dragOffsetX = event.clientX - widget.offsetLeft;
    dragOffsetY = event.clientY - widget.offsetTop;
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', endDrag);
  }
  function onDragMove(event) {
    const widget = document.getElementById('chatWidget');
    widget.style.left = (event.clientX - dragOffsetX) + 'px';
    widget.style.top  = (event.clientY - dragOffsetY) + 'px';
    widget.style.right = 'auto';
    widget.style.bottom = 'auto';
  }
  function endDrag() {
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', endDrag);
  }
  // Initialize chat histories and UI on DOM load
  document.addEventListener('DOMContentLoaded', () => {
    loadChatHistories();
    updateTabUI();
    renderSessionOptions();
  });
  </script>
</body>
</html>