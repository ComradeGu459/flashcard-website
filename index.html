<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç§‘å­¦é—ªå¡èƒŒè¯µç³»ç»Ÿ Pro | å…¬å…±ç®¡ç†è€ƒç ”ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="ä¸“ä¸ºå…¬å…±ç®¡ç†è€ƒç ”è®¾è®¡çš„é—´éš”é‡å¤è®°å¿†ç³»ç»Ÿ">
  
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #e0e7ff;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      
      /* å¡ç‰‡èƒŒé¢ä¸“ç”¨é…è‰² */
      --card-paper: #ffffff;
      --card-ink: #334155;
      --highlight-bg: rgba(253, 224, 71, 0.4);
      --highlight-text: #000000;

      /* å­—ä½“å¤§å°å˜é‡ */
      --fs-card-answer: 1rem; 
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden; 
      font-size: 16px; 
    }

    /* å¸ƒå±€æ¡†æ¶ */
    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      height: 100vh;
      max-width: 1800px;
      margin: 0 auto;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
      z-index: 10;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ä¸­é—´å¡ç‰‡ç½‘æ ¼ */
    .main-content {
      padding: 24px;
      overflow-y: auto;
      background: var(--bg-body);
      position: relative;
    }
    
    .content-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--bg-body);
      padding-bottom: 10px;
    }

    .flashcard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      padding-bottom: 80px;
    }

    /* å³ä¾§å·¥å…·æ  */
    .tools-panel {
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px; 
    }

    .tool-module {
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e2e8f0;
    }
    
    .tool-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ç•ªèŒ„é’Ÿç­‰ç»„ä»¶æ ·å¼ */
    .pomodoro-timer { text-align: center; padding: 10px 0; }
    .timer-display { font-size: 2.5rem; font-weight: 800; color: var(--primary); font-family: monospace; margin-bottom: 10px; }
    .timer-controls { display: flex; justify-content: center; gap: 10px; }

    .daily-progress-container { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .progress-ring-mini { width: 60px; height: 60px; border-radius: 50%; background: conic-gradient(var(--primary) 0%, #e2e8f0 0%); display: flex; align-items: center; justify-content: center; position: relative; }
    .progress-ring-mini::after { content: ''; position: absolute; width: 48px; height: 48px; background: #f8fafc; border-radius: 50%; }
    .progress-text-mini { position: relative; z-index: 2; font-size: 0.8rem; font-weight: bold; color: var(--primary); }

    .interactive-stat { display: flex; justify-content: space-between; gap: 8px; }
    .stat-block { flex: 1; background: white; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; }
    .stat-block:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
    .sb-val { font-size: 1.2rem; font-weight: 800; color: var(--text-main); }
    .sb-lbl { font-size: 0.75rem; color: var(--text-sub); }

    .note-area { width: 100%; height: 120px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; font-size: 0.9rem; resize: vertical; background: white; transition: border-color 0.2s; }
    .note-area:focus { border-color: var(--primary); outline: none; }
    .note-actions { display: flex; justify-content: flex-end; margin-top: 8px; }

    /* é€šç”¨ç»„ä»¶æ ·å¼ */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 16px; border-radius: 8px; border: 1px solid transparent; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; user-select: none; }
    .btn-sm { padding: 4px 12px; font-size: 0.85rem; }
    .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-secondary { background: var(--primary-light); color: var(--primary-dark); border-color: var(--primary-light); }
    .btn-secondary:hover { background: #c7d2fe; }
    .btn-ghost { background: transparent; color: var(--text-sub); border-color: transparent; }
    .btn-ghost:hover { background: #f1f5f9; }
    .btn-danger { background: #fee2e2; color: var(--danger); }
    .btn-danger:hover { background: #fecaca; }
    .btn-block { width: 100%; }

    .input-group { position: relative; margin-bottom: 12px; }
    .input-field { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-body); transition: border-color 0.2s; font-size: 1rem; }
    .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
    select.input-field { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 30px; }

    /* ä¾§è¾¹æ åˆ†ç±» */
    .nav-section { margin-bottom: 20px; }
    .nav-title { font-size: 0.85rem; color: var(--text-sub); font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-item { display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: var(--text-main); margin-bottom: 4px; transition: background 0.2s; position: relative; }
    .nav-item:hover { background: var(--bg-body); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-item i { margin-right: 8px; font-style: normal; width: 20px; text-align: center; }
    .count-badge { margin-left: auto; background: #e2e8f0; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; }
    
    /* äºŒçº§åˆ†ç±» */
    .nav-sub-group { margin-left: 28px; border-left: 2px solid #e2e8f0; padding-left: 8px; display: none; }
    .nav-sub-group.open { display: block; }
    .nav-sub-item { padding: 6px 8px; font-size: 0.9rem; color: var(--text-sub); cursor: pointer; border-radius: 4px; margin-bottom: 2px; }
    .nav-sub-item:hover { background: var(--bg-body); color: var(--text-main); }
    .nav-expand-icon { font-size: 0.7rem; color: #94a3b8; margin-right: 4px; transition: transform 0.2s; }
    .nav-item.expanded .nav-expand-icon { transform: rotate(90deg); }

    /* é—ªå¡åˆ—è¡¨ */
    .card-thumb { background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); transition: all 0.2s ease; position: relative; display: flex; flex-direction: column; min-height: 160px; cursor: pointer; }
    .card-thumb:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--primary-light); }
    .card-thumb .card-meta { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 4px 8px; border-radius: 4px; }
    .card-thumb .card-title { font-weight: 600; font-size: 1.1rem; line-height: 1.5; color: var(--text-main); flex: 1; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 12px; }
    .card-thumb .card-tags { margin-top: auto; display: flex; flex-wrap: wrap; gap: 4px; }
    .tag-pill { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--bg-body); color: var(--text-sub); margin-right: 4px; }
    .card-actions { position: absolute; top: 12px; right: 12px; opacity: 0; transition: opacity 0.2s; display: flex; gap: 4px; }
    .card-thumb:hover .card-actions { opacity: 1; }
    .icon-btn { width: 28px; height: 28px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; border: 1px solid #e2e8f0; }
    .icon-btn:hover { background: white; color: var(--primary); border-color: var(--primary); }

    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    .status-new { background: #94a3b8; }
    .status-learning { background: var(--warning); }
    .status-mastered { background: var(--success); }

    /* æ²‰æµ¸å¼å¤ä¹  (Overlay) */
    #review-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s ease; }
    #review-overlay.active { display: flex; animation: fadeIn 0.3s; }
    .review-header { position: absolute; top: 0; left: 0; right: 0; padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 3000; color: white; }
    .review-header .btn-ghost { color: #cbd5e1; } 
    .review-header .btn-ghost:hover { background: rgba(255,255,255,0.1); color: white; }
    .progress-bar-container { flex: 1; max-width: 400px; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; margin: 0 20px; overflow: hidden; }
    .progress-fill { height: 100%; background: #818cf8; width: 0%; transition: width 0.3s; }

    /* 3D ç¿»è½¬å¡ç‰‡ */
    .flip-container { perspective: 1500px; width: 90%; max-width: 720px; height: 70vh; min-height: 400px; margin: 20px; position: relative; }
    .flipper { transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; position: relative; width: 100%; height: 100%; cursor: pointer; will-change: transform; }
    .flipper.flipped { transform: rotateY(180deg); }
    
    .front, .back { backface-visibility: hidden; -webkit-backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 20px; background: var(--card-paper); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); padding: 40px; display: flex; flex-direction: column; transform: translateZ(0); }
    .front { z-index: 2; transform: rotateY(0deg); align-items: center; justify-content: center; text-align: center; background: #ffffff; border-top: 6px solid var(--primary); }
    .back { transform: rotateY(180deg); background: #ffffff; overflow-y: auto; justify-content: flex-start; text-align: left; border-top: 6px solid #10b981; }
    .back.layout-center { justify-content: center; align-items: center; text-align: center; overflow-y: hidden; }
    
    .card-category-label { position: absolute; top: 30px; left: 0; right: 0; text-align: center; color: var(--text-sub); font-weight: 600; font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; }
    .card-bottom-hint { position: absolute; bottom: 30px; left: 0; right: 0; text-align: center; color: #94a3b8; font-size: 0.85rem; opacity: 0.8; }
    .question-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; }
    .card-content-lg { font-size: 1.9rem; font-weight: 800; color: #1e293b; line-height: 1.4; margin-bottom: 15px; letter-spacing: -0.5px; }
    .card-clue { color: #64748b; font-style: italic; font-size: 1.05rem; margin-top: 10px; }
    
    /* ç­”æ¡ˆå†…å®¹ä¸»å®¹å™¨ - æ ¸å¿ƒç­”æ¡ˆéƒ¨åˆ† */
    .answer-main { width: 100%; font-size: var(--fs-card-answer); line-height: 1.85; color: #334155; transition: font-size 0.2s; }
    .answer-main.text-xl { font-size: calc(var(--fs-card-answer) * 2.4); line-height: 1.3; font-weight: 700; text-align: center; color: #0f172a; }
    .answer-main.text-lg { font-size: calc(var(--fs-card-answer) * 1.8); line-height: 1.5; font-weight: 600; text-align: center; }
    .answer-main.text-md { font-size: calc(var(--fs-card-answer) * 1.3); line-height: 1.6; text-align: center; }
    .answer-main.text-sm { font-size: var(--fs-card-answer); text-align: left; }
    .answer-main p { margin-bottom: 1em; }
    .answer-main strong { color: var(--highlight-text); background: linear-gradient(to top, var(--highlight-bg) 40%, transparent 40%); padding: 0 2px; font-weight: 700; }
    .answer-main ul { padding-left: 1.4em; margin-bottom: 1em; display: inline-block; text-align: left; width: auto; max-width: 100%; }
    .answer-main.text-sm ul { display: block; }

    /* æ‹“å±•å†…å®¹ (æ·±åº¦è§£æ/è‹±è¯­ç§¯ç´¯) - å¼±åŒ–æ ·å¼ */
    .answer-extend { 
      margin-top: 20px; 
      padding-top: 15px; 
      border-top: 1px dashed #cbd5e1; 
      font-size: 0.9rem; 
      color: #64748b; 
      background: #f8fafc; 
      padding: 15px; 
      border-radius: 8px; 
      text-align: left; /* å¼ºåˆ¶å·¦å¯¹é½ */
      line-height: 1.6;
    }
    .answer-extend h1, .answer-extend h2, .answer-extend h3 {
        font-size: 1rem;
        color: #475569;
        margin-top: 5px;
        margin-bottom: 8px;
        font-weight: 700;
    }
    .answer-extend p { margin-bottom: 0.8em; }
    
    .review-controls { margin-top: 20px; display: flex; gap: 15px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .review-controls.visible { opacity: 1; pointer-events: auto; }
    .grade-btn { padding: 14px 24px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); flex: 1; font-size: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .grade-btn:active { transform: scale(0.96); }
    .grade-1 { background: linear-gradient(145deg, #ef4444, #b91c1c); }
    .grade-2 { background: linear-gradient(145deg, #f59e0b, #b45309); }
    .grade-3 { background: linear-gradient(145deg, #3b82f6, #1d4ed8); }
    .grade-4 { background: linear-gradient(145deg, #10b981, #047857); }

    /* Chat */
    .chat-widget { position: fixed; bottom: 90px; right: 20px; width: 400px; height: 600px; background: white; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.1); display: none; flex-direction: column; z-index: 1500; border: 1px solid var(--border); overflow: hidden; resize: both; min-width: 320px; min-height: 400px; max-width: 90vw; max-height: 90vh; }
    .chat-header { background: var(--primary); color: white; padding: 12px 16px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    .chat-body { flex: 1; padding: 16px; overflow-y: auto; background: #f8fafc; font-size: 0.95rem; }
    .chat-footer { position: relative; padding: 12px; border-top: 1px solid var(--border); background: white; display: flex; gap: 8px; z-index: 5; }
    .chat-settings { padding: 8px 12px; background: #f1f5f9; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; }
    .msg { margin-bottom: 12px; max-width: 85%; padding: 10px 14px; border-radius: 12px; line-height: 1.6; word-wrap: break-word; }
    .msg.user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; white-space: pre-wrap; }
    .msg.ai { background: white; border: 1px solid var(--border); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 2px; }
    .msg strong { color: #b91c1c; }

    .countdown-container { margin-top: auto; text-align: center; color: var(--text-sub); font-size: 0.85rem; background: #f1f5f9; border-radius: 8px; padding: 10px; cursor: pointer; }
    .countdown-container:hover { background: #e2e8f0; }

    /* Manage Modal */
    .manage-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
    .manage-tab { padding: 8px 16px; cursor: pointer; color: var(--text-sub); font-weight: 500; }
    .manage-tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    .manage-list { list-style: none; padding: 0; margin: 0; }
    .manage-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #f1f5f9; background: white; }
    .manage-item:hover { background: #f8fafc; }
    .manage-tag-group { background: #fff; border-radius: 8px; padding: 0; margin-bottom: 12px; border: 1px solid var(--border); overflow: hidden; }
    .manage-tag-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f1f5f9; font-weight: 600; color: var(--primary-dark); }
    .check-box-wrapper { display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; }
    .item-checkbox { width: 16px; height: 16px; cursor: pointer; }

    @media (max-width: 1024px) { .app-container { grid-template-columns: 240px 1fr; } .tools-panel { display: none; } }
    @media (max-width: 768px) { .app-container { grid-template-columns: 1fr; } .sidebar { position: fixed; left: -100%; top: 0; bottom: 0; width: 80%; box-shadow: var(--shadow-lg); z-index: 100; } .sidebar.open { left: 0; } .mobile-nav-toggle { display: block; position: fixed; top: 16px; left: 16px; z-index: 90; background: white; padding: 8px; border-radius: 8px; box-shadow: var(--shadow-md); } .flip-container { width: 95%; height: 50vh; } .chat-widget { width: 90%; right: 5%; bottom: 20px; height: 60vh; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
<div class="mobile-nav-toggle btn" onclick="toggleSidebar()" style="display:none;">
  <span style="font-size:1.2rem;">â˜°</span>
</div>

<div class="app-container">
  <!-- å·¦ä¾§è¾¹æ  -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span>ğŸ“š ç§‘å­¦é—ªå¡ Pro</span>
      <span style="font-size:0.8rem; color:var(--text-sub); background:#f1f5f9; padding:2px 6px; border-radius:4px;">MPA</span>
    </div>

    <div class="input-group">
      <input type="text" class="input-field" placeholder="æœç´¢çŸ¥è¯†ç‚¹..." oninput="filterCards(this.value)">
    </div>

    <div class="nav-section">
      <div class="nav-title">å­¦ä¹ æ¨¡å¼</div>
      <div class="nav-item active" id="nav-all" onclick="resetFilter()">
        <i>ğŸ—‚ï¸</i> å…¨éƒ¨å¡ç‰‡ <span class="count-badge" id="count-total">0</span>
      </div>
      <div class="nav-item" id="nav-review" onclick="startSmartReview()">
        <i>ğŸ¯</i> æ™ºèƒ½æ¨è <span class="count-badge" style="background:var(--primary); color:white;" id="count-due">0</span>
      </div>
      <div class="nav-item" onclick="filterByStatus('wrong')">
        <i>ğŸ“•</i> é”™é¢˜æœ¬ <span class="count-badge" id="count-wrong">0</span>
      </div>
      <div class="nav-item" onclick="filterByStatus('high_freq')">
        <i>â­</i> é«˜é¢‘è€ƒç‚¹
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-title">ğŸ“š ç§‘ç›®åˆ†ç±» (æ”¯æŒäºŒçº§)</div>
      <div id="subject-list"></div>
    </div>

    <div class="nav-section">
      <div class="nav-title">ç³»ç»Ÿè®¾ç½®</div>
      <button class="btn btn-secondary btn-block" onclick="showSettingsModal()">âš™ï¸ åå¥½è®¾ç½® (ç­”æ¡ˆå­—å·/å€’è®¡æ—¶)</button>
    </div>

    <div class="nav-section" style="margin-top:auto;">
      <div class="nav-title">å¿«æ·æ“ä½œ</div>
      <button class="btn btn-primary btn-block" onclick="addNewCard()" style="margin-bottom:8px;">+ æ–°å»ºå¡ç‰‡</button>
      <button class="btn btn-secondary btn-block" onclick="showManageModal()" style="margin-bottom:8px;">ğŸ”§ ç®¡ç†é¢˜åº“</button>
      <button class="btn btn-ghost btn-block" onclick="showImportModal()">ğŸ“¥ å¯¼å…¥é¢˜åº“</button>
      <button class="btn btn-ghost btn-block" onclick="exportCards()">ğŸ“¤ å¤‡ä»½æ•°æ®</button>
    </div>
    
    <div id="countdown-box" class="countdown-container" onclick="showSettingsModal()" title="ç‚¹å‡»è®¾ç½®å€’è®¡æ—¶">
      <div id="countdown-title">è·ç¦»è€ƒç ”</div>
      <div style="font-size:1.4rem; font-weight:800; color:var(--primary);" id="countdown-days">--</div>
      <div>å¤©</div>
    </div>
  </div>

  <!-- ä¸­é—´ä¸»å†…å®¹ -->
  <div class="main-content">
    <div class="content-header">
      <h2 style="margin:0; font-size:1.5rem;" id="grid-title">å…¨éƒ¨å¡ç‰‡</h2>
      
      <div style="display:flex; gap:10px; align-items:center;">
        <!-- æ’åºåŠŸèƒ½ -->
        <select id="sort-select" class="input-field" style="padding:6px 30px 6px 12px; font-size:0.9rem; width:auto;" onchange="sortCards(this.value)">
          <option value="smart">ğŸ§  æ™ºèƒ½é—å¿˜æ›²çº¿ (é»˜è®¤)</option>
          <option value="mastery_asc">ğŸ“‰ ç†Ÿç»ƒåº¦ (ä½â†’é«˜)</option>
          <option value="count_desc">ğŸ”¥ å­¦ä¹ çƒ­åº¦ (å¤šâ†’å°‘)</option>
          <option value="newest">ğŸ†• æœ€è¿‘æ·»åŠ </option>
        </select>
        
        <!-- è¿ç»­å­¦ä¹ æŒ‰é’® (åŠ¨æ€æ˜¾ç¤º) -->
        <button id="btn-start-session" class="btn btn-primary" onclick="startContinuousSession()" style="display:none;">
          â–¶ï¸ å­¦ä¹ æ­¤åˆ—è¡¨
        </button>
        
        <button class="btn btn-secondary" onclick="shuffleGrid()" title="æ‰“ä¹±é¡ºåº">ğŸ”€ ä¹±åº</button>
      </div>
    </div>
    
    <div class="flashcard-grid" id="grid"></div>
    
    <div id="empty-state" style="display:none; text-align:center; padding:60px; color:var(--text-sub);">
      <div style="font-size:3rem; margin-bottom:20px;">ğŸƒ</div>
      <p>æš‚æ— å¡ç‰‡ï¼Œå¿«å»æ·»åŠ æˆ–è®© AI ç”Ÿæˆå§ï¼</p>
    </div>
  </div>

  <!-- å³ä¾§æ•°æ®æ  -->
  <div class="tools-panel">
    <div class="tool-module">
      <div class="tool-title">ğŸ… ä¸“æ³¨ç•ªèŒ„é’Ÿ</div>
      <div class="pomodoro-timer">
        <div class="timer-display" id="pomodoro-time">25:00</div>
        <div class="timer-controls">
          <button class="btn btn-primary btn-sm" id="btn-pomo-start" onclick="togglePomodoro()">å¼€å§‹</button>
          <button class="btn btn-ghost btn-sm" onclick="resetPomodoro()">é‡ç½®</button>
        </div>
      </div>
    </div>

    <div class="tool-module">
      <div class="tool-title">
        ğŸ“Š å­¦ä¹ çŠ¶æ€
        <span style="font-size:0.8rem;font-weight:normal;color:#f59e0b;">ğŸ”¥ <span id="stat-streak">0</span> å¤©</span>
      </div>
      <div class="daily-progress-container" style="margin-bottom:15px;">
        <div class="progress-ring-mini" id="daily-ring" style="--percent:0%;">
          <span class="progress-text-mini" id="stat-today-goal">0%</span>
        </div>
        <div>
          <div style="font-size:0.85rem;color:var(--text-sub);">ä»Šæ—¥ç›®æ ‡: 20å¼ </div>
          <div style="font-weight:bold;font-size:1rem;">å·²å­¦ <span id="stat-today-val">0</span> å¼ </div>
        </div>
      </div>
      
      <div class="interactive-stat">
        <div class="stat-block" onclick="filterCardsByMastery(4)" title="ç‚¹å‡»æŸ¥çœ‹å·²æŒæ¡å¡ç‰‡">
          <div class="sb-val" id="stat-mastered">0</div>
          <div class="sb-lbl">å·²æŒæ¡ ğŸŸ¢</div>
        </div>
        <div class="stat-block" onclick="filterCardsByMastery(1)" title="ç‚¹å‡»æŸ¥çœ‹å­¦ä¹ ä¸­å¡ç‰‡">
          <div class="sb-val" id="stat-learning">0</div>
          <div class="sb-lbl">å­¦ä¹ ä¸­ ğŸ”´</div>
        </div>
      </div>
    </div>

    <div class="tool-module">
      <div class="tool-title">ğŸ“ éšæ‰‹è®° (çµæ„Ÿ)</div>
      <textarea id="quick-note" class="note-area" placeholder="è®°ä¸‹ç¨çºµå³é€çš„æƒ³æ³•..." oninput="saveNote()"></textarea>
      <div class="note-actions">
        <button class="btn btn-secondary btn-sm" onclick="convertNoteToCard()" title="å°†å½“å‰ç¬”è®°å†…å®¹è½¬åŒ–ä¸ºæ–°é—ªå¡">âœ¨ è½¬ä¸ºé—ªå¡</button>
      </div>
    </div>
  </div>
</div>

<!-- æ²‰æµ¸å¼å¤ä¹ ç•Œé¢ -->
<div id="review-overlay" onclick="handleOverlayClick(event)">
  <div class="review-header">
    <button class="btn btn-ghost" onclick="endReview()">âœ• é€€å‡º</button>
    <div class="progress-bar-container">
      <div class="progress-fill" id="review-progress"></div>
    </div>
    <span style="font-weight:bold; color:var(--text-sub);" id="review-counter">0/0</span>
  </div>
  <div class="flip-container" onclick="flipCard()">
    <div class="flipper" id="review-card-flipper">
      <div class="front">
        <div class="card-category-label" id="review-category"></div>
        <div class="question-wrapper">
            <div class="card-content-lg" id="review-front"></div>
            <div class="card-clue" id="review-clue"></div>
        </div>
        <div class="card-bottom-hint">(ç‚¹å‡»ç¿»çœ‹ç­”æ¡ˆ)</div>
      </div>
      <div class="back" id="review-back-container"></div>
    </div>
  </div>
  <div class="review-controls" id="review-controls">
    <button class="grade-btn grade-1" onclick="rateCard(1)">å¿˜è®° (1)</button>
    <button class="grade-btn grade-2" onclick="rateCard(2)">å›°éš¾ (2)</button>
    <button class="grade-btn grade-3" onclick="rateCard(3)">è‰¯å¥½ (3)</button>
    <button class="grade-btn grade-4" onclick="rateCard(4)">ç®€å• (4)</button>
  </div>
</div>

<!-- èŠå¤©æ‚¬æµ®çƒä¸çª—å£ -->
<button onclick="toggleChat()" style="position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:30px; background:var(--primary); color:white; border:none; box-shadow:var(--shadow-lg); cursor:pointer; z-index:1400; font-size:1.5rem;">ğŸ¤–</button>

<div class="chat-widget" id="chat-widget">
  <div class="chat-header" onmousedown="dragChat(event)">
    <span>ğŸ“ è€ƒç ”ä¼´å­¦ AI (ä¸“ä¸šç‰ˆ)</span>
    <div style="display:flex; gap:10px; align-items:center;">
      <span style="cursor:pointer; font-size:1.2rem;" onclick="clearChatHistory()" title="æ¸…ç©ºè®°å½•">ğŸ—‘ï¸</span>
      <span style="cursor:pointer" onclick="toggleChat()">âœ•</span>
    </div>
  </div>
  <div class="chat-settings">
    <span style="font-size:0.8rem;">æ¨¡å‹:</span>
    <select id="api-provider" class="input-field" style="padding:4px 24px 4px 8px; font-size:0.8rem; height:auto; width:auto;" onchange="updateApiProvider()">
      <option value="deepseek">DeepSeek V3</option>
      <option value="gemini">Google Gemini</option>
    </select>
  </div>
  <div class="chat-body" id="chat-body">
    <div class="msg ai">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±è€ƒç ”å¯¼å¸ˆã€‚æˆ‘ä¸“æ³¨äºå…¬å…±ç®¡ç†ä¸“ä¸šè¯¾çš„æ·±åº¦è§£æä¸å¡ç‰‡ç”Ÿæˆã€‚è¯·åœ¨ä¸Šæ–¹è®¾ç½® API Key å¼€å§‹ä½¿ç”¨ã€‚</div>
  </div>
  <div class="chat-footer">
    <input type="text" id="chat-input" class="input-field" style="margin:0;" placeholder="è¾“å…¥å†…å®¹... (Enterå‘é€)" onkeydown="if(event.key==='Enter') sendMessage()">
    <button class="btn btn-primary" onclick="sendMessage()">å‘é€</button>
  </div>
  <div style="padding:8px 12px 12px; background:white; text-align:right; border-top:1px solid #f1f5f9; position:relative; z-index:10;">
     <button class="btn btn-ghost btn-sm" id="btn-set-key" onclick="setApiKey()">ğŸ”‘ è®¾ç½® API Key</button>
  </div>
</div>

<!-- é€šç”¨æ¨¡æ€æ¡† -->
<div id="modal-root" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
  <div style="background:white; padding:24px; border-radius:12px; width:90%; max-width:600px; max-height:85vh; overflow-y:auto; box-shadow:var(--shadow-lg); display:flex; flex-direction:column;">
    <h3 id="modal-title" style="margin-top:0;">æ ‡é¢˜</h3>
    <div id="modal-content" style="flex:1; overflow-y:auto;"></div>
    <div style="margin-top:20px; text-align:right; border-top:1px solid #f1f5f9; padding-top:12px;">
      <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = 'mpa_flashcards_pro';
const STATS_KEY = 'mpa_stats_pro';
const NOTES_KEY = 'mpa_quick_notes';
const SETTINGS_KEY = 'mpa_settings_v1';
const CHAT_HISTORY_KEY = 'mpa_chat_history_v1';

const API_CONFIG = {
  deepseek: { name: 'DeepSeek', storageKey: 'deepseek_api_key', url: 'https://api.deepseek.com/chat/completions' },
  gemini: { name: 'Gemini', storageKey: 'gemini_api_key', url: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent' }
};
let currentProvider = 'deepseek';

let cards = [], reviewQueue = [], currentReviewIndex = 0, currentFilter = 'all', manageViewMode = 'subject', chatHistory = [];
let appSettings = { cardFontSize: 'normal', examName: 'ç ”ç©¶ç”Ÿè€ƒè¯•', examDate: new Date(new Date().getFullYear(), 11, 21).toISOString().split('T')[0] };

let currentDisplayCards = [];
let pomoTimer = null, pomoTimeLeft = 1500, isPomoRunning = false;

function initData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    cards = raw ? JSON.parse(raw) : getInitialData();
    cards.forEach(c => { if (!c.tags) c.tags = []; if (!c.category) c.category = "æœªåˆ†ç±»"; if (!c.fs) c.fs = 2.5; if (!c.interval) c.interval = 0; if (!c.reviewCount) c.reviewCount = 0; });
    const rawSettings = localStorage.getItem(SETTINGS_KEY);
    if(rawSettings) appSettings = JSON.parse(rawSettings);
    const rawChat = localStorage.getItem(CHAT_HISTORY_KEY);
    if (rawChat) { chatHistory = JSON.parse(rawChat); renderChatHistory(); }
  } catch (e) { console.error("Data error", e); cards = getInitialData(); }
  applySettings(); updateStats(); updateSubjectList(); renderGrid(); loadNote();
  const savedProvider = localStorage.getItem('preferred_api_provider');
  if (savedProvider && API_CONFIG[savedProvider]) { document.getElementById('api-provider').value = savedProvider; updateApiProvider(); }
}

function getInitialData() {
  return [{
    id: Date.now(),
    front: "å…¬å…±ç®¡ç†çš„æ ¸å¿ƒä¸»ä½“æ˜¯ä»€ä¹ˆï¼Ÿ",
    back: "**æ”¿åºœ**æ˜¯å…¬å…±ç®¡ç†çš„æ ¸å¿ƒä¸»ä½“ã€‚\n\n1. æ”¿åºœæ‹¥æœ‰åˆæ³•çš„å¼ºåˆ¶åŠ›ã€‚\n2. åŒæ—¶ä¹ŸåŒ…æ‹¬éæ”¿åºœå…¬å…±ç»„ç»‡ï¼ˆNGO/NPOï¼‰ã€‚\n### æ·±åº¦è§£æ\næ”¿åºœçš„ä¸»å¯¼åœ°ä½æºäºå…¶å…¬å…±æƒåŠ›çš„åˆæ³•æ€§ã€‚",
    category: "å…¬å…±ç®¡ç†å­¦/åŸºç¡€ç†è®º", tags: ["åŸºç¡€", "æ ¸å¿ƒæ¦‚å¿µ", "é«˜é¢‘"], nextReview: new Date().toISOString(), mastery: 0, interval: 0, fs: 2.5, reviewCount: 0
  }];
}

function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(cards)); updateStats(); updateSubjectList(); }
function saveSettings() { localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings)); applySettings(); }

function applySettings() {
  const root = document.documentElement;
  if(appSettings.cardFontSize === 'medium') root.style.setProperty('--fs-card-answer', '1.2rem');
  else if(appSettings.cardFontSize === 'large') root.style.setProperty('--fs-card-answer', '1.4rem');
  else root.style.setProperty('--fs-card-answer', '1rem');
  document.getElementById('countdown-title').textContent = `è·ç¦»${appSettings.examName}`;
  const now = new Date(), target = new Date(appSettings.examDate), diff = Math.ceil((target - now) / 86400000);
  document.getElementById('countdown-days').textContent = diff > 0 ? diff : 0;
}

function updateSubjectList() {
  const tree = {}; 
  cards.forEach(c => {
    const cat = c.category || "æœªåˆ†ç±»";
    // æ ¸å¿ƒé€»è¾‘ï¼šä¸€çº§ä¸ºç¬¬ä¸€æ®µï¼ŒäºŒçº§ä¸ºå‰©ä½™æ‰€æœ‰æ®µ
    const firstSplit = cat.indexOf('/');
    let mainCat = cat, subCat = null;
    if (firstSplit !== -1) {
        mainCat = cat.substring(0, firstSplit).trim();
        subCat = cat.substring(firstSplit + 1).trim();
    } else if (cat.indexOf('-') !== -1) {
        // å…¼å®¹è¿å­—ç¬¦
        const parts = cat.split('-');
        mainCat = parts[0].trim();
        subCat = parts.slice(1).join('-').trim();
    }

    if (!tree[mainCat]) tree[mainCat] = { count: 0, subs: {} };
    tree[mainCat].count++;
    if (subCat) {
        if (!tree[mainCat].subs[subCat]) tree[mainCat].subs[subCat] = 0;
        tree[mainCat].subs[subCat]++;
    }
  });
  const listEl = document.getElementById('subject-list');
  listEl.innerHTML = '';
  Object.keys(tree).sort().forEach(main => {
    const item = tree[main];
    const hasSubs = Object.keys(item.subs).length > 0;
    const div = document.createElement('div'); div.className = 'nav-item-group';
    const header = document.createElement('div'); header.className = 'nav-item';
    header.onclick = () => { filterBySubject(main); if(hasSubs) { document.getElementById(`sub-${main}`).classList.toggle('open'); header.classList.toggle('expanded'); } };
    let arrow = hasSubs ? `<span class="nav-expand-icon">â–¶</span>` : `<span style="width:14px;"></span>`;
    header.innerHTML = `${arrow} <i>ğŸ“–</i> ${main} <span class="count-badge">${item.count}</span>`;
    div.appendChild(header);
    if(hasSubs) {
        const subGroup = document.createElement('div'); subGroup.id = `sub-${main}`; subGroup.className = 'nav-sub-group';
        Object.keys(item.subs).sort().forEach(sub => {
            const subDiv = document.createElement('div'); subDiv.className = 'nav-sub-item';
            subDiv.innerHTML = `${sub} <span style="float:right;opacity:0.6;font-size:0.75rem;">${item.subs[sub]}</span>`;
            subDiv.onclick = (e) => { e.stopPropagation(); filterBySubject(`${main}/${sub}`); };
            subGroup.appendChild(subDiv);
        });
        div.appendChild(subGroup);
    }
    listEl.appendChild(div);
  });
}

function renderGrid(sourceCards = null) {
  if (sourceCards) { currentDisplayCards = sourceCards; } else {
      if (currentFilter === 'all') currentDisplayCards = cards;
      else if (currentFilter === 'wrong') currentDisplayCards = cards.filter(c => c.mastery < 2 && c.interval > 0);
      else if (currentFilter === 'high_freq') currentDisplayCards = cards.filter(c => (c.tags||[]).includes("é«˜é¢‘"));
      else if (currentFilter.startsWith('subject:')) {
          const targetSubject = currentFilter.split(':')[1];
          // ä¿®æ­£åŒ¹é…é€»è¾‘ï¼šåŒ¹é… "æ”¿æ²»" æˆ– "æ”¿æ²»/é©¬åŸ"
          currentDisplayCards = cards.filter(c => { 
              const cat = (c.category || "æœªåˆ†ç±»").replace(/-/g, '/'); 
              return cat === targetSubject || cat.startsWith(targetSubject + '/'); 
          });
      }
  }
  const sortMode = document.getElementById('sort-select').value;
  if (sortMode === 'mastery_asc') currentDisplayCards.sort((a, b) => a.mastery - b.mastery);
  else if (sortMode === 'count_desc') currentDisplayCards.sort((a, b) => (b.reviewCount||0) - (a.reviewCount||0));
  else if (sortMode === 'newest') currentDisplayCards.sort((a, b) => b.id - a.id);
  else currentDisplayCards.sort((a, b) => new Date(a.nextReview) - new Date(b.nextReview));

  const grid = document.getElementById('grid'); grid.innerHTML = '';
  const titleEl = document.getElementById('grid-title'); const startBtn = document.getElementById('btn-start-session');
  
  if (currentFilter.startsWith('subject:')) { titleEl.textContent = currentFilter.split(':')[1]; startBtn.style.display = 'inline-flex'; startBtn.textContent = `â–¶ï¸ å­¦ä¹ æ­¤åˆ—è¡¨ (${currentDisplayCards.length})`; } 
  else if (currentFilter === 'wrong') { titleEl.textContent = "é”™é¢˜æœ¬"; startBtn.style.display = 'inline-flex'; startBtn.textContent = `â–¶ï¸ é‡åˆ·é”™é¢˜ (${currentDisplayCards.length})`; } 
  else { titleEl.textContent = "å…¨éƒ¨å¡ç‰‡"; startBtn.style.display = 'none'; }

  if (currentDisplayCards.length === 0) { document.getElementById('empty-state').style.display = 'block'; return; }
  document.getElementById('empty-state').style.display = 'none';

  currentDisplayCards.forEach(card => {
    const el = document.createElement('div'); el.className = 'card-thumb'; el.onclick = () => previewSingleCard(card.id);
    let statusClass = card.mastery >= 4 ? 'status-mastered' : (card.interval > 0 ? 'status-learning' : 'status-new');
    const catBadge = card.category ? `<span class="tag-pill" style="background:#f3f4f6;color:#4b5563;">${card.category}</span>` : '';
    const tagsHtml = card.tags.slice(0,3).map(t => `<span class="tag-pill" style="${t==='é«˜é¢‘'?'background:#fef3c7;color:#d97706;':''}">${t}</span>`).join('');
    const nextDate = new Date(card.nextReview);
    const isDue = nextDate <= new Date();
    const dueText = isDue ? `<span style="color:#ef4444;font-weight:bold;">å¾…å¤ä¹ </span>` : `${nextDate.getMonth()+1}/${nextDate.getDate()}`;
    el.innerHTML = `
      <div class="card-actions"><div class="icon-btn" title="ç¼–è¾‘" onclick="event.stopPropagation(); editCard(${card.id})">âœ</div></div>
      <div class="card-meta"><span><span class="status-dot ${statusClass}"></span>${dueText}</span><span style="font-size:0.7rem;opacity:0.8;">å¤ä¹ :${card.reviewCount||0} | ç†Ÿç»ƒ:${card.mastery}</span></div>
      <div class="card-title">${escapeHtml(card.front)}</div>
      <div class="card-tags">${catBadge} ${tagsHtml}</div>`;
    grid.appendChild(el);
  });
  updateSidebarCounts();
}

function togglePomodoro() {
  if (isPomoRunning) {
    clearInterval(pomoTimer); isPomoRunning = false;
    document.getElementById('btn-pomo-start').textContent = "å¼€å§‹";
  } else {
    pomoTimer = setInterval(() => {
      pomoTimeLeft--;
      if (pomoTimeLeft <= 0) {
        clearInterval(pomoTimer); isPomoRunning = false;
        alert("ğŸ… ç•ªèŒ„é’Ÿç»“æŸï¼ä¼‘æ¯ä¸€ä¸‹å§ã€‚");
        pomoTimeLeft = 1500;
        document.getElementById('btn-pomo-start').textContent = "å¼€å§‹";
      }
      updatePomoDisplay();
    }, 1000);
    isPomoRunning = true;
    document.getElementById('btn-pomo-start').textContent = "æš‚åœ";
  }
}
function resetPomodoro() {
  clearInterval(pomoTimer); isPomoRunning = false; pomoTimeLeft = 1500;
  updatePomoDisplay(); document.getElementById('btn-pomo-start').textContent = "å¼€å§‹";
}
function updatePomoDisplay() {
  const m = Math.floor(pomoTimeLeft / 60).toString().padStart(2, '0');
  const s = (pomoTimeLeft % 60).toString().padStart(2, '0');
  document.getElementById('pomodoro-time').textContent = `${m}:${s}`;
}

function filterCardsByMastery(level) {
  if (level === 4) { renderGrid(cards.filter(c => c.mastery >= 4)); alert("å·²ç­›é€‰ã€å·²æŒæ¡ã€‘çš„å¡ç‰‡"); } 
  else { renderGrid(cards.filter(c => c.interval > 0 && c.mastery < 4)); alert("å·²ç­›é€‰ã€å­¦ä¹ ä¸­ã€‘çš„éš¾ç‚¹å¡ç‰‡"); }
}

function convertNoteToCard() {
  const content = document.getElementById('quick-note').value.trim();
  if (!content) return alert("ç¬”è®°æ˜¯ç©ºçš„ï¼Œæ— æ³•è½¬æ¢ï¼");
  const parts = content.split(/[:ï¼š?ï¼Ÿ\n]/);
  const front = parts[0] || "æœªå‘½åé—®é¢˜";
  const back = content.substring(front.length + 1) || content;
  cards.unshift({ id: Date.now(), front: front.trim(), back: back.trim(), category: "ç¬”è®°è½¬åŒ–", tags: ["è‡ªå»º"], nextReview: new Date().toISOString(), mastery: 0, interval: 0, fs: 2.5 });
  saveData(); renderGrid();
  document.getElementById('quick-note').value = ""; 
  saveNote();
  alert("âœ¨ å·²å°†ç¬”è®°è½¬åŒ–ä¸ºé—ªå¡ï¼");
}

function sortCards() { renderGrid(currentDisplayCards); }
function startSmartReview() {
  const now = new Date(); reviewQueue = cards.filter(c => new Date(c.nextReview) <= now).sort((a,b) => a.mastery - b.mastery);
  if (reviewQueue.length === 0) { 
      const newCards = cards.filter(c => c.interval === 0).slice(0, 20);
      if (newCards.length > 0 && confirm('ä»Šæ—¥å¾…å¤ä¹ å·²å®Œæˆã€‚å¼€å§‹å­¦ä¹  20 å¼ æ–°å¡ç‰‡ï¼Ÿ')) reviewQueue = newCards; else return alert("å¤ªæ£’äº†ï¼æ‰€æœ‰å¡ç‰‡éƒ½å·²å¤ä¹ å®Œæ¯•ã€‚"); 
  }
  currentReviewIndex = 0; document.getElementById('review-overlay').classList.add('active'); showReviewCard();
}
function startContinuousSession() {
    if (currentDisplayCards.length === 0) return alert("å½“å‰åˆ—è¡¨ä¸ºç©º");
    reviewQueue = [...currentDisplayCards]; currentReviewIndex = 0;
    document.getElementById('review-overlay').classList.add('active'); showReviewCard();
}
function previewSingleCard(id) { const card = cards.find(c => c.id === id); if (!card) return; reviewQueue = [card]; currentReviewIndex = 0; document.getElementById('review-overlay').classList.add('active'); showReviewCard(); }
function shuffleGrid() {
  for (let i = currentDisplayCards.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [currentDisplayCards[i], currentDisplayCards[j]] = [currentDisplayCards[j], currentDisplayCards[i]]; }
  document.getElementById('sort-select').value = 'smart'; renderGrid(currentDisplayCards); alert("ğŸ”€ åˆ—è¡¨å·²æ‰“ä¹±ï¼ç‚¹å‡»â€œå­¦ä¹ æ­¤åˆ—è¡¨â€å³å¯éšæœºæŠ½æŸ¥ã€‚");
}

function updateSidebarCounts() {
  document.getElementById('count-total').textContent = cards.length;
  document.getElementById('count-wrong').textContent = cards.filter(c => c.mastery < 2 && c.interval > 0).length;
  const now = new Date(); document.getElementById('count-due').textContent = cards.filter(c => new Date(c.nextReview) <= now).length;
}

function updateStats() {
  const stats = JSON.parse(localStorage.getItem(STATS_KEY) || '{"streak":0, "lastDate":null, "todayCount":0}');
  const today = new Date().toDateString();
  if (stats.lastDate !== today) { if (stats.lastDate === new Date(Date.now() - 86400000).toDateString()) stats.streak++; else stats.streak = 1; stats.todayCount = 0; stats.lastDate = today; localStorage.setItem(STATS_KEY, JSON.stringify(stats)); }
  
  const streakEl = document.getElementById('stat-streak'); if (streakEl) streakEl.textContent = stats.streak;
  const todayValEl = document.getElementById('stat-today-val'); if (todayValEl) todayValEl.textContent = stats.todayCount;
  const goal = 20;
  const percent = Math.min(100, Math.round((stats.todayCount / goal) * 100));
  document.getElementById('stat-today-goal').textContent = `${percent}%`;
  document.getElementById('daily-ring').style.setProperty('--percent', `${percent}%`);
  document.getElementById('daily-ring').style.background = `conic-gradient(var(--primary) ${percent}%, #e2e8f0 ${percent}% 100%)`;
  document.getElementById('stat-mastered').textContent = cards.filter(c => c.mastery >= 4).length;
  document.getElementById('stat-learning').textContent = cards.filter(c => c.interval > 0 && c.mastery < 4).length;
}

function showReviewCard() {
  if (currentReviewIndex >= reviewQueue.length) { endReview(true); return; }
  const card = reviewQueue[currentReviewIndex];
  document.getElementById('review-card-flipper').classList.remove('flipped');
  document.getElementById('review-controls').classList.remove('visible');
  document.getElementById('review-category').textContent = card.category || 'æœªåˆ†ç±»';
  document.getElementById('review-front').textContent = card.front;
  document.getElementById('review-clue').textContent = card.clue || "";
  
  const backContainer = document.getElementById('review-back-container');
  // åˆ†ç¦»æ ¸å¿ƒä¸æ‹“å±•å†…å®¹
  const rawText = card.back;
  // ä¼˜å…ˆæ£€æŸ¥ ### æˆ– ---
  const splitMarkers = ['###', '---'];
  let mainText = rawText;
  let extendText = '';
  
  for(let marker of splitMarkers) {
      if(rawText.includes(marker)) {
          const parts = rawText.split(marker);
          mainText = parts[0];
          // åˆå¹¶å‰©ä½™éƒ¨åˆ†ä¸ºæ‹“å±•ï¼Œå¹¶è¡¥å›æ ‡è®°ï¼ˆå¦‚æœæ˜¯æ ‡é¢˜ï¼‰
          let rest = parts.slice(1).join(marker);
          if(marker === '###') rest = '### ' + rest;
          extendText = rest;
          break;
      }
  }

  const rawLen = mainText.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim().length;
  const hasComplex = mainText.includes('|'); 
  
  backContainer.className = 'back'; 
  
  let html = `<div class="answer-main">${parseMarkdown(mainText)}</div>`;
  
  // æ™ºèƒ½æ’ç‰ˆé€»è¾‘
  if (rawLen < 50 && !hasComplex) {
      backContainer.classList.add('layout-center');
      html = html.replace('answer-main', 'answer-main text-lg');
  } else if (rawLen < 150 && !hasComplex) {
      backContainer.classList.add('layout-center');
      html = html.replace('answer-main', 'answer-main text-md');
  } else {
      html = html.replace('answer-main', 'answer-main text-sm');
  }
  
  // æ·»åŠ å¼±åŒ–æ˜¾ç¤ºçš„æ‹“å±•å†…å®¹
  if (extendText.trim()) {
      html += `<div class="answer-extend">${parseMarkdown(extendText)}</div>`;
  }
  
  backContainer.innerHTML = html;
  const progress = ((currentReviewIndex) / reviewQueue.length) * 100;
  document.getElementById('review-progress').style.width = `${progress}%`;
  document.getElementById('review-counter').textContent = `${currentReviewIndex + 1}/${reviewQueue.length}`;
}

function flipCard() { const flipper = document.getElementById('review-card-flipper'); if (!flipper.classList.contains('flipped')) { flipper.classList.add('flipped'); setTimeout(() => { document.getElementById('review-controls').classList.add('visible'); }, 300); } }
function handleOverlayClick(e) { if (e.target.id === 'review-overlay') endReview(); }
function rateCard(quality) {
  const card = reviewQueue[currentReviewIndex];
  if (quality >= 3) { card.interval = card.interval === 0 ? 1 : (card.interval === 1 ? 6 : Math.round(card.interval * card.fs)); card.mastery = Math.min(4, card.mastery + 1); } else { card.interval = 1; card.mastery = Math.max(0, card.mastery - 1); }
  card.reviewCount = (card.reviewCount || 0) + 1; card.fs = Math.max(1.3, card.fs + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
  const nextDate = new Date(); nextDate.setDate(nextDate.getDate() + card.interval); card.nextReview = nextDate.toISOString();
  const originalIndex = cards.findIndex(c => c.id === card.id); if (originalIndex !== -1) cards[originalIndex] = card;
  const stats = JSON.parse(localStorage.getItem(STATS_KEY)); stats.todayCount++; localStorage.setItem(STATS_KEY, JSON.stringify(stats)); updateStats(); saveData(); currentReviewIndex++; showReviewCard();
}
function endReview(finished = false) { if (finished) alert("ğŸ‰ å¤ä¹ å®Œæˆï¼"); document.getElementById('review-overlay').classList.remove('active'); renderGrid(); }

function showSettingsModal() {
  document.getElementById('modal-title').textContent = "âš™ï¸ ç³»ç»Ÿè®¾ç½®";
  document.getElementById('modal-content').innerHTML = `
    <div style="margin-bottom:20px;"><h4 style="margin-bottom:10px;">ğŸ“– å¡ç‰‡ç­”æ¡ˆå­—å·</h4><div style="display:flex; gap:10px;">
      <button class="btn btn-secondary ${appSettings.cardFontSize==='normal'?'btn-primary':''}" onclick="updateFontSize('normal')">æ ‡å‡†</button>
      <button class="btn btn-secondary ${appSettings.cardFontSize==='medium'?'btn-primary':''}" onclick="updateFontSize('medium')">ä¸­å·</button>
      <button class="btn btn-secondary ${appSettings.cardFontSize==='large'?'btn-primary':''}" onclick="updateFontSize('large')">å¤§å·</button>
    </div></div>
    <div style="margin-bottom:20px;"><h4 style="margin-bottom:10px;">â³ è€ƒç ”å€’è®¡æ—¶</h4>
      <div class="input-group"><label>ç›®æ ‡åç§°:</label><input type="text" id="set-exam-name" class="input-field" value="${appSettings.examName}"></div>
      <div class="input-group"><label>ç›®æ ‡æ—¥æœŸ:</label><input type="date" id="set-exam-date" class="input-field" value="${appSettings.examDate}"></div>
      <button class="btn btn-primary btn-block" onclick="updateCountdownSetting()">ä¿å­˜</button>
    </div>`;
  document.getElementById('modal-root').style.display = 'flex';
}
function updateFontSize(size) { appSettings.cardFontSize = size; saveSettings(); showSettingsModal(); }
function updateCountdownSetting() { const name = document.getElementById('set-exam-name').value, date = document.getElementById('set-exam-date').value; if(name && date) { appSettings.examName = name; appSettings.examDate = date; saveSettings(); alert('å·²ä¿å­˜'); closeModal(); } }

function showManageModal(mode = 'subject') {
  manageViewMode = mode;
  document.getElementById('modal-title').textContent = "ğŸ”§ é¢˜åº“ç®¡ç†";
  const content = document.getElementById('modal-content');
  let html = `<div class="manage-tabs"><div class="manage-tab ${mode==='subject'?'active':''}" onclick="showManageModal('subject')">æŒ‰ç§‘ç›®</div><div class="manage-tab ${mode==='list'?'active':''}" onclick="showManageModal('list')">å…¨éƒ¨</div></div><div style="max-height:60vh;overflow-y:auto;">`;
  if (mode === 'subject') {
    const grouped = {}; cards.forEach(c => { const cat = c.category || "æœªåˆ†ç±»"; if(!grouped[cat]) grouped[cat]=[]; grouped[cat].push(c); });
    Object.keys(grouped).forEach(cat => {
      html += `<div class="manage-tag-group"><div class="manage-tag-header"><span>ğŸ“– ${cat} (${grouped[cat].length})</span><button class="btn btn-danger btn-sm" onclick="deleteByCategory('${cat}')">åˆ é™¤åˆ†ç±»</button></div><ul class="manage-list">
        ${grouped[cat].map(c => `<li class="manage-item"><span>${escapeHtml(c.front).substring(0,30)}...</span><button class="btn btn-ghost btn-sm" onclick="editCard(${c.id})">âœ</button></li>`).join('')}</ul></div>`;
    });
  } else {
    html += `<div style="margin-bottom:10px;display:flex;gap:10px;"><button class="btn btn-danger btn-sm" onclick="batchDelete()">åˆ é™¤é€‰ä¸­</button><input type="text" class="input-field" style="padding:4px 8px;" placeholder="ç­›é€‰..." oninput="filterManageList(this.value)"></div><ul class="manage-list" id="manage-all-list">
      ${cards.map(c => `<li class="manage-item" data-text="${c.front.toLowerCase()}"><div class="check-box-wrapper"><input type="checkbox" class="item-checkbox" value="${c.id}"><div style="display:flex;flex-direction:column;"><span>${escapeHtml(c.front).substring(0,35)}...</span><span style="font-size:0.75rem;color:#64748b;">${c.category}</span></div></div><button class="btn btn-ghost btn-sm" onclick="editCard(${c.id})">âœ</button></li>`).join('')}</ul>`;
  }
  content.innerHTML = html + '</div>';
  document.getElementById('modal-root').style.display = 'flex';
}
function filterManageList(text) { document.querySelectorAll('#manage-all-list .manage-item').forEach(item => item.style.display = item.dataset.text.includes(text.toLowerCase()) ? 'flex' : 'none'); }
function batchDelete() { const ids = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => parseFloat(cb.value)); if(ids.length===0 || !confirm(`åˆ é™¤ ${ids.length} å¼ ?`)) return; cards = cards.filter(c => !ids.includes(c.id)); saveData(); renderGrid(); showManageModal('list'); }
function deleteByCategory(cat) { if(confirm(`åˆ é™¤ç§‘ç›® "${cat}" ä¸‹æ‰€æœ‰å¡ç‰‡?`)) { cards = cards.filter(c => (c.category||"æœªåˆ†ç±»") !== cat); saveData(); renderGrid(); showManageModal('subject'); } }

function addNewCard() {
  const front = prompt("è¾“å…¥é—®é¢˜ (Front):"); if(!front) return;
  const back = prompt("è¾“å…¥ç­”æ¡ˆ (Back):"); if(!back) return;
  const category = prompt("ç§‘ç›® (æ ¼å¼: ä¸€çº§/äºŒçº§):", "æ”¿æ²»/é©¬åŸ");
  cards.unshift({ id: Date.now(), front, back, category: category||"æœªåˆ†ç±»", tags: ["æ‰‹åŠ¨"], nextReview: new Date().toISOString(), mastery: 0, interval: 0, fs: 2.5 });
  saveData(); renderGrid();
}
function editCard(id) {
  const card = cards.find(c => c.id === id);
  if(!confirm(`ç¼–è¾‘ï¼š${card.front}\n(å–æ¶ˆåˆ™åˆ é™¤)`)) { if(confirm("åˆ é™¤æ­¤å¡ç‰‡?")) { cards = cards.filter(c => c.id !== id); saveData(); renderGrid(); if(document.getElementById('modal-root').style.display==='flex') showManageModal(manageViewMode); } return; }
  const f = prompt("é—®é¢˜:", card.front), b = prompt("ç­”æ¡ˆ:", card.back), c = prompt("ç§‘ç›®:", card.category);
  if(f && b) { card.front = f; card.back = b; card.category = c; saveData(); renderGrid(); if(document.getElementById('modal-root').style.display==='flex') showManageModal(manageViewMode); }
}
function showImportModal() {
  document.getElementById('modal-title').textContent = "å¯¼å…¥é¢˜åº“ (JSON)";
  document.getElementById('modal-content').innerHTML = `
    <div style="background:#f0f9ff;border:1px solid #bae6fd;padding:12px;border-radius:8px;margin-bottom:15px;font-size:0.9rem;color:#0c4a6e;">
      <strong>ğŸ“‹ æ•°æ®æ ¼å¼è¦æ±‚ï¼š</strong>
      <ul style="margin:5px 0 10px 20px;padding:0;">
        <li>æ–‡ä»¶ç±»å‹ï¼šJSON æ•°ç»„</li>
        <li>å¿…éœ€å­—æ®µï¼š<code>front</code> (é—®é¢˜), <code>back</code> (ç­”æ¡ˆ)</li>
        <li>å¯é€‰å­—æ®µï¼š<code>category</code> (ç§‘ç›®), <code>tags</code> (æ ‡ç­¾æ•°ç»„)</li>
      </ul>
      <div style="background:#e0f2fe;padding:8px;border-radius:4px;font-family:monospace;font-size:0.85rem;color:#0284c7;">
        [<br>
        &nbsp;&nbsp;{<br>
        &nbsp;&nbsp;&nbsp;&nbsp;"front": "é¢˜ç›®ç¤ºä¾‹",<br>
        &nbsp;&nbsp;&nbsp;&nbsp;"back": "ç­”æ¡ˆå†…å®¹...",<br>
        &nbsp;&nbsp;&nbsp;&nbsp;"category": "å…¬å…±ç®¡ç†å­¦"<br>
        &nbsp;&nbsp;}<br>
        ]
      </div>
      <button class="btn btn-secondary btn-sm" style="margin-top:8px;" onclick="copyAiPrompt()">ğŸ“‹ å¤åˆ¶ AI æç¤ºè¯</button>
    </div>
    <div style="margin-bottom:15px;"><label style="display:block;margin-bottom:6px;font-weight:600;">æ–¹å¼ 1: ä¸Šä¼ æ–‡ä»¶ (.json)</label><input type="file" id="import-file" accept=".json" class="input-field" style="padding:8px;"></div>
    <div style="margin-bottom:15px;"><label style="display:block;margin-bottom:6px;font-weight:600;">æ–¹å¼ 2: ç²˜è´´æ–‡æœ¬</label><textarea id="import-area" class="input-field" style="height:120px;font-family:monospace;font-size:12px;" placeholder="åœ¨æ­¤å¤„ç²˜è´´ JSON æ•°ç»„..."></textarea></div>
    <button class="btn btn-primary btn-block" onclick="executeImport()">ç¡®è®¤å¯¼å…¥</button>`;
  document.getElementById('modal-root').style.display = 'flex';
}

function copyAiPrompt() {
    const promptText = `è¯·å¸®æˆ‘ç”Ÿæˆå…¬å…±ç®¡ç†ä¸“ä¸šçš„å¤ä¹ é—ªå¡ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š
1. è¾“å‡ºæ ¼å¼å¿…é¡»æ˜¯åˆæ³•çš„ JSON æ•°ç»„ã€‚
2. åŒ…å«å­—æ®µï¼šfront (é—®é¢˜), back (ç­”æ¡ˆï¼Œæ”¯æŒ Markdown), category (ç§‘ç›®/å­ç§‘ç›®), tags (æ ‡ç­¾æ•°ç»„)ã€‚
3. ç­”æ¡ˆç»“æ„ï¼šã€æ ¸å¿ƒå›ç­”ã€‘å¿…é¡»åœ¨æœ€å‰ã€‚å¦‚æœ‰ã€æ‹“å±•/æ·±åº¦è§£æ/è‹±è¯­è¯æ±‡ã€‘ï¼Œè¯·ä½¿ç”¨ "###" æˆ– "---" è¿›è¡Œåˆ†éš”ï¼Œè¿™äº›å†…å®¹å°†è¢«è‡ªåŠ¨å¼±åŒ–æ˜¾ç¤ºã€‚
ç¤ºä¾‹ï¼š[{"front":"é—®é¢˜","back":"æ ¸å¿ƒç­”æ¡ˆ...\\n\\n### æ·±åº¦è§£æ\\nå†…å®¹...","category":"æ”¿æ²»/é©¬åŸ","tags":["é«˜é¢‘"]}]`;
    const textArea = document.createElement("textarea"); textArea.value = promptText; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
    try { document.execCommand('copy'); alert('æç¤ºè¯å·²å¤åˆ¶ï¼å‘é€ç»™ AI å³å¯ç”Ÿæˆæ•°æ®ã€‚'); } catch (err) { alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚'); }
    document.body.removeChild(textArea);
}

function executeImport() {
  const fileInput = document.getElementById('import-file'); const textArea = document.getElementById('import-area');
  const processData = (jsonStr) => {
    try {
      const data = JSON.parse(jsonStr); if(!Array.isArray(data)) throw new Error("Root must be an array");
      let count = 0; data.forEach(item => { if(item.front && item.back) { if(!cards.some(c => c.front === item.front)) { cards.push({ id: Date.now() + Math.random(), front: item.front, back: item.back, category: item.category || "æœªåˆ†ç±»", tags: item.tags || ["å¯¼å…¥"], nextReview: new Date().toISOString(), mastery: 0, interval: 0, fs: 2.5 }); count++; } } });
      saveData(); renderGrid(); updateSubjectList(); closeModal(); alert(`æˆåŠŸå¯¼å…¥ ${count} å¼ æ–°å¡ç‰‡ï¼(å·²è‡ªåŠ¨è¿‡æ»¤é‡å¤é¡¹)`);
    } catch(e) { alert("æ ¼å¼é”™è¯¯ï¼šè¯·æ£€æŸ¥ JSON è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œå¿…é¡»æ˜¯å¯¹è±¡æ•°ç»„ã€‚"); console.error(e); }
  };
  if (fileInput.files.length > 0) { const file = fileInput.files[0]; const reader = new FileReader(); reader.onload = (e) => processData(e.target.result); reader.readAsText(file); } else if (textArea.value.trim()) { processData(textArea.value.trim()); } else { alert("è¯·é€‰æ‹©æ–‡ä»¶æˆ–ç²˜è´´å†…å®¹"); }
}

function exportCards() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cards)); a.download = "mpa_flashcards.json"; document.body.appendChild(a); a.click(); a.remove(); }
function closeModal() { document.getElementById('modal-root').style.display = 'none'; }
function filterCards(kw) { if(!kw) { renderGrid(); return; } const l = kw.toLowerCase(); renderGrid(cards.filter(c => c.front.toLowerCase().includes(l) || c.back.toLowerCase().includes(l))); }
function filterByStatus(t) { currentFilter = t; updateNavActiveState(); renderGrid(); }
function filterBySubject(s) { currentFilter = 'subject:'+s; updateNavActiveState(); renderGrid(); }
function resetFilter() { currentFilter = 'all'; updateNavActiveState(); renderGrid(); }
function updateNavActiveState() { document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); if(currentFilter==='all') document.getElementById('nav-all').classList.add('active'); }
function loadNote() { document.getElementById('quick-note').value = localStorage.getItem(NOTES_KEY) || ""; }
function saveNote() { localStorage.setItem(NOTES_KEY, document.getElementById('quick-note').value); }
function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function parseCardAnswer(t) { return `<div class="answer-main">${parseMarkdown(t)}</div>`; }
function parseMarkdown(t) {
  let h = escapeHtml(t);
  h = h.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/`([^`]+)`/g, '<code>$1</code>');
  let lines = h.split('\n'), inTable = false, newLines = [];
  for(let i=0; i<lines.length; i++) {
      let line = lines[i].trim();
      if (line.startsWith('|') && line.endsWith('|')) {
          if (!inTable) { newLines.push('<div style="overflow-x:auto;"><table>'); inTable = true; }
          if (line.match(/^\|[\s-:]+\|[\s-:]+\|/)) continue;
          let cells = line.substring(1, line.length-1).split('|').map(c => `<td>${c.trim()}</td>`).join('');
          newLines.push(`<tr>${cells}</tr>`);
      } else {
          if (inTable) { newLines.push('</table></div>'); inTable = false; }
          newLines.push(line + '<br>');
      }
  }
  if(inTable) newLines.push('</table></div>');
  return newLines.join('');
}

// AI & Chat Logic
function toggleChat() { const w = document.getElementById('chat-widget'); w.style.display = w.style.display === 'flex' ? 'none' : 'flex'; }
function updateApiProvider() { currentProvider = document.getElementById('api-provider').value; localStorage.setItem('preferred_api_provider', currentProvider); document.getElementById('btn-set-key').textContent = `ğŸ”‘ è®¾ç½® ${API_CONFIG[currentProvider].name} Key`; }
function setApiKey() { const k = prompt("API Key:", localStorage.getItem(API_CONFIG[currentProvider].storageKey)||""); if(k) { localStorage.setItem(API_CONFIG[currentProvider].storageKey, k); alert("Saved"); } }
function dragChat(e) { if(e.target.tagName==='SPAN') return; const el = document.getElementById('chat-widget'); let sx = e.clientX-el.getBoundingClientRect().left, sy = e.clientY-el.getBoundingClientRect().top; const mm = (ev) => { el.style.left = ev.pageX-sx+'px'; el.style.top = ev.pageY-sy+'px'; el.style.bottom = 'auto'; el.style.right = 'auto'; }; document.addEventListener('mousemove', mm); el.onmouseup = () => document.removeEventListener('mousemove', mm); }

function renderChatHistory() {
    const b = document.getElementById('chat-body'); b.innerHTML = '';
    if(chatHistory.length===0) { b.innerHTML = '<div class="msg ai">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±è€ƒç ”å¯¼å¸ˆã€‚è¯·è®¾ç½® Key å¼€å§‹ã€‚</div>'; return; }
    chatHistory.forEach(m => {
        const d = document.createElement('div'); d.className = `msg ${m.role}`;
        if(m.role==='ai') {
            d.innerHTML = parseMarkdown(m.text);
            if(m.text.includes('[') && m.text.includes(']')) {
                 try {
                   let match = m.text.match(/\[\s*\{.*?\}\s*\]/s);
                   let jsonStr = match ? match[0] : null;
                   if (jsonStr && JSON.parse(jsonStr).length > 0) {
                       const btn = document.createElement('button');
                       btn.className = 'btn btn-primary btn-sm';
                       btn.style.marginTop = '8px';
                       btn.textContent = "æ£€æµ‹åˆ°é—ªå¡æ•°æ® (ç‚¹å‡»å¯¼å…¥)";
                       btn.onclick = function() { document.getElementById('import-area').value = jsonStr; executeImport(); this.disabled=true; this.textContent="å·²å¯¼å…¥"; };
                       d.appendChild(btn);
                   }
                 } catch(e){}
            }
        } else d.innerText = m.text;
        b.appendChild(d);
    });
    b.scrollTop = b.scrollHeight;
}
function clearChatHistory() { if(confirm('æ¸…ç©ºè®°å½•?')) { chatHistory=[]; localStorage.removeItem(CHAT_HISTORY_KEY); renderChatHistory(); } }
function saveChatHistory() { localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatHistory)); }

async function sendMessage() {
  const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt) return;
  addMsg('user', txt); inp.value = '';
  const cfg = API_CONFIG[currentProvider], key = localStorage.getItem(cfg.storageKey);
  if(!key) { addMsg('ai', "è¯·å…ˆè®¾ç½® API Key"); return; }
  
  const ld = document.createElement('div'); ld.className='msg ai'; ld.innerText='æ€è€ƒä¸­...'; document.getElementById('chat-body').appendChild(ld);
  try {
    let prompt = `ä½ æ˜¯ä¸€ä½ä¸­å›½å…¬å…±ç®¡ç†è€ƒç ”å‘½é¢˜ä¸“å®¶ã€‚
    1. **ç»“æ„åŒ–è¾“å‡º**ï¼šå®šä¹‰ -> æ ¸å¿ƒè¦ç´  -> æ„ä¹‰ã€‚
    2. **ç»“åˆæ—¶æ”¿**ï¼šè”ç³»ä¸­å›½æ•°å­—æ”¿åºœã€å…±åŒå¯Œè£•ç­‰çƒ­ç‚¹ã€‚
    3. **å‡†ç¡®åˆ†ç±»**ï¼šå¦‚æœç”Ÿæˆé—ªå¡ï¼Œè¯·æ ¹æ®å†…å®¹è‡ªåŠ¨åˆ¤æ–­ç§‘ç›®ï¼ˆå¦‚ï¼šå…¬å…±ç®¡ç†å­¦ã€æ”¿æ²»ã€ç¤¾ä¼šç ”ç©¶æ–¹æ³•ï¼‰ã€‚å¦‚æœæ²¡æœ‰æ˜ç¡®çº¿ç´¢ï¼Œé»˜è®¤åˆ†ç±»ä¸ºâ€œAIç”Ÿæˆâ€ã€‚
    4. **JSONæ ¼å¼**ï¼šè‹¥ç”Ÿæˆé—ªå¡ï¼Œè¿”å› [{"front":"é—®é¢˜","back":"ç­”æ¡ˆmarkdown","category":"ç§‘ç›®/å­ç§‘ç›®"}]ã€‚`;
    
    let res, data, reply;
    if(currentProvider==='deepseek') {
        res = await fetch(cfg.url, { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`}, body:JSON.stringify({ model:"deepseek-chat", messages:[{role:"system",content:prompt},{role:"user",content:txt}], stream:false }) });
        data = await res.json(); reply = data.choices[0].message.content;
    } else {
        res = await fetch(`${cfg.url}?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ contents:[{role:"user",parts:[{text:prompt+"\n"+txt}]}] }) });
        data = await res.json(); reply = data.candidates[0].content.parts[0].text;
    }
    ld.remove();
    const msgDiv = addMsg('ai', reply);
    
    if (reply.includes('[') && reply.includes(']')) {
        let match = reply.match(/\[\s*\{.*?\}\s*\]/s);
        let jsonStr = match ? match[0] : reply.substring(reply.indexOf('['), reply.lastIndexOf(']')+1);
        try {
            let parsed = JSON.parse(jsonStr);
            if(Array.isArray(parsed) && parsed.length>0 && parsed[0].front) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary btn-sm'; btn.style.marginTop='8px'; btn.textContent = `ä¸€é”®å¯¼å…¥ ${parsed.length} å¼ å¡ç‰‡`;
                btn.onclick = function() { 
                    let count=0; parsed.forEach(p=>{ if(!cards.some(c=>c.front===p.front)){ cards.push({id:Date.now()+Math.random(), front:p.front, back:p.back, category:p.category||"AIç”Ÿæˆ", tags:p.tags||["AI"], nextReview:new Date().toISOString(), mastery:0, interval:0, fs:2.5}); count++; } });
                    saveData(); renderGrid(); updateSubjectList(); this.disabled=true; this.textContent=`æˆåŠŸå¯¼å…¥ ${count} å¼ `; alert(`å¯¼å…¥æˆåŠŸ`);
                };
                msgDiv.appendChild(btn);
            }
        } catch(e){}
    }
  } catch(e) { ld.remove(); addMsg('ai', "è¯·æ±‚å‡ºé”™"); console.error(e); }
}
function addMsg(role, text) {
    const d = document.createElement('div'); d.className = `msg ${role}`;
    if(role==='ai') d.innerHTML = parseMarkdown(text); else d.innerText = text;
    document.getElementById('chat-body').appendChild(d);
    document.getElementById('chat-body').scrollTop = document.getElementById('chat-body').scrollHeight;
    chatHistory.push({role, text}); saveChatHistory();
    return d;
}

window.onload = initData;
document.addEventListener('keydown', (e) => { if(document.getElementById('review-overlay').classList.contains('active')) { if(e.key===' '||e.key==='Enter') flipCard(); if(['1','2','3','4'].includes(e.key)) rateCard(parseInt(e.key)); if(e.key==='Escape') endReview(); } });
</script>
</body>
</html>
