<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç§‘å­¦é—ªå¡èƒŒè¯µç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body { height: 100%; margin: 0; padding: 0; background: #f5f7fa; color: #222;}
    body { font-family: 'Roboto Slab', 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; }
    .container {
      display: grid;
      grid-template-columns: 300px 1fr 320px;
      gap: 28px;
      max-width: 1480px;
      margin: 0 auto;
      padding: 24px 14px 38px 14px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .sidebar, .tools-section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 20px #24335608,0 1px 2px #24335611;
      padding: 28px 20px 22px 20px;
      min-width: 0;
      min-height: 650px;
      max-height: 92vh;
      position: sticky;
      top: 22px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow-y: auto;
    }
    .sidebar { align-self: start; }
    .tools-section { align-self: start; }
    .flashcard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      grid-auto-rows: max-content;
      gap: 28px;
      align-items: stretch;
      justify-items: stretch;
      padding: 20px;
      padding-bottom: 40px;
      max-height: 92vh;
      overflow-y: auto;
    }
    /* ---- 3Dé—ªå¡åŠ¨ç”»æ ·å¼ ---- */
    .flashcard {
      width: 100%;
      max-width: 26rem;
      min-height: 260px;
      max-height: 60vh;
      perspective: 1200px;
      background: transparent;
      margin: 0 auto;
      position: relative;
      cursor: pointer;
      user-select: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: box-shadow .24s, transform .24s;
    }
    .flashcard-inner {
      width: 100%;
      height: 100%;
      transition: transform 0.68s cubic-bezier(.41,1.58,.6,1);
      transform-style: preserve-3d;
      position: relative;
    }
    .flashcard.flipped .flashcard-inner {
      transform: rotateY(180deg);
    }
    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      left: 0; top: 0;
      backface-visibility: hidden;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 1px 6px rgba(36,51,86,0.08);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      cursor: pointer;
      padding: 28px;
      transition: box-shadow .2s;
      z-index: 2;
      overflow-y: auto;
      max-height: 60vh;
    }
    .flashcard-front { z-index: 3; }
    .flashcard-back {
      background: linear-gradient(140deg, #f1fdf4 70%, #e7f9ed 100%);
      transform: rotateY(180deg);
      z-index: 1;
      border: 1.5px solid #bbf7d0;
    }
    .flashcard:hover {
      box-shadow: 0 8px 26px rgba(0,0,0,0.15);
      transform: translateY(-6px);
    }
    /* ç¼©ç•¥å›¾å¡ç‰‡ */
    .flashcard-thumb {
      background:#fff;
      border-radius:12px;
      padding:18px;
      min-height:120px;
      box-shadow:0 2px 12px rgba(0,0,0,0.05);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:center;
      text-align:left;
      cursor:pointer;
      overflow:hidden;
      transition:transform .2s;
    }
    .flashcard-thumb:hover {transform:scale(1.05);}
    .flashcard-thumb .thumb-title {font-weight:600;color:#334155;font-size:1.05em;margin-bottom:4px;}
    .flashcard-thumb .thumb-clue {color:#64748b;font-size:0.9em;line-height:1.4;}

    /* å¤§å¡ç‰‡æ¨¡æ€ */
      #card-modal {
        position: fixed;
        left: 0; top: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.55);
        backdrop-filter: blur(3px);
        display: none;
        align-items: center;
        justify-content: center;
        padding:40px;
        overflow-y:auto;
        z-index: 1500;
      }
      #card-modal.active {display:flex; animation: fadeIn 0.25s;}
      #card-modal .card-popup {
        background:#fff;
        max-width:720px;
        width:100%;
        max-height:80vh;
        padding:32px;
        border-radius:20px;
        position:relative;
        box-shadow:0 8px 32px rgba(0,0,0,0.25);
        animation:scaleIn 0.3s ease;
        display:flex;
        flex-direction:column;
      }
      #card-modal .close-btn {position:absolute;right:16px;top:16px;background:#f8fafc;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;}
      #card-modal .popup-title {font-size:1.3em;font-weight:700;margin-bottom:12px;}
      #card-modal .popup-content {flex:1;overflow-y:auto;line-height:1.6;margin-bottom:18px;color:#374151;}
      #card-modal .popup-clue {color:#64748b;margin-bottom:12px;}
      #card-modal .mastery-buttons {justify-content:center;}

      @keyframes scaleIn {from{transform:scale(0.9);opacity:0;}to{transform:scale(1);opacity:1;}}
    .card-title {font-size:1.23em;font-weight:700;margin-bottom:9px;}
    .flashcard-tags {margin-bottom: 10px;}
    .tag {display:inline-block;font-size:12px;border-radius:10px;padding:2px 9px 2px 7px;margin-right:6px;}
    .tag-icon {margin-right:3px;}
    .tag.high {background: #22c55e;color:#fff;}
    .tag.medium {background: #4ade80;color:#065f46;}
    .tag.low {background: #bbf7d0;color:#065f46;}
    .card-clue {font-size:.98em;color:#385380;margin:3px 0 13px 0;}
    .card-category {font-size:14px;color:#4b5563;margin-bottom:7px;}
    .difficulty-dot {display:inline-block;width:9px;height:9px;margin-right:2.5px;border-radius:50%;background:#e0e0e0;}
    .difficulty-dot.active {background: #6366f1;}
    .card-footer {margin-top:auto;}
    .numbered-list .number {color:#1976d2;font-weight:bold;}
    .numbered-list .list-item {margin-bottom:3px;}
    .note {margin-top:10px;padding:7px 13px 7px 13px;background:#f1f3fa;border-left:4px solid #6366f1;font-size:13px;border-radius:0 7px 7px 0;}
    /* 3DåŠ¨ç”»æŒ‰é’® */
    .mastery-buttons { display: flex; gap: 10px; margin-top: 16px; justify-content: center;}
    .mastery-btn { border:none;border-radius:13px;padding:8px 21px;font-size:15px;font-weight:500;cursor:pointer;transition:.14s;}
    .mastery-btn.hard {background:#fde68a;color:#b45309;}
    .mastery-btn.medium {background:#bae6fd;color:#0369a1;}
    .mastery-btn.easy {background:#bbf7d0;color:#166534;}
    .mastery-btn:hover {transform: scale(1.09);}
    /* è¿›åº¦ç¯ä¸ç»Ÿè®¡åŒº */
    .progress-ring { position: relative; width: 60px; height: 60px;}
    .progress-ring-circle-bg {
      fill: none;
      stroke: #e2e8f0;
      stroke-width: 4;
    }
    .progress-ring-circle {
      fill: none;
      stroke: #6366f1;
      stroke-width: 4;
      transform: rotate(-90deg);
      transform-origin: center;
      transition: stroke-dashoffset 0.3s ease;
    }
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 15px;
      font-weight: 600;
      color: #6366f1;
      pointer-events:none;
    }
    .stats-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;}
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-item {
      background: #f8fafc;
      padding: 10px 0 6px 0;
      border-radius: 13px;
      display: flex; flex-direction: column; align-items: center;
      transition: transform 0.17s;
      font-size: 15px;
    }
    .stat-item.highlight {
      background: linear-gradient(135deg,#6366f1,#3b82f6);
      color: #fff;
    }
    .stat-label {font-size: 13px; color: #64748b;}
    .stat-item.highlight .stat-label,
    .stat-item.highlight .stat-value {color:#fff;}
    .stat-value {font-size: 20px; font-weight: 600; color: #1a202c;}
    .study-streak {display:flex;justify-content:space-between;background:#f8fafc;padding:13px 16px;border-radius:12px;}
    .streak-info, .today-count {display:flex;flex-direction:column;align-items:center;}
    .streak-label, .today-label {font-size:13px;color:#64748b;}
    .streak-value, .today-value {font-size:16px;font-weight:600;color:#6366f1;}
    /* æœç´¢è¾“å…¥ä¸ä¾§è¾¹æ åˆ†ç±» */
    .search-input {width:100%;padding:11px 14px;border:1px solid #e2e8f0;border-radius:12px;font-size:15px;background:#f8fafc;margin-bottom:8px;}
    .search-input:focus {border-color:#6366f1;box-shadow:0 0 0 2px #c7d2fe;}
    .search-box {position: relative;}
    .search-icon {position: absolute;right: 17px;top: 50%;transform: translateY(-50%);color: #94a3b8;pointer-events: none;}
    .card-list {list-style: none; padding: 0; margin: 0;}
    .category-item {margin-bottom: 14px;}
    .category-header {display: flex;align-items: center;padding: 7px 12px;background: #f8fafc;border-radius: 8px;cursor: pointer;transition: all 0.18s;}
    .category-header:hover {background: #f1f5f9;}
    .category-header i {margin-right: 8px;transition: transform 0.2s;}
    .category-header.expanded i {transform: rotate(90deg);}
    .category-content {margin-left: 20px;padding: 8px 0;display: none;}
    .category-content.expanded {display: block;}
    .chapter-item {margin: 4px 0;padding: 4px 12px;border-radius: 7px;cursor: pointer;transition: all 0.18s;}
    .chapter-item:hover {background: #e0e7ff;color: #6366f1;}
    /* æŒ‰é’®æ ·å¼ */
    .btn-primary, .btn-secondary, .btn-save {
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.18s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      outline: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #3b82f6);
      color: #fff;
    }
    .btn-secondary {
      background: #f1f5f9;
      color: #1e293b;
    }
    .btn-save {
      background: #dcfce7;
      color: #15803d;
      margin-top: 12px;
    }
    .btn-primary:hover, .btn-secondary:hover, .btn-save:hover {
      filter: brightness(1.1);
    }
    .action-buttons {display: flex;flex-direction: column;gap: 10px;margin-top: 18px;}
    /* ç¬”è®°ç³»ç»ŸUI */
    .note-section {background:#fff;border-radius:16px;padding:18px 14px 12px 14px;}
    .note-tabs {display: flex;gap: 10px;margin-bottom: 15px;border-bottom: 2px solid #e2e8f0;padding-bottom: 9px;}
    .tab-btn {padding:8px 18px;border:none;border-radius:8px;background:#f1f5f9;color:#64748b;cursor:pointer;}
    .tab-btn.active {background:#6366f1;color:#fff;}
    .tab-content {display: none;}
    .tab-content.active {display: block;}
    .note-controls {display: flex;gap: 10px;margin-bottom: 13px;}
    .note-select {flex: 1;padding: 8px;border: 1px solid #e2e8f0;border-radius: 8px;background: #f8fafc;}
    .btn-new-category {padding:8px 16px;background:#4ade80;color:white;border:none;border-radius:8px;cursor:pointer;}
    .note-editor {display: flex;flex-direction: column;gap: 10px;}
    .note-title {padding: 8px;border: 1px solid #e2e8f0;border-radius: 8px;font-size: 16px;}
    .note-editor textarea {height: 100px;padding: 10px;border: 1px solid #e2e8f0;border-radius: 8px;resize: vertical;font-size: 14px;line-height: 1.6;}
    .note-actions {display: flex;justify-content: space-between;margin-top: 10px;padding-top: 12px;border-top: 1px solid #e2e8f0;}
    /* å“åº”å¼é€‚é… */
  @media (max-width:1200px) {
        .container {grid-template-columns: 1fr 1fr;gap: 16px;}
        .sidebar, .tools-section {min-height: 410px;}
        .flashcard-grid {grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; padding: 20px;}
      }
      @media (max-width:900px) {
        .container {grid-template-columns: 1fr;gap:10px;padding:8px;}
        .sidebar, .tools-section {position: static;min-height: auto;margin-bottom:12px;}
        .flashcard-grid {grid-template-columns: 1fr; gap: 20px; padding: 15px;}
      }
    /* å¯¼å…¥å¼¹çª—æ ·å¼ */
    #import-modal-root>div {
      position:fixed;z-index:1200;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.19);display:flex;align-items:center;justify-content:center;
    }
    #import-modal-root .modal-content {
      background:#fff;border-radius:12px;max-width:440px;padding:32px 28px;box-shadow:0 8px 32px #3332;position:relative;
    }
    #import-json {width:98%;min-height:96px;border-radius:8px;border:1px solid #e0e0e0;padding:7px 10px;font-size:15px;}
    #import-file {margin:10px 0;}
    .import-hint {background:#f8fafc;border:1px dashed #d1d5db;padding:8px;font-size:13px;margin:8px 0;white-space:pre-wrap;}
    /* æç¤ºåŠ¨ç”» */
    @keyframes fadeIn {from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);}}
    .flashcard,.sidebar,.tools-section,.modal-content {animation:fadeIn 0.4s;}
  </style>
</head>
<body>
  <div class="container">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
      <h3 style="margin-bottom:14px;">çŸ¥è¯†å¯¼èˆª</h3>
      <div class="search-box">
        <input type="text" class="search-input" placeholder="æœç´¢å¡ç‰‡..." oninput="filterCards(this.value)">
        <i class="search-icon">ğŸ”</i>
      </div>
      <div class="card-list" id="card-list"></div>
      <div class="action-buttons">
        <button class="btn-primary" onclick="showImportModal()"><i>ğŸ“¥</i>å¯¼å…¥é¢˜åº“</button>
        <button class="btn-secondary" onclick="addNewCard()"><i>âœ¨</i>æ–°å»ºå¡ç‰‡</button>
      </div>
    </div>
    <!-- ä¸»å¡ç‰‡åŒº -->
    <div class="flashcard-grid" id="flashcard-grid"></div>
    <div id="card-modal" onclick="closeCardModal(event)"></div>
    <!-- å·¥å…·æ  -->
    <div class="tools-section">
      <div class="tool-card countdown">
        <span class="countdown-label">è·ç¦»è€ƒç ”è¿˜æœ‰</span>
        <span class="countdown-value" id="countdown">è®¡ç®—ä¸­...</span>
      </div>
      <div class="study-stats">
        <div class="stats-header">
          <h4>å­¦ä¹ è¿›åº¦</h4>
          <div class="progress-ring">
            <svg width="60" height="60" viewBox="0 0 60 60">
              <circle class="progress-ring-circle-bg" cx="30" cy="30" r="24"/>
              <circle class="progress-ring-circle" cx="30" cy="30" r="24"/>
            </svg>
            <span class="progress-text">0%</span>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-item"><span class="stat-label">å·²æŒæ¡</span><span class="stat-value" id="stat-mastered">0</span></div>
          <div class="stat-item"><span class="stat-label">å¤ä¹ ä¸­</span><span class="stat-value" id="stat-reviewing">0</span></div>
          <div class="stat-item"><span class="stat-label">æœªå­¦ä¹ </span><span class="stat-value" id="stat-new">0</span></div>
          <div class="stat-item highlight"><span class="stat-label">é«˜é¢‘è€ƒç‚¹</span><span class="stat-value" id="stat-high">0</span></div>
        </div>
        <div class="study-streak">
          <div class="streak-info">
            <span class="streak-label">è¿ç»­å­¦ä¹ </span>
            <span class="streak-value" id="stat-streak">0å¤©</span>
          </div>
          <div class="today-count">
            <span class="today-label">ä»Šæ—¥å·²å­¦</span>
            <span class="today-value" id="stat-today">0å¼ </span>
          </div>
        </div>
      </div>
      <div class="tool-card note-section">
        <h4>å­¦ä¹ ç¬”è®°</h4>
        <div class="note-tabs">
          <button class="tab-btn active" data-tab="quick" onclick="switchNoteTab('quick')">å¿«é€Ÿç¬”è®°</button>
          <button class="tab-btn" data-tab="organized" onclick="switchNoteTab('organized')">ç³»ç»Ÿç¬”è®°</button>
        </div>
        <div class="tab-content active" id="quick-note">
          <textarea placeholder="è®°å½•ä¸´æ—¶æƒ³æ³•å’Œç¬”è®°..." id="quick-textarea"></textarea>
        </div>
        <div class="tab-content" id="organized-note">
          <div class="note-controls">
            <select id="note-category" class="note-select"></select>
            <button class="btn-new-category" onclick="addNoteCategory()">æ–°å»ºåˆ†ç±»</button>
          </div>
          <div class="note-editor">
            <input type="text" class="note-title" placeholder="ç¬”è®°æ ‡é¢˜...">
            <textarea id="organized-textarea" placeholder="ç³»ç»ŸåŒ–çš„å­¦ä¹ ç¬”è®°..."></textarea>
          </div>
        </div>
        <div class="note-actions">
          <button class="btn-save" onclick="saveNote()">ä¿å­˜ç¬”è®°</button>
          <button class="btn-view-history" onclick="viewNoteHistory()">æŸ¥çœ‹å†å²</button>
        </div>
      </div>
    </div>
  </div>
  <!-- å¯¼å…¥å¼¹çª—å®¹å™¨ -->
  <div id="import-modal-root"></div>

  <!-- DeepSeek Chat Widget -->
  <script>
    window.deepseekChatConfig = {
      apiKey: 'sk-10b52ce013e5416bbf98db54354a1bb8',
      language: 'zh'
    };
  </script>
  <script src="https://chat.deepseek.com/widget.js" defer></script>

  <!-- ä¸‹é¢jséƒ¨åˆ†ä¸‹ä¸€è½®å‘é€ï¼ -->
</body>
</html>
<script>
// ============ æ•°æ®åˆå§‹åŒ–ä¸æœ¬åœ°å­˜å‚¨ ==============
let cards = JSON.parse(localStorage.getItem('flashcards') || '[]');
if (!cards.length) {
  // é»˜è®¤åˆå§‹å¡ç‰‡
  cards = [{
    front: "å…¬å…±ç®¡ç†çš„åŸºæœ¬ç‰¹å¾",
    back: "1ã€å…¬å…±æ€§ï¼šæœåŠ¡å¯¹è±¡å’Œç›®æ ‡çš„å…¬å…±æ€§\n2ã€æƒåŠ›æ€§ï¼šè¡Œæ”¿æƒåŠ›å’Œæ³•å¾‹ä¿éšœ\n3ã€æœåŠ¡æ€§ï¼šä»¥æœåŠ¡å…¬ä¼—ä¸ºæ ¹æœ¬å®—æ—¨\n4ã€ä¸“ä¸šæ€§ï¼šéœ€è¦ä¸“ä¸šçŸ¥è¯†å’ŒæŠ€èƒ½",
    category: "å…¬å…±ç®¡ç†",
    chapter: "ç¬¬ä¸€ç«  å…¬å…±ç®¡ç†æ¦‚è®º",
    section: "å…¬å…±ç®¡ç†ç‰¹å¾",
    level: "é‡ç‚¹",
    examFrequency: "é«˜é¢‘",
    cardType: "ç‰¹å¾åˆ†æ",
    clue: "æ€è€ƒï¼šä»€ä¹ˆä½¿å…¬å…±ç®¡ç†åŒºåˆ«äºä¸€èˆ¬ç®¡ç†ï¼Ÿ",
    context: "å…¬å…±ç®¡ç†æ˜¯ä¸€é—¨ä¸“é—¨ç ”ç©¶æ”¿åºœç®¡ç†æ´»åŠ¨çš„å­¦ç§‘ï¼Œå…¶ç‰¹å¾åæ˜ äº†å…¶æœ¬è´¨å±æ€§",
    lastReview: null,
    nextReview: null,
    reviewCount: 0,
    difficulty: 0,
    mastery: 0,
    wrongCount: 0
  }];
}

// ============ å­¦ä¹ è¿›åº¦/ç»Ÿè®¡ ==============
function statSummary() {
  const total = cards.length;
  let mastered = 0, reviewing = 0, unlearned = 0, high = 0;
  cards.forEach(card => {
    if (card.mastery >= 4) mastered++;
    else if (card.mastery >= 1) reviewing++;
    else unlearned++;
    if (card.examFrequency === 'é«˜é¢‘') high++;
  });
  return { total, mastered, reviewing, unlearned, high };
}
function updateStats() {
  const s = statSummary();
  document.getElementById('stat-mastered').textContent = s.mastered;
  document.getElementById('stat-reviewing').textContent = s.reviewing;
  document.getElementById('stat-new').textContent = s.unlearned;
  document.getElementById('stat-high').textContent = s.high;
  // è¿›åº¦ç¯
  const percent = s.total ? Math.round((s.mastered + s.reviewing) / s.total * 100) : 0;
  const circle = document.querySelector('.progress-ring-circle');
  const radius = 24, circumference = 2 * Math.PI * radius;
  circle.setAttribute('stroke-dasharray', circumference);
  circle.setAttribute('stroke-dashoffset', circumference * (1 - percent / 100));
  document.querySelector('.progress-text').textContent = percent + '%';
  document.getElementById('stat-today').textContent = getTodayStudyCount() + 'å¼ ';
  document.getElementById('stat-streak').textContent = getStudyStreak() + 'å¤©';
}

// ============ ä¾§è¾¹æ  åˆ†ç±»-ç« èŠ‚ äºŒçº§å±•å¼€ ==============
function updateCardList(listCards = cards.filter(activeReviewFilter)) {
  const grouped = listCards.reduce((acc, card) => {
    if (!acc[card.category]) acc[card.category] = {};
    if (!acc[card.category][card.chapter]) acc[card.category][card.chapter] = [];
    acc[card.category][card.chapter].push(card);
    return acc;
  }, {});
  const list = document.getElementById('card-list');
  list.innerHTML = '';
  const allItem = document.createElement('div');
  allItem.className = 'chapter-item';
  allItem.textContent = 'å…¨éƒ¨å¡ç‰‡';
  allItem.onclick = () => { currentCardList = listCards; renderGrid(currentCardList); };
  list.appendChild(allItem);
  for (let cat in grouped) {
    const catDiv = document.createElement('div');
    catDiv.className = 'category-item';
    const catHeader = document.createElement('div');
    catHeader.className = 'category-header';
    catHeader.innerHTML = `<i>â–¶</i>${cat}`;
    catHeader.onclick = () => {
      catHeader.classList.toggle('expanded');
      catContent.classList.toggle('expanded');
      currentCardList = Object.values(grouped[cat]).flat();
      renderGrid(currentCardList);
    };
    const catContent = document.createElement('div');
    catContent.className = 'category-content';
    for (let chap in grouped[cat]) {
      const chapDiv = document.createElement('div');
      chapDiv.className = 'chapter-item';
      chapDiv.textContent = chap;
      chapDiv.onclick = () => {
        currentCardList = grouped[cat][chap];
        renderGrid(currentCardList);
      };
      catContent.appendChild(chapDiv);
    }
    catDiv.appendChild(catHeader);
    catDiv.appendChild(catContent);
    list.appendChild(catDiv);
  }
}

// ============ ä¸»å¡ç‰‡æ¸²æŸ“/3DåŠ¨ç”»/æ­£ååˆ‡æ¢ ==============
let currentCardList = cards;
let activeReviewFilter = ()=>true;
function renderGrid(showCards = currentCardList) {
  const grid = document.getElementById('flashcard-grid');
  grid.innerHTML = '';
  showCards.forEach(card => {
    const div = document.createElement('div');
    div.className = 'flashcard';
    div.innerHTML = `
      <div class="flashcard-inner">
        <div class="flashcard-front">
          <div class="card-title">${card.front}</div>
          <div class="flashcard-tags">
            ${card.examFrequency === 'é«˜é¢‘' ? '<span class="tag high"><span class="tag-icon">â­</span>é«˜é¢‘</span>' : ''}
            ${card.level === 'é‡ç‚¹' ? '<span class="tag medium"><span class="tag-icon">ğŸ“Œ</span>é‡ç‚¹</span>' : ''}
          </div>
          <div class="card-clue">${card.clue || ''}</div>
          <div class="card-content"><span>${card.context || ''}</span></div>
        </div>
        <div class="flashcard-back">
          <div class="card-category">${card.category} > ${card.chapter}</div>
          <div class="card-content">${formatCardContent(card.back)}</div>
          <div class="card-footer">
            <div class="mastery-buttons">
              <button class="mastery-btn hard" onclick="updateMastery('${card.front}', 1, event)"><span>ğŸ˜…</span>å›°éš¾</button>
              <button class="mastery-btn medium" onclick="updateMastery('${card.front}', 3, event)"><span>ğŸ¤”</span>æ¨¡ç³Š</button>
              <button class="mastery-btn easy" onclick="updateMastery('${card.front}', 5, event)"><span>âœ¨</span>æ¸…æ™°</button>
            </div>
          </div>
        </div>
      </div>
    `;
    div.onclick = function (e) {
      // é¿å…ç‚¹å‡»æŒ‰é’®ä¹Ÿè§¦å‘ç¿»è½¬
      if (e.target.tagName === 'BUTTON' || e.target.classList.contains('mastery-btn')) return;
      this.classList.toggle('flipped');
    };
    grid.appendChild(div);
  });
}

// ============ å¡ç‰‡å†…å®¹æ ¼å¼åŒ–ï¼ˆç¼–å·/æ³¨é‡Š/é«˜äº®ï¼‰ ============
function formatCardContent(content) {
  let mainContent = content, notes = '';
  const noteMatches = content.match(/ï¼ˆ[^ï¼‰]+ï¼‰/g);
  if (noteMatches) {
    notes = noteMatches.join(' ');
    mainContent = content.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, '');
  }
  if (/1[\.ã€ï¼]/.test(mainContent)) {
    const points = mainContent.split(/(?=\d+[\.ã€ï¼])/)
      .map(point => point.trim()).filter(point => point.length > 0);
    let html = '<div class="numbered-list">';
    points.forEach(point => {
      const match = point.match(/^(\d+[\.ã€ï¼])\s*(.+)$/);
      if (match) {
        html += `<div class="list-item"><span class="number">${match[1]}</span><span class="content">${match[2]}</span></div>`;
      } else {
        html += `<div class="list-item"><span class="content">${point}</span></div>`;
      }
    });
    html += '</div>';
    if (notes) html += `<div class="note">${notes}</div>`;
    return html;
  }
  return `<p>${mainContent.replace(/\n/g, '<br>')}</p>${notes ? `<div class="note">${notes}</div>` : ''}`;
}

function truncateText(t,len=15){
  return t.length>len? t.slice(0,len)+'â€¦': t;
}

function openCard(front){
  const card = cards.find(c=>c.front===front);
  if(!card) return;
  const modal = document.getElementById('card-modal');
  modal.innerHTML = `
    <div class="card-popup" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeCardModal(event)">Ã—</button>
      <div class="popup-title">${card.front}</div>
      <div class="popup-content">
        ${card.clue ? `<div class="popup-clue">${card.clue}</div>` : ''}
        <div>${formatCardContent(card.back)}</div>
      </div>
      <div class="mastery-buttons">
        <button class="mastery-btn hard" onclick="updateMastery('${card.front}', 1, event)"><span>ğŸ˜…</span>å›°éš¾</button>
        <button class="mastery-btn medium" onclick="updateMastery('${card.front}', 3, event)"><span>ğŸ¤”</span>æ¨¡ç³Š</button>
        <button class="mastery-btn easy" onclick="updateMastery('${card.front}', 5, event)"><span>âœ¨</span>æ¸…æ™°</button>
      </div>
    </div>`;
  modal.onclick = closeCardModal;
  modal.classList.add('active');
}

function closeCardModal(e){
  if(e) e.stopPropagation();
  const modal = document.getElementById('card-modal');
  modal.classList.remove('active');
  modal.innerHTML = '';
}

// ============ æœç´¢è¿‡æ»¤ ============
function filterCards(query) {
  const q = query.trim().toLowerCase();
  const base = cards.filter(activeReviewFilter);
  if (!q) {
    renderGrid(base);
    currentCardList = base;
    return;
  }
  const filtered = base.filter(card =>
    card.front.toLowerCase().includes(q) ||
    card.back.toLowerCase().includes(q) ||
    card.category.toLowerCase().includes(q) ||
    card.chapter.toLowerCase().includes(q) ||
    (card.level || '').toLowerCase().includes(q)
  );
  currentCardList = filtered;
  renderGrid(filtered);
}

// ============ é—´éš”é‡å¤ç®—æ³• ============
function getDueCards() {
  const now = new Date();
  return cards.filter(card => {
    if (!card.nextReview) return true;
    return new Date(card.nextReview) <= now;
  });
}
function spacedRepetition(card, mastery) {
  const now = new Date();
  const interval = Math.pow(2, card.reviewCount || 0) * (mastery / 5);
  card.lastReview = now.toISOString();
  card.reviewCount = (card.reviewCount || 0) + 1;
  card.mastery = mastery;
  const next = new Date(now);
  next.setDate(now.getDate() + Math.max(1, Math.round(interval)));
  card.nextReview = next.toISOString();
  card.difficulty = Math.max(0, Math.min(5, (card.difficulty || 0) + (mastery <= 2 ? 1 : mastery >= 4 ? -1 : 0)));
  return card;
}

// ============ å­¦ä¹ åé¦ˆ/æŒæ¡åº¦æŒ‰é’® ============
function updateMastery(front, mastery, event) {
  event.stopPropagation();
  const i = cards.findIndex(c => c.front === front);
  if (i === -1) return;
  cards[i] = spacedRepetition(cards[i], mastery);
  if (mastery <= 2) cards[i].wrongCount = (cards[i].wrongCount || 0) + 1;
  localStorage.setItem('flashcards', JSON.stringify(cards));
  incrementTodayStudyCount();
  updateStats();
  document.querySelectorAll('.flashcard').forEach(f => f.classList.remove('flipped'));
  setTimeout(() => {
    const base = cards.filter(activeReviewFilter);
    const due = base.filter(c=>!c.nextReview||new Date(c.nextReview)<=new Date());
    if (due.length) {
      currentCardList = due;
      renderGrid(due);
    } else {
      currentCardList = base;
      renderGrid(base);
    }
  }, 330);
}

// ============ å­¦ä¹ å¤©æ•°/æ‰“å¡ç»Ÿè®¡ ============
function getTodayStudyCount() {
  const today = new Date().toISOString().split('T')[0];
  return parseInt(localStorage.getItem(`study_count_${today}`) || '0');
}
function incrementTodayStudyCount() {
  const today = new Date().toISOString().split('T')[0];
  const count = getTodayStudyCount();
  localStorage.setItem(`study_count_${today}`, count + 1);
}
function getStudyStreak() {
  let streak = 0;
  const today = new Date(), curr = new Date(today);
  while (1) {
    const dateStr = curr.toISOString().split('T')[0];
    if (parseInt(localStorage.getItem(`study_count_${dateStr}`) || '0') === 0) break;
    streak++;
    curr.setDate(curr.getDate() - 1);
  }
  return streak;
}

// ============ å€’è®¡æ—¶ ============
function updateCountdown() {
  // é»˜è®¤è€ƒç ”12æœˆ23æ—¥
  const now = new Date(), year = now.getFullYear();
  const target = new Date(year, 11, 23);
  let days = Math.ceil((target - now) / 86400000);
  if (days < 0) days = Math.ceil((new Date(year + 1, 11, 23) - now) / 86400000);
  document.getElementById('countdown').textContent = days + 'å¤©';
}

// ============ æ‰¹é‡å¯¼å…¥å¯¼å‡º =============
function showImportModal() {
  const modalRoot = document.getElementById('import-modal-root');
  modalRoot.innerHTML = `
  <div>
    <div class="modal-content">
      <h3>æ‰¹é‡å¯¼å…¥é¢˜åº“</h3>
      <p>ç²˜è´´ç¬¦åˆæ ¼å¼çš„JSONæ•°ç»„ï¼Œæˆ–ä¸Šä¼ .jsonæ–‡ä»¶ï¼š</p>
      <pre class="import-hint">[
  {"front":"é¢˜å¹²","back":"ç­”æ¡ˆ","category":"ç§‘ç›®","chapter":"ç« èŠ‚"}
]</pre>
      <textarea id="import-json"></textarea>
      <input type="file" id="import-file" accept=".json">
      <div style="text-align:right;margin-top:10px;">
        <button class="btn-secondary" onclick="document.getElementById('import-modal-root').innerHTML=''">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="processImport()">å¯¼å…¥</button>
      </div>
    </div>
  </div>`;
  document.getElementById('import-file').onchange = function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (ev) {
      document.getElementById('import-json').value = ev.target.result;
    };
    reader.readAsText(file);
  };
}
function processImport() {
  let importData;
  try {
    importData = JSON.parse(document.getElementById('import-json').value);
    if (!Array.isArray(importData)) throw Error('è¯·ç²˜è´´JSONæ•°ç»„æ ¼å¼');
    importData.forEach(card => {
      if (!card.front || !card.back || !card.category || !card.chapter) throw Error('æ¯æ¡éœ€å«front,back,category,chapter');
      card.lastReview = null; card.nextReview = null; card.reviewCount = 0; card.difficulty = 0; card.mastery = 0; card.wrongCount = 0;
    });
    // å»é‡
    const fronts = new Set(cards.map(c => c.front));
    const newCards = importData.filter(card => !fronts.has(card.front));
    cards = cards.concat(newCards);
    localStorage.setItem('flashcards', JSON.stringify(cards));
    document.getElementById('import-modal-root').innerHTML = '';
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats();
    alert('å¯¼å…¥æˆåŠŸï¼æ–°å¢' + newCards.length + 'æ¡');
  } catch (e) {
    alert('å¯¼å…¥å¤±è´¥:' + e.message);
  }
}
function addNewCard() {
  const front = prompt('è¾“å…¥é¢˜å¹²(æ­£é¢)...');
  if (!front) return;
  const back = prompt('è¾“å…¥ç­”æ¡ˆ(èƒŒé¢)...');
  if (!back) return;
  const category = prompt('æ‰€å±ç§‘ç›®/åˆ†ç±»?', 'æœªåˆ†ç±»');
  const chapter = prompt('æ‰€å±ç« èŠ‚?', 'æœªåˆ†ç« ');
  cards.push({
    front, back, category, chapter,
    level: 'åŸºç¡€', examFrequency: 'ä½é¢‘', lastReview: null, nextReview: null, reviewCount: 0, difficulty: 0, mastery: 0, wrongCount: 0
  });
  localStorage.setItem('flashcards', JSON.stringify(cards));
  const filtered = cards.filter(activeReviewFilter);
  updateCardList(filtered); renderGrid(filtered); updateStats();
}

// ============ ç¬”è®°ç³»ç»Ÿ ============
let notes = JSON.parse(localStorage.getItem('flashcardNotes') || '{"quick":{},"organized":{}}');
function switchNoteTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('.tab-btn[data-tab="' + tab + '"]').classList.add('active');
  document.getElementById(tab + '-note').classList.add('active');
}
function saveNote() {
  const tab = document.querySelector('.tab-btn.active').dataset.tab;
  const today = new Date().toISOString().split('T')[0];
  if (tab === 'quick') {
    notes.quick[today] = document.getElementById('quick-textarea').value;
  } else {
    const cat = document.getElementById('note-category').value;
    const title = document.querySelector('.note-title').value;
    const content = document.getElementById('organized-textarea').value;
    if (!cat) return alert('è¯·é€‰æ‹©åˆ†ç±»');
    if (!notes.organized[cat]) notes.organized[cat] = [];
    notes.organized[cat].push({ title, content, date: today });
  }
  localStorage.setItem('flashcardNotes', JSON.stringify(notes));
  alert('ç¬”è®°å·²ä¿å­˜');
}
function addNoteCategory() {
  const cat = prompt('è¾“å…¥æ–°åˆ†ç±»å');
  if (!cat) return;
  if (!notes.organized[cat]) notes.organized[cat] = [];
  updateNoteCategories();
}
function updateNoteCategories() {
  const sel = document.getElementById('note-category');
  if (!sel) return;
  sel.innerHTML = '<option value="">é€‰æ‹©åˆ†ç±»...</option>' +
    Object.keys(notes.organized).map(c => `<option value="${c}">${c}</option>`).join('');
}
function viewNoteHistory() {
  alert('å†å²ç¬”è®°è¯·åˆ°æ§åˆ¶å°è¾“å…¥ï¼šnotes æŸ¥çœ‹ï¼Œä¹Ÿå¯åç»­è‡ªå®šä¹‰å¼¹çª—...');
}

// ============ é¡µé¢åˆå§‹åŒ– ============
function initializeApp() {
  const filtered = cards.filter(activeReviewFilter);
  updateCardList(filtered);
  renderGrid(filtered);
  updateStats();
  updateCountdown();
  updateNoteCategories();
  // æ¢å¤ç¬”è®°è¾“å…¥
  if (notes.quick) {
    const latest = Object.keys(notes.quick).sort().pop();
    if (latest) document.getElementById('quick-textarea').value = notes.quick[latest];
  }
}
window.onload = initializeApp;
</script>

<script>
// =========== æ‰©å±•1ï¼šå¤ä¹ æ¨¡å¼åˆ‡æ¢ ===========
function showReviewMenu() {
  const opts = [
    {name:'åº”å¤ä¹ ',    filter:card=>!card.nextReview||new Date(card.nextReview)<=new Date()},
    {name:'ä»Šæ—¥å·²å­¦',  filter:card=>card.lastReview && new Date(card.lastReview).toDateString()===new Date().toDateString()},
    {name:'æœ¬å‘¨å·²å­¦',  filter:card=>card.lastReview && (new Date()-new Date(card.lastReview))<=7*86400000},
    {name:'é«˜é¢‘è€ƒç‚¹',  filter:card=>card.examFrequency==='é«˜é¢‘'},
    {name:'é”™é¢˜æœ¬',    filter:card=>(card.wrongCount||0)>=2 || card.mastery<3},
    {name:'å…¨éƒ¨å¡ç‰‡',  filter:()=>true},
    {name:'ä¹±åº',       filter:()=>true, shuffle:true}
  ];
  let html = '<div class="modal-content"><h3>é€‰æ‹©å¤ä¹ æ¨¡å¼</h3>';
  opts.forEach((opt,i)=>{
    html += `<button class="btn-primary" style="margin:7px 0;width:100%;" onclick="applyReviewMode(${i})">${opt.name}</button>`;
  });
  html += `<div style="text-align:right"><button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button></div></div>`;
  showModal(html);
}
function applyReviewMode(idx) {
  const opts = [
    {name:'åº”å¤ä¹ ',    filter:card=>!card.nextReview||new Date(card.nextReview)<=new Date()},
    {name:'ä»Šæ—¥å·²å­¦',  filter:card=>card.lastReview && new Date(card.lastReview).toDateString()===new Date().toDateString()},
    {name:'æœ¬å‘¨å·²å­¦',  filter:card=>card.lastReview && (new Date()-new Date(card.lastReview))<=7*86400000},
    {name:'é«˜é¢‘è€ƒç‚¹',  filter:card=>card.examFrequency==='é«˜é¢‘'},
    {name:'é”™é¢˜æœ¬',    filter:card=>(card.wrongCount||0)>=2 || card.mastery<3},
    {name:'å…¨éƒ¨å¡ç‰‡',  filter:()=>true},
    {name:'ä¹±åº',       filter:()=>true, shuffle:true}
  ];
  const opt = opts[idx];
  activeReviewFilter = opt.filter;
  let base = cards.filter(opt.filter);
  if(opt.shuffle) base = base.sort(()=>Math.random()-.5);
  currentCardList = base;
  renderGrid(base);
  updateCardList(base);
  closeModal();
}
function showModal(html) {
  document.getElementById('import-modal-root').innerHTML = `<div><div class="modal-content">${html}</div></div>`;
}
function closeModal() {
  document.getElementById('import-modal-root').innerHTML = '';
}

// =========== æ‰©å±•2ï¼šå¡ç‰‡å¯¼å‡º ===========
function exportCards() {
  const data = JSON.stringify(cards,null,2);
  const blob = new Blob([data], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'flashcards_backup_'+Date.now()+'.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
document.addEventListener('keydown', e=>{
  // å¿«æ·é”® Ctrl+E å¯¼å‡º
  if(e.ctrlKey && e.key==='e') { e.preventDefault(); exportCards(); }
});

// =========== æ‰©å±•3ï¼šå¡ç‰‡ç¼–è¾‘/åˆ é™¤ ===========
function showEditCard(front) {
  const i = cards.findIndex(c=>c.front===front);
  if(i===-1) return;
  const card = cards[i];
  let html = `
  <h3>ç¼–è¾‘å¡ç‰‡</h3>
  <label>é¢˜å¹²(æ­£é¢):<input type="text" id="edit-front" value="${card.front}" style="width:95%;margin-bottom:7px;"></label><br>
  <label>ç­”æ¡ˆ(èƒŒé¢):<textarea id="edit-back" style="width:95%;height:70px;">${card.back}</textarea></label><br>
  <label>ç§‘ç›®:<input type="text" id="edit-category" value="${card.category}" style="width:45%;"></label>
  <label>ç« èŠ‚:<input type="text" id="edit-chapter" value="${card.chapter}" style="width:45%;"></label><br>
  <label>é«˜é¢‘:<input type="checkbox" id="edit-high" ${card.examFrequency==='é«˜é¢‘'?'checked':''}></label>
  <label>é‡ç‚¹:<input type="checkbox" id="edit-key" ${card.level==='é‡ç‚¹'?'checked':''}></label>
  <div style="text-align:right;margin-top:13px;">
    <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
    <button class="btn-save" onclick="doEditCard('${front}')">ä¿å­˜</button>
    <button class="btn-primary" style="background:#f44;color:#fff;margin-left:8px;" onclick="deleteCard('${front}')">åˆ é™¤</button>
  </div>`;
  showModal(html);
}
function doEditCard(oldFront) {
  const i = cards.findIndex(c=>c.front===oldFront);
  if(i===-1) return alert('æœªæ‰¾åˆ°å¡ç‰‡');
  const newFront = document.getElementById('edit-front').value.trim();
  const newBack = document.getElementById('edit-back').value;
  const newCat = document.getElementById('edit-category').value;
  const newChap = document.getElementById('edit-chapter').value;
  cards[i].front = newFront; cards[i].back = newBack; cards[i].category = newCat; cards[i].chapter = newChap;
  cards[i].examFrequency = document.getElementById('edit-high').checked ? 'é«˜é¢‘' : 'ä½é¢‘';
  cards[i].level = document.getElementById('edit-key').checked ? 'é‡ç‚¹' : 'åŸºç¡€';
  localStorage.setItem('flashcards',JSON.stringify(cards));
  const filtered = cards.filter(activeReviewFilter);
  updateCardList(filtered); renderGrid(filtered);
  closeModal();
}
function deleteCard(front) {
  if(!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
  cards = cards.filter(c=>c.front!==front);
  localStorage.setItem('flashcards',JSON.stringify(cards));
  const filtered = cards.filter(activeReviewFilter);
  updateCardList(filtered); renderGrid(filtered);
  closeModal();
}

// é‡ç»˜å¡ç‰‡å¢™åŠç¼–è¾‘
renderGrid = function(showCards=currentCardList) {
  const grid = document.getElementById('flashcard-grid');
  grid.innerHTML = '';
  showCards.forEach(card => {
    const div = document.createElement('div');
    div.className = 'flashcard-thumb';
    div.innerHTML = `<div class="thumb-title">${truncateText(card.front)}</div>` +
                    `<div class="thumb-clue">${truncateText(card.clue || card.context || '', 24)}</div>`;
    div.onclick = () => openCard(card.front);
    grid.appendChild(div);
  });
};
// ä¾§è¾¹æ ç« èŠ‚æ”¯æŒç¼–è¾‘ï¼ˆé•¿æŒ‰ï¼‰
document.addEventListener('contextmenu',function(e){
  if(e.target.classList.contains('chapter-item')){
    e.preventDefault();
    const chap = e.target.textContent;
    const catDiv = e.target.closest('.category-item');
    const cat = catDiv.querySelector('.category-header').textContent.replace(/â–¶/,'').trim();
    const cardsIn = cards.filter(c=>c.category===cat&&c.chapter===chap);
    if(!confirm(`è¦åˆ é™¤â€œ${cat} > ${chap}â€ä¸‹çš„${cardsIn.length}å¼ å¡ç‰‡ï¼Ÿ`)) return;
    cards = cards.filter(c=>!(c.category===cat&&c.chapter===chap));
    localStorage.setItem('flashcards',JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered);
  }
},false);

// =========== æ‰©å±•4ï¼šå†å²å­¦ä¹ è®°å½•ç®€è¦æŸ¥çœ‹ ===========
function viewNoteHistory() {
  let html = '<h3>å†å²ç¬”è®°ï¼ˆæœ€æ–°10æ¡ï¼‰</h3><ul style="max-height:260px;overflow:auto;">';
  const recs = [];
  Object.values(notes.quick||{}).forEach((txt,date)=>{recs.push({txt,date});});
  Object.values(notes.organized||{}).forEach(arr=>{
    arr.forEach(note=>{recs.push({txt:note.title+' '+note.content,date:note.date});});
  });
  recs.sort((a,b)=>b.date.localeCompare(a.date));
  recs.slice(0,10).forEach(r=>{
    html += `<li style="margin-bottom:9px;font-size:14px;"><b>${r.date||''}</b>ï¼š${r.txt.substring(0,80)}...</li>`;
  });
  html += '</ul><div style="text-align:right"><button class="btn-secondary" onclick="closeModal()">å…³é—­</button></div>';
  showModal(html);
}

// =========== æ‰©å±•5ï¼šè‡ªå®šä¹‰å€’è®¡æ—¶ç›®æ ‡æ—¥æœŸ ===========
function updateCountdown() {
  let dt = localStorage.getItem('examDate') || '';
  let date = dt ? new Date(dt) : new Date(new Date().getFullYear(), 11, 23);
  const now = new Date();
  let days = Math.ceil((date - now) / 86400000);
  if (days < 0) days = 0;
  document.getElementById('countdown').textContent = days + 'å¤©';
  document.querySelector('.countdown-label').onclick = function() {
    const input = prompt('è‡ªå®šä¹‰ç›®æ ‡æ—¥æœŸï¼ˆæ ¼å¼: 2024-12-21ï¼‰', dt || '');
    if(input){
      localStorage.setItem('examDate',input);
      updateCountdown();
    }
  }
}

// =========== æ‰©å±•6ï¼šä¸»ç•Œé¢æŒ‰é’®æ·»åŠ  ===========
const btns = document.createElement('div');
btns.style.margin = "12px 0 0 0";
btns.innerHTML = `
  <button class="btn-primary" onclick="showReviewMenu()" style="width:98%;margin-bottom:8px;">å¤ä¹ æ¨¡å¼</button>
  <button class="btn-primary" onclick="exportCards()" style="width:98%;margin-bottom:8px;">å¯¼å‡ºå¡ç‰‡</button>
`;
document.querySelector('.sidebar .action-buttons').prepend(btns);

// =========== åŠ¨ç”»å¾®äº¤äº’/æ›´å¤š ===========
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.btn-primary,.btn-secondary,.btn-save,.mastery-btn').forEach(btn=>{
    btn.onmousedown = ()=>{ btn.style.transform="scale(0.97)"; }
    btn.onmouseup = btn.onmouseleave = ()=>{ btn.style.transform=""; }
  });
});
</script>
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>DeepSeek AIåŠ©æ‰‹</title>
  <style>
    body { font-family: sans-serif; background: #f9fafc; margin: 0; }
    #chatbox { width: 460px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 6px 24px #9992; padding: 24px; }
    #history { min-height: 180px; margin-bottom: 18px; }
    .msg { margin: 8px 0; }
    .user { color: #2196f3; }
    .ai { color: #4caf50; }
    #askbox { display: flex; gap: 8px; }
    #prompt { flex: 1; padding: 8px 11px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
    #ask { padding: 8px 19px; background: #6366f1; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    #ask:disabled { opacity: 0.5; }
    #apikey { margin-top: 16px; width: 100%; padding: 8px 11px; border-radius: 6px; border: 1px solid #ddd; }
  </style>
<!-- AIåŠ©æ‰‹æ‚¬æµ®æŒ‰é’® -->
<div id="ai-helper-btn" style="position:fixed;right:32px;bottom:36px;z-index:9999;">
  <button onclick="openAIHelper()" style="width:62px;height:62px;border-radius:50%;border:none;box-shadow:0 2px 15px #9ba5cc22;background:#6366f1;color:#fff;font-size:33px;cursor:pointer;">ğŸ¤–</button>
</div>
<!-- AIåŠ©æ‰‹ä¸»å¼¹çª— -->
<div id="ai-helper-modal" style="display:none;position:fixed;right:34px;bottom:110px;z-index:10000;">
  <div style="width:410px;max-width:98vw;max-height:82vh;box-shadow:0 8px 42px #2932762a;border-radius:20px;background:#fff;display:flex;flex-direction:column;overflow:hidden;">
    <!-- é¡¶æ  -->
    <div style="height:54px;display:flex;align-items:center;justify-content:space-between;padding:0 20px 0 17px;background:#f4f7fd;border-bottom:1px solid #ececec;">
      <span style="font-weight:700;font-size:17px;color:#6366f1;">AI è€ƒç ”åŠ©æ‰‹</span>
      <div>
        <button onclick="exportChatHistory()" title="å¯¼å‡ºå¯¹è¯" style="background:none;border:none;font-size:17px;color:#36a269;cursor:pointer;margin-right:5px;">â¬‡ï¸</button>
        <button onclick="openKeySetting()" title="API Keyè®¾ç½®" style="background:none;border:none;font-size:17px;color:#9799bb;cursor:pointer;margin-right:9px;">ğŸ”‘</button>
        <button onclick="closeAIHelper()" style="background:none;border:none;font-size:26px;color:#8e98bc;cursor:pointer;">Ã—</button>
      </div>
    </div>
    <!-- å¿«æ·é¢„è®¾ -->
    <div id="ai-quick-presets" style="padding:7px 15px 2px 15px;background:#fafaff;border-bottom:1px solid #f0f1f6;display:flex;gap:8px;overflow-x:auto;white-space:nowrap;">
      <button onclick="presetInsert('å¸®æˆ‘æ€»ç»“ä¸€ä¸‹å…¬å…±ç®¡ç†å­¦æ ¸å¿ƒç†è®ºæ¡†æ¶ã€‚')" class="preset-btn">å…¬å…±ç®¡ç†å­¦ç†è®º</button>
      <button onclick="presetInsert('è¯·åˆ†æå½“å‰æˆ‘å›½å…¬å…±æœåŠ¡æ”¹é©çš„éš¾ç‚¹ä¸å¯¹ç­–ã€‚')" class="preset-btn">å…¬å…±æœåŠ¡éš¾ç‚¹</button>
      <button onclick="presetInsert('æ¨¡æ‹Ÿè€ƒç ”çœŸé¢˜ï¼šè°ˆè°ˆâ€œæ–°å…¬å…±ç®¡ç†â€ä¸ä¼ ç»Ÿå…¬å…±ç®¡ç†çš„åŒºåˆ«ã€‚')" class="preset-btn">æ–°æ—§å¯¹æ¯”</button>
      <button onclick="presetInsert('è€ƒç‚¹èƒŒè¯µå£è¯€')" class="preset-btn">èƒŒè¯µå£è¯€</button>
      <button onclick="presetInsert('è¯·åˆ—å‡ºè¿‘äº”å¹´å…¬å…±ç®¡ç†è€ƒç ”é«˜é¢‘é¢˜ã€‚')" class="preset-btn">é«˜é¢‘çœŸé¢˜</button>
      <button onclick="presetInsert('')" class="preset-btn">è‡ªå®šä¹‰</button>
    </div>
    <!-- å¯¹è¯å†å² -->
    <div id="ai-chat-content" style="flex:1;overflow-y:auto;padding:15px 14px 7px 14px;font-size:15px;line-height:1.8;color:#353c52;"></div>
    <!-- è¾“å…¥åŒº -->
    <div style="padding:9px 13px 12px 13px;background:#f7f9fc;display:flex;gap:7px;">
      <!-- è¯­éŸ³æŒ‰é’® -->
      <button id="ai-mic-btn" onclick="startVoiceInput()" title="è¯­éŸ³è¾“å…¥" style="width:40px;height:40px;border-radius:50%;border:none;background:#e2e9fd;color:#6366f1;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;">ğŸ¤</button>
      <form id="ai-chat-form" style="flex:1;display:flex;gap:7px;" onsubmit="return sendAIMessage();">
        <input id="ai-chat-input" autocomplete="off" style="flex:1;padding:10px 12px;border-radius:12px;border:1px solid #dde2ef;font-size:15px;background:#fff;outline:none;" placeholder="è¾“å…¥ä½ çš„è€ƒç ”é—®é¢˜/æŒ‡ä»¤ï¼Œå›è½¦å‘é€..." />
        <select id="ai-model" style="padding:0 8px 0 6px;border-radius:8px;border:1px solid #dde2ef;background:#f9fafd;font-size:15px;color:#656780;">
          <option value="deepseek-chat">DeepSeek-Chat</option>
          <option value="deepseek-reasoner">DeepSeek-Reasoner</option>
        </select>
        <button type="submit" style="padding:0 18px;height:38px;border-radius:12px;border:none;background:#6366f1;color:#fff;font-size:16px;font-weight:500;cursor:pointer;">å‘é€</button>
      </form>
    </div>
  </div>
</div>
<style>
@media (max-width:600px) {
  #ai-helper-modal > div { width:98vw !important; right:0 !important; border-radius:0 !important; }
  #ai-helper-modal { right:0 !important; bottom:0 !important; }
  #ai-helper-btn { right:16px !important; bottom:16px !important; }
}
.preset-btn{border:none;background:#eaf0fd;color:#4364ae;border-radius:8px;padding:4px 10px;font-size:14px;cursor:pointer;margin:0 0 4px 0;}
.preset-btn:hover{background:#d9e6fb;}
.ai-msg { margin-bottom:12px; display: flex; align-items: flex-start; }
.ai-user { justify-content: flex-end; }
.ai-bubble { max-width: 83%; border-radius: 14px; padding: 9px 13px 9px 12px; margin:0 0 0 8px; word-break: break-word; }
.ai-bubble-user { background: #e9eafe; color: #494a7c; border-bottom-right-radius: 6px; }
.ai-bubble-ai { background: #f6f7fe; color: #36a269; border-bottom-left-radius: 6px; }
.ai-avatar { width:32px; height:32px; border-radius:50%; background:#f0f2ff; color:#6366f1; font-size:22px; display:flex; align-items:center; justify-content:center;}
.ai-avatar-user {background:#d7ebff; color:#4f7fc9;}
</style>
<script>
const AI_LOCAL_KEY = "ai_study_chat_history_v2";
let aiHistory = [];
let voiceRec = null, voiceActive = false;

function presetInsert(text){
  const input = document.getElementById('ai-chat-input');
  input.value = text;
  input.focus();
}
function renderHistory(){
  const el = document.getElementById('ai-chat-content');
  el.innerHTML = '';
  aiHistory.forEach(msg => {
    if(msg.role==='user'){
      el.innerHTML += `
      <div class="ai-msg ai-user">
        <div class="ai-bubble ai-bubble-user">${escapeHTML(msg.content)}</div>
        <div class="ai-avatar ai-avatar-user">ä½ </div>
      </div>`;
    } else if(msg.role==='assistant'){
      el.innerHTML += `
      <div class="ai-msg">
        <div class="ai-avatar">ğŸ¤–</div>
        <div class="ai-bubble ai-bubble-ai">${renderMarkdown(msg.content)}</div>
      </div>`;
    }
  });
  setTimeout(()=>{el.scrollTop = el.scrollHeight}, 20);
}
function saveHistory(){ localStorage.setItem(AI_LOCAL_KEY, JSON.stringify(aiHistory)); }
function openAIHelper(){
  document.getElementById('ai-helper-modal').style.display = 'block';
  aiHistory = JSON.parse(localStorage.getItem(AI_LOCAL_KEY)||"[]");
  renderHistory();
  setTimeout(()=>{document.getElementById('ai-chat-input').focus()}, 120);
}
function closeAIHelper(){ document.getElementById('ai-helper-modal').style.display = 'none'; }
function openKeySetting(){
  const key = prompt('è¾“å…¥ä½ çš„DeepSeek API KEYï¼ˆè‡ªåŠ¨æœ¬åœ°ä¿å­˜ï¼‰', localStorage.getItem('deepseek_api_key')||'');
  if(key) localStorage.setItem('deepseek_api_key', key.trim());
}
function exportChatHistory(){
  let txt = '';
  aiHistory.forEach(m => {
    txt += (m.role==='user' ? 'ä½ : ' : 'AI: ') + m.content.replace(/\n/g, '\r\n')+'\r\n\r\n';
  });
  const blob = new Blob([txt], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = "AIåŠ©æ‰‹å¯¹è¯å†å².txt";
  document.body.appendChild(a); a.click(); setTimeout(()=>{a.remove(); URL.revokeObjectURL(url)}, 100);
}
// è¯­éŸ³è¾“å…¥
function startVoiceInput(){
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
    alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼ˆæ¨èä½¿ç”¨Chromeï¼‰"); return;
  }
  if(voiceActive) { // ç»ˆæ­¢
    voiceRec && voiceRec.stop();
    voiceActive = false;
    document.getElementById('ai-mic-btn').style.background='#e2e9fd';
    return;
  }
  const rec = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  voiceRec = rec;
  rec.continuous = false; rec.lang = "zh-CN";
  rec.interimResults = false;
  rec.onstart = function(){ voiceActive = true; document.getElementById('ai-mic-btn').style.background='#b1cbfb'; }
  rec.onerror = function(e){voiceActive=false;document.getElementById('ai-mic-btn').style.background='#e2e9fd';}
  rec.onend = function(){voiceActive=false;document.getElementById('ai-mic-btn').style.background='#e2e9fd';}
  rec.onresult = function(event){
    let r = event.results[0][0].transcript.trim();
    if(r){
      const input = document.getElementById('ai-chat-input');
      input.value = r;
      input.focus();
    }
  };
  rec.start();
}

// å‘é€å¹¶æµå¼è¾“å‡º
async function sendAIMessage(){
  const input = document.getElementById('ai-chat-input');
  let msg = input.value.trim();
  if(!msg) return false;
  aiHistory.push({role:"user", content:msg});
  saveHistory(); renderHistory();
  input.value = "";
  const el = document.getElementById('ai-chat-content');
  // æ˜¾ç¤ºAI loadingæ°”æ³¡
  const aid = 'ai_'+Date.now();
  el.innerHTML += `<div class="ai-msg" id="${aid}"><div class="ai-avatar">ğŸ¤–</div>
    <div class="ai-bubble ai-bubble-ai"><span id="${aid}_c" style="white-space:pre-line;color:#adb3c2;">AIåŠ©æ‰‹è¾“å‡ºä¸­...</span></div></div>`;
  el.scrollTop = el.scrollHeight;

  try {
    const key = localStorage.getItem('deepseek_api_key') || prompt('è¯·å…ˆå¡«å†™API Key');
    if(!key){document.getElementById(aid).remove();return false;}
    const model = document.getElementById('ai-model').value || "deepseek-chat";
    // å¤šè½®å¯¹è¯ä¼ å†å²
    const body = {
      model: model,
      messages: [
        {role: "system", content: "ä½ æ˜¯è€ƒç ”å…¬å…±ç®¡ç†æ–¹å‘AIåŠ©æ‰‹ï¼Œå›ç­”å°½å¯èƒ½è¯¦ç»†ã€æœ‰æ¡ç†ï¼Œå†…å®¹é€‚åˆèƒŒè¯µå’Œç†è§£ï¼Œé‡åˆ°ä¸»è§‚æ€§é—®é¢˜è¦ç»™å‡ºå­¦ä¹ å»ºè®®ã€‚"},
        ...aiHistory.slice(-8)
      ],
      stream: true
    };
    // å…¼å®¹stream, ç”¨Fetch+reader
    const resp = await fetch("https://api.deepseek.com/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer "+key },
      body: JSON.stringify(body)
    });
    if(!resp.body) throw new Error("APIæ— è¿”å›ä½“");
    const reader = resp.body.getReader();
    let full = "", buf = "";
    const decoder = new TextDecoder();
    while(true){
      const {done,value} = await reader.read();
      if(done) break;
      buf += decoder.decode(value, {stream:true});
      let arr = buf.split('\n\n');
      buf = arr.pop();
      for(const chunk of arr){
        const json = chunk.replace(/^data: /,'').trim();
        if(json==="[DONE]") continue;
        if(!json) continue;
        let delta;
        try { delta = JSON.parse(json); }catch{}
        if(delta && delta.choices && delta.choices[0].delta && delta.choices[0].delta.content){
          full += delta.choices[0].delta.content;
          document.getElementById(aid+"_c").innerHTML = renderMarkdown(escapeHTML(full));
          el.scrollTop = el.scrollHeight;
        }
      }
    }
    aiHistory.push({role:"assistant", content:full.trim()});
    saveHistory(); renderHistory();
  }catch(e){
    document.getElementById(aid+"_c").innerHTML = "<span style='color:#f43f5e'>AIåŠ©æ‰‹å¼‚å¸¸ï¼š"+escapeHTML(e.message)+"</span>";
  }
  return false;
}
function escapeHTML(str){ return str.replace(/[<>&"]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c])); }
function renderMarkdown(str){
  return str.replace(/```([\s\S]+?)```/g, '<pre style="background:#f2f3fa;border-radius:8px;padding:8px 11px;">$1</pre>')
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
    .replace(/\*(.+?)\*/g, '<i>$1</i>')
    .replace(/^\d+\.(.+)$/gm, '<span style="color:#8366f1;font-weight:bold;">$&</span>');
}
</script>
