<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ÁßëÂ≠¶Èó™Âç°ËÉåËØµÁ≥ªÁªü</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--
    Êú¨Â∫îÁî®ÊòØ‰∏Ä‰∏™Âü∫‰∫éÊµèËßàÂô®ÁöÑÈó™Âç°Â≠¶‰π†Â∑•ÂÖ∑„ÄÇÂÆÉÊîØÊåÅÂàÜÁ±ª„ÄÅÁ´†ËäÇÂíåÊ†áÁ≠æÁÆ°ÁêÜÔºå
    ÂÜÖÁΩÆÈó¥ÈöîÈáçÂ§çÁÆóÊ≥ïÔºåÊîØÊåÅÊâπÈáèÂØºÂÖ•/ÂØºÂá∫„ÄÅÈîôÈ¢òÊú¨„ÄÅÂ§ç‰π†Ê®°Âºè„ÄÅÁ¨îËÆ∞Á≥ªÁªüÁ≠âÂäüËÉΩ„ÄÇ
    Âú®ÂéüÊúâÂäüËÉΩÁöÑÂü∫Á°Ä‰∏äÂºïÂÖ•‰∫ÜÊ†áÁ≠æËøáÊª§ÂíåÂç°ÁâáÈìæÊé•ÂäüËÉΩÔºåÊñπ‰æøÁî®Êà∑ÊûÑÂª∫Ëá™Â∑±ÁöÑÁü•ËØÜÁΩëÁªú„ÄÇ
  -->
  <style>
    html,body { height: 100%; margin: 0; padding: 0; background: #f5f7fa; color: #222; }
    body { font-family: 'Roboto Slab', 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; }
    .container {
      display: grid;
      grid-template-columns: 300px 1fr 320px;
      gap: 28px;
      max-width: 1480px;
      margin: 0 auto;
      padding: 24px 14px 38px 14px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .sidebar, .tools-section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 20px #24335608, 0 1px 2px #24335611;
      padding: 28px 20px 22px 20px;
      min-width: 0;
      min-height: 650px;
      max-height: 92vh;
      position: sticky;
      top: 22px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow-y: auto;
    }
    .sidebar { align-self: start; }
    .tools-section { align-self: start; }
    .flashcard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      grid-auto-rows: max-content;
      gap: 28px;
      align-items: stretch;
      justify-items: stretch;
      padding: 20px;
      padding-bottom: 40px;
      max-height: 92vh;
      overflow-y: auto;
    }
    /* Áº©Áï•Âç°ÁâáÊ†∑Âºè */
    .flashcard-thumb {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      min-height: 120px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      text-align: left;
      cursor: pointer;
      overflow: hidden;
      transition: transform .2s;
    }
    .flashcard-thumb:hover { transform: scale(1.05); }
    .flashcard-thumb .thumb-title { font-weight: 600; color: #334155; font-size: 1.05em; margin-bottom: 4px; }
    .flashcard-thumb .thumb-clue { color: #64748b; font-size: 0.9em; line-height: 1.4; }
    /* Âç°ÁâáÊ®°ÊÄÅÂºπÁ™ó */
    #card-modal {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(3px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 40px;
      overflow-y: auto;
      z-index: 1500;
      transition: opacity 0.3s ease;
      opacity: 1;
    }
    #card-modal.active { display: flex; animation: fadeIn 0.25s; }
    #card-modal .card-popup {
      background: #fff;
      max-width: 720px;
      width: 100%;
      max-height: 80vh;
      padding: 32px;
      border-radius: 20px;
      position: relative;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
    }
    #card-modal .close-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      background: #f8fafc;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      cursor: pointer;
    }
    #card-modal .popup-title { font-size: 1.3em; font-weight: 700; margin-bottom: 12px; }
    #card-modal .popup-content { flex: 1; overflow-y: auto; line-height: 1.6; margin-bottom: 18px; color: #374151; }
    #card-modal .popup-clue { color: #64748b; margin-bottom: 12px; }
    #card-modal .mastery-buttons { justify-content: center; margin-top: 10px; }
    /* Ê†áÁ≠æËøáÊª§Âå∫Ê†∑Âºè */
    #tag-list { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px; }
    .tag-item {
      display: inline-block;
      background: #e5e7eb;
      color: #374151;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .tag-item:hover {
      background: #c7d2fe;
      color: #4338ca;
    }
    /* Â≠¶‰π†ÁªüËÆ°Âå∫ */
    .progress-ring { position: relative; width: 60px; height: 60px; }
    .progress-ring-circle-bg { fill: none; stroke: #e2e8f0; stroke-width: 4; }
    .progress-ring-circle {
      fill: none;
      stroke: #6366f1;
      stroke-width: 4;
      transform: rotate(-90deg);
      transform-origin: center;
      transition: stroke-dashoffset 0.3s ease;
    }
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 15px;
      font-weight: 600;
      color: #6366f1;
      pointer-events: none;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-item {
      background: #f8fafc;
      padding: 10px 0 6px 0;
      border-radius: 13px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.17s;
      font-size: 15px;
    }
    .stat-item.highlight { background: linear-gradient(135deg,#6366f1,#3b82f6); color: #fff; }
    .stat-label { font-size: 13px; color: #64748b; }
    .stat-item.highlight .stat-label, .stat-item.highlight .stat-value { color: #fff; }
    .stat-value { font-size: 20px; font-weight: 600; color: #1a202c; }
    .study-streak { display: flex; justify-content: space-between; background: #f8fafc; padding: 13px 16px; border-radius: 12px; }
    .streak-info, .today-count { display: flex; flex-direction: column; align-items: center; }
    .streak-label, .today-label { font-size: 13px; color: #64748b; }
    .streak-value, .today-value { font-size: 16px; font-weight: 600; color: #6366f1; }
    /* ÊêúÁ¥¢ËæìÂÖ•‰∏é‰æßËæπÊ†èÂàÜÁ±ªÊ†∑Âºè */
    .search-input { width: 100%; padding: 11px 14px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 15px; background: #f8fafc; margin-bottom: 8px; }
    .search-input:focus { border-color: #6366f1; box-shadow: 0 0 0 2px #c7d2fe; }
    .search-box { position: relative; }
    .search-icon { position: absolute; right: 17px; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
    .card-list { list-style: none; padding: 0; margin: 0; }
    .category-item { margin-bottom: 14px; }
    .category-header { display: flex; align-items: center; padding: 7px 12px; background: #f8fafc; border-radius: 8px; cursor: pointer; transition: all 0.18s; }
    .category-header:hover { background: #f1f5f9; }
    .category-header i { margin-right: 8px; transition: transform 0.2s; }
    .category-header.expanded i { transform: rotate(90deg); }
    .category-content { margin-left: 20px; padding: 8px 0; display: none; }
    .category-content.expanded { display: block; }
    .chapter-item { margin: 4px 0; padding: 4px 12px; border-radius: 7px; cursor: pointer; transition: all 0.18s; }
    .chapter-item:hover { background: #e0e7ff; color: #6366f1; }
    /* ÊåâÈíÆÊ†∑Âºè */
    .btn-primary, .btn-secondary, .btn-save {
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.18s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      outline: none;
    }
    .btn-primary { background: linear-gradient(135deg, #6366f1, #3b82f6); color: #fff; }
    .btn-secondary { background: #f1f5f9; color: #1e293b; }
    .btn-save { background: #dcfce7; color: #15803d; margin-top: 12px; }
    .btn-primary:hover, .btn-secondary:hover, .btn-save:hover { filter: brightness(1.1); }
    .action-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 18px; }
    /* Á¨îËÆ∞Á≥ªÁªüUI */
    .note-section { background: #fff; border-radius: 16px; padding: 18px 14px 12px 14px; }
    .note-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 9px; }
    .tab-btn { padding: 8px 18px; border: none; border-radius: 8px; background: #f1f5f9; color: #64748b; cursor: pointer; }
    .tab-btn.active { background: #6366f1; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .note-controls { display: flex; gap: 10px; margin-bottom: 13px; }
    .note-select { flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; }
    .btn-new-category { padding: 8px 16px; background: #4ade80; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .note-editor { display: flex; flex-direction: column; gap: 10px; }
    .note-title { padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
    .note-editor textarea { height: 100px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; resize: vertical; font-size: 14px; line-height: 1.6; }
    .note-actions { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 12px; border-top: 1px solid #e2e8f0; }
    /* ÂàÜÈ°µÊåâÈíÆ */
    .page-btn { cursor: pointer; }
    /* Âä®Áîª */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .flashcard-thumb, .sidebar, .tools-section, .modal-content { animation: fadeIn 0.4s; }
  </style>
</head>
<body>
  <div class="container">
    <!-- ‰æßËæπÊ†è -->
    <div class="sidebar">
      <h3 style="margin-bottom:14px;">Áü•ËØÜÂØºËà™</h3>
      <div class="search-box">
        <input type="text" class="search-input" placeholder="ÊêúÁ¥¢Âç°Áâá..." oninput="filterCards(this.value)">
        <i class="search-icon">üîç</i>
      </div>
      <div class="card-list" id="card-list"></div>
      <h4 style="margin-top:10px;">Ê†áÁ≠æËøáÊª§</h4>
      <div id="tag-list"></div>
      <div class="action-buttons">
        <button class="btn-primary" onclick="showImportModal()"><i>üì•</i>ÂØºÂÖ•È¢òÂ∫ì</button>
        <button class="btn-secondary" onclick="addNewCard()"><i>‚ú®</i>Êñ∞Âª∫Âç°Áâá</button>
      </div>
    </div>
    <!-- ‰∏ªÂç°ÁâáÂå∫Âüü -->
    <div class="flashcard-grid" id="flashcard-grid"></div>
    <!-- Â∑•ÂÖ∑Ê†è -->
    <div class="tools-section">
      <div class="tool-card countdown">
        <span class="countdown-label">Ë∑ùÁ¶ªËÄÉÁ†îËøòÊúâ</span>
        <span class="countdown-value" id="countdown">ËÆ°ÁÆó‰∏≠...</span>
      </div>
      <div class="study-stats">
        <div class="stats-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
          <h4>Â≠¶‰π†ËøõÂ∫¶</h4>
          <div class="progress-ring">
            <svg width="60" height="60" viewBox="0 0 60 60">
              <circle class="progress-ring-circle-bg" cx="30" cy="30" r="24" />
              <circle class="progress-ring-circle" cx="30" cy="30" r="24" />
            </svg>
            <span class="progress-text">0%</span>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-item"><span class="stat-label">Â∑≤ÊéåÊè°</span><span class="stat-value" id="stat-mastered">0</span></div>
          <div class="stat-item"><span class="stat-label">Â§ç‰π†‰∏≠</span><span class="stat-value" id="stat-reviewing">0</span></div>
          <div class="stat-item"><span class="stat-label">Êú™Â≠¶‰π†</span><span class="stat-value" id="stat-new">0</span></div>
          <div class="stat-item highlight"><span class="stat-label">È´òÈ¢ëËÄÉÁÇπ</span><span class="stat-value" id="stat-high">0</span></div>
        </div>
        <div class="study-streak">
          <div class="streak-info">
            <span class="streak-label">ËøûÁª≠Â≠¶‰π†</span>
            <span class="streak-value" id="stat-streak">0Â§©</span>
          </div>
          <div class="today-count">
            <span class="today-label">‰ªäÊó•Â∑≤Â≠¶</span>
            <span class="today-value" id="stat-today">0Âº†</span>
          </div>
        </div>
      </div>
      <div class="tool-card note-section">
        <h4>Â≠¶‰π†Á¨îËÆ∞</h4>
        <div class="note-tabs">
          <button class="tab-btn active" data-tab="quick" onclick="switchNoteTab('quick')">Âø´ÈÄüÁ¨îËÆ∞</button>
          <button class="tab-btn" data-tab="organized" onclick="switchNoteTab('organized')">Á≥ªÁªüÁ¨îËÆ∞</button>
        </div>
        <div class="tab-content active" id="quick-note">
          <textarea placeholder="ËÆ∞ÂΩï‰∏¥Êó∂ÊÉ≥Ê≥ïÂíåÁ¨îËÆ∞..." id="quick-textarea"></textarea>
        </div>
        <div class="tab-content" id="organized-note">
          <div class="note-controls">
            <select id="note-category" class="note-select"></select>
            <button class="btn-new-category" onclick="addNoteCategory()">Êñ∞Âª∫ÂàÜÁ±ª</button>
          </div>
          <div class="note-editor">
            <input type="text" class="note-title" placeholder="Á¨îËÆ∞Ê†áÈ¢ò...">
            <textarea id="organized-textarea" placeholder="Á≥ªÁªüÂåñÁöÑÂ≠¶‰π†Á¨îËÆ∞..."></textarea>
          </div>
        </div>
        <div class="note-actions">
          <button class="btn-save" onclick="saveNote()">‰øùÂ≠òÁ¨îËÆ∞</button>
          <button class="btn-secondary" onclick="viewNoteHistory()">Êü•ÁúãÂéÜÂè≤</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Âç°ÁâáËØ¶ÊÉÖÊ®°ÊÄÅ -->
  <div id="card-modal" onclick="closeCardModal(event)"></div>
  <!-- ÂØºÂÖ•ÂºπÁ™óÂÆπÂô® -->
  <div id="import-modal-root"></div>
  <script>
  // ============ Êï∞ÊçÆÂàùÂßãÂåñ‰∏éÊú¨Âú∞Â≠òÂÇ® ==============
  let cards = JSON.parse(localStorage.getItem('flashcards') || '[]');
  if (!cards.length) {
    // ÈªòËÆ§ÂàùÂßãÂç°Áâá
    cards = [{
      front: "ÂÖ¨ÂÖ±ÁÆ°ÁêÜÁöÑÂü∫Êú¨ÁâπÂæÅ",
      back: "1„ÄÅÂÖ¨ÂÖ±ÊÄßÔºöÊúçÂä°ÂØπË±°ÂíåÁõÆÊ†áÁöÑÂÖ¨ÂÖ±ÊÄß\n2„ÄÅÊùÉÂäõÊÄßÔºöË°åÊîøÊùÉÂäõÂíåÊ≥ïÂæã‰øùÈöú\n3„ÄÅÊúçÂä°ÊÄßÔºö‰ª•ÊúçÂä°ÂÖ¨‰ºó‰∏∫Ê†πÊú¨ÂÆóÊó®\n4„ÄÅ‰∏ì‰∏öÊÄßÔºöÈúÄË¶Å‰∏ì‰∏öÁü•ËØÜÂíåÊäÄËÉΩ",
      category: "ÂÖ¨ÂÖ±ÁÆ°ÁêÜ",
      chapter: "Á¨¨‰∏ÄÁ´† ÂÖ¨ÂÖ±ÁÆ°ÁêÜÊ¶ÇËÆ∫",
      level: "ÈáçÁÇπ",
      examFrequency: "È´òÈ¢ë",
      cardType: "ÁâπÂæÅÂàÜÊûê",
      clue: "ÊÄùËÄÉÔºö‰ªÄ‰πà‰ΩøÂÖ¨ÂÖ±ÁÆ°ÁêÜÂå∫Âà´‰∫é‰∏ÄËà¨ÁÆ°ÁêÜÔºü",
      context: "ÂÖ¨ÂÖ±ÁÆ°ÁêÜÊòØ‰∏ÄÈó®‰∏ìÈó®Á†îÁ©∂ÊîøÂ∫úÁÆ°ÁêÜÊ¥ªÂä®ÁöÑÂ≠¶ÁßëÔºåÂÖ∂ÁâπÂæÅÂèçÊò†‰∫ÜÂÖ∂Êú¨Ë¥®Â±ûÊÄß",
      lastReview: null,
      nextReview: null,
      reviewCount: 0,
      difficulty: 0,
      mastery: 0,
      wrongCount: 0,
      tags: ["ÁÆ°ÁêÜ", "ÁâπÂæÅ"],
      links: []
    }];
  }
  // ÂÖºÂÆπÊóßÊï∞ÊçÆÁªìÊûÑÔºåÁ°Æ‰øùÊØèÂº†Âç°ÁâáÈÉΩÊúâ tags Âíå links Â≠óÊÆµ
  cards.forEach(c => {
    if (!c.tags) c.tags = [];
    if (!c.links) c.links = [];
  });

  // ============ Â≠¶‰π†ËøõÂ∫¶/ÁªüËÆ° ==============
  function statSummary() {
    const total = cards.length;
    let mastered = 0, reviewing = 0, unlearned = 0, high = 0;
    cards.forEach(card => {
      if (card.mastery >= 4) mastered++;
      else if (card.mastery >= 1) reviewing++;
      else unlearned++;
      if (card.examFrequency === 'È´òÈ¢ë') high++;
    });
    return { total, mastered, reviewing, unlearned, high };
  }
  function updateStats() {
    const s = statSummary();
    document.getElementById('stat-mastered').textContent = s.mastered;
    document.getElementById('stat-reviewing').textContent = s.reviewing;
    document.getElementById('stat-new').textContent = s.unlearned;
    document.getElementById('stat-high').textContent = s.high;
    // ËøõÂ∫¶ÁéØ
    const percent = s.total ? Math.round((s.mastered + s.reviewing) / s.total * 100) : 0;
    const circle = document.querySelector('.progress-ring-circle');
    const radius = 24, circumference = 2 * Math.PI * radius;
    circle.setAttribute('stroke-dasharray', circumference);
    circle.setAttribute('stroke-dashoffset', circumference * (1 - percent / 100));
    document.querySelector('.progress-text').textContent = percent + '%';
    document.getElementById('stat-today').textContent = getTodayStudyCount() + 'Âº†';
    document.getElementById('stat-streak').textContent = getStudyStreak() + 'Â§©';
  }

  // ============ ‰æßËæπÊ†è ÂàÜÁ±ª-Á´†ËäÇ ‰∫åÁ∫ßÂ±ïÂºÄ ==============
  let activeReviewFilter = () => true;
  let currentCardList = cards;
  function updateCardList(listCards = cards.filter(activeReviewFilter)) {
    const grouped = listCards.reduce((acc, card) => {
      if (!acc[card.category]) acc[card.category] = {};
      if (!acc[card.category][card.chapter]) acc[card.category][card.chapter] = [];
      acc[card.category][card.chapter].push(card);
      return acc;
    }, {});
    const list = document.getElementById('card-list');
    list.innerHTML = '';
    // ÂÖ®ÈÉ®Âç°ÁâáÈ°π
    const allItem = document.createElement('div');
    allItem.className = 'chapter-item';
    allItem.textContent = 'ÂÖ®ÈÉ®Âç°Áâá';
    allItem.onclick = () => { currentCardList = listCards; renderGrid(currentCardList); };
    list.appendChild(allItem);
    for (let cat in grouped) {
      const catDiv = document.createElement('div');
      catDiv.className = 'category-item';
      const catHeader = document.createElement('div');
      catHeader.className = 'category-header';
      catHeader.innerHTML = `<i>‚ñ∂</i>${cat}`;
      catHeader.onclick = () => {
        catHeader.classList.toggle('expanded');
        catContent.classList.toggle('expanded');
        currentCardList = Object.values(grouped[cat]).flat();
        renderGrid(currentCardList);
      };
      const catContent = document.createElement('div');
      catContent.className = 'category-content';
      for (let chap in grouped[cat]) {
        const chapDiv = document.createElement('div');
        chapDiv.className = 'chapter-item';
        chapDiv.textContent = chap;
        chapDiv.onclick = () => {
          currentCardList = grouped[cat][chap];
          renderGrid(currentCardList);
        };
        catContent.appendChild(chapDiv);
      }
      catDiv.appendChild(catHeader);
      catDiv.appendChild(catContent);
      list.appendChild(catDiv);
    }
    updateTagList();
  }

  // ============ Ê†áÁ≠æËøáÊª§ ==============
  function updateTagList() {
    const tagListDiv = document.getElementById('tag-list');
    const tagSet = new Set();
    cards.forEach(c => {
      (c.tags || []).forEach(t => tagSet.add(t));
    });
    const tags = Array.from(tagSet).sort();
    tagListDiv.innerHTML = tags.map(t => `<span class="tag-item" onclick="filterByTag('${t}')">${t}</span>`).join('');
  }
  function filterByTag(tag) {
    activeReviewFilter = card => (card.tags || []).includes(tag);
    currentCardList = cards.filter(activeReviewFilter);
    updateCardList(currentCardList);
    renderGrid(currentCardList);
    // Â¶ÇÊûúÂú®Ê®°ÊÄÅ‰∏≠ÁÇπÂáªÊ†áÁ≠æÔºåÂÖ≥Èó≠Ê®°ÊÄÅ
    closeCardModal();
  }

  // ============ ‰∏ªÂç°ÁâáÊ∏≤Êüì ==============
  function truncateText(t, len = 15) {
    return t && t.length > len ? t.slice(0, len) + '‚Ä¶' : (t || '');
  }
  function renderGrid(showCards = currentCardList) {
    const grid = document.getElementById('flashcard-grid');
    grid.innerHTML = '';
    showCards.forEach(card => {
      const div = document.createElement('div');
      div.className = 'flashcard-thumb';
      div.innerHTML = `<div class="thumb-title">${truncateText(card.front, 40)}</div>` +
                      `<div class="thumb-clue">${truncateText(card.clue || card.context || '', 40)}</div>`;
      div.onclick = () => openCard(card.front);
      grid.appendChild(div);
    });
  }
  // Ê†ºÂºèÂåñÂç°ÁâáÂÜÖÂÆπÔºöÊîØÊåÅÁºñÂè∑„ÄÅÂ§áÊ≥®Á≠â
  function formatCardContent(content) {
    let mainContent = content;
    let notes = '';
    const noteMatches = content.match(/Ôºà[^Ôºâ]+Ôºâ/g);
    if (noteMatches) {
      notes = noteMatches.join(' ');
      mainContent = content.replace(/Ôºà[^Ôºâ]+Ôºâ/g, '');
    }
    // Â§ÑÁêÜÁºñÂè∑ÂàóË°®
    if (/1[\.„ÄÅÔºé]/.test(mainContent)) {
      const points = mainContent.split(/(?=\d+[\.„ÄÅÔºé])/)
        .map(point => point.trim()).filter(point => point.length > 0);
      let html = '<div class="numbered-list">';
      points.forEach(point => {
        const match = point.match(/^(\d+[\.„ÄÅÔºé])\s*(.+)$/);
        if (match) {
          html += `<div class="list-item"><span class="number">${match[1]}</span><span class="content">${match[2]}</span></div>`;
        } else {
          html += `<div class="list-item"><span class="content">${point}</span></div>`;
        }
      });
      html += '</div>';
      if (notes) html += `<div class="note">${notes}</div>`;
      return html;
    }
    return `<p>${mainContent.replace(/\n/g, '<br>')}</p>${notes ? `<div class="note">${notes}</div>` : ''}`;
  }
  function openCard(front) {
    const card = cards.find(c => c.front === front);
    if (!card) return;
    const modal = document.getElementById('card-modal');
    // Ê∏≤ÊüìÊ†áÁ≠æÂíåÈìæÊé•„ÄÇ‰ΩøÁî®ÂèåÂºïÂè∑ÂåÖË£π onclick ‰ª•ÈÅøÂÖçËΩ¨‰πâÈóÆÈ¢ò„ÄÇ
    const tagsHtml = card.tags && card.tags.length ? `<div style="margin-top:8px;">Ê†áÁ≠æÔºö${card.tags.map(t => `<span class="tag-item" onclick="filterByTag('${t}')">${t}</span>`).join(' ')}</div>` : '';
    const linksHtml = card.links && card.links.length ? `<div style="margin-top:8px;">Áõ∏ÂÖ≥Âç°ÁâáÔºö${card.links.map(l => `<a href="#" onclick="openCard('${l}');return false;">${l}</a>`).join('Ôºå')}</div>` : '';
    modal.innerHTML = `
      <div class="card-popup" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closeCardModal(event)">√ó</button>
        <div class="popup-title">${card.front}</div>
        <div class="popup-content">
          ${card.clue ? `<div class="popup-clue">${card.clue}</div>` : ''}
          <div>${formatCardContent(card.back)}</div>
          ${tagsHtml}
          ${linksHtml}
        </div>
        <div class="mastery-buttons">
          <button class="btn-primary" style="background:#fde68a;color:#b45309;" onclick="updateMastery('${card.front}',1,event)"><span>üòÖ</span>Âõ∞Èöæ</button>
          <button class="btn-primary" style="background:#bae6fd;color:#0369a1;" onclick="updateMastery('${card.front}',3,event)"><span>ü§î</span>Ê®°Á≥ä</button>
          <button class="btn-primary" style="background:#bbf7d0;color:#166534;" onclick="updateMastery('${card.front}',5,event)"><span>‚ú®</span>Ê∏ÖÊô∞</button>
        </div>
      </div>`;
    modal.onclick = closeCardModal;
    modal.classList.add('active');
    modal.style.opacity = '1';
  }
  function closeCardModal(e) {
    if (e) e.stopPropagation();
    const modal = document.getElementById('card-modal');
    modal.classList.remove('active');
    modal.innerHTML = '';
  }

  // ============ ÊêúÁ¥¢ËøáÊª§ ==============
  function filterCards(query) {
    const q = query.trim().toLowerCase();
    const base = cards.filter(activeReviewFilter);
    if (!q) {
      renderGrid(base);
      currentCardList = base;
      return;
    }
    const filtered = base.filter(card =>
      card.front.toLowerCase().includes(q) ||
      card.back.toLowerCase().includes(q) ||
      card.category.toLowerCase().includes(q) ||
      card.chapter.toLowerCase().includes(q) ||
      (card.level || '').toLowerCase().includes(q) ||
      (card.tags || []).some(t => t.toLowerCase().includes(q))
    );
    currentCardList = filtered;
    renderGrid(filtered);
  }

  // ============ Èó¥ÈöîÈáçÂ§çÁÆóÊ≥ï ==============
  function spacedRepetition(card, mastery) {
    const now = new Date();
    const interval = Math.pow(2, card.reviewCount || 0) * (mastery / 5);
    card.lastReview = now.toISOString();
    card.reviewCount = (card.reviewCount || 0) + 1;
    card.mastery = mastery;
    const next = new Date(now);
    next.setDate(now.getDate() + Math.max(1, Math.round(interval)));
    card.nextReview = next.toISOString();
    card.difficulty = Math.max(0, Math.min(5, (card.difficulty || 0) + (mastery <= 2 ? 1 : mastery >= 4 ? -1 : 0)));
    return card;
  }
  function updateMastery(front, mastery, event) {
    event.stopPropagation();
    const i = cards.findIndex(c => c.front === front);
    if (i === -1) return;
    cards[i] = spacedRepetition(cards[i], mastery);
    if (mastery <= 2) cards[i].wrongCount = (cards[i].wrongCount || 0) + 1;
    localStorage.setItem('flashcards', JSON.stringify(cards));
    incrementTodayStudyCount();
    updateStats();
    // Âà∑Êñ∞Âç°ÁâáÂàóË°®
    document.querySelectorAll('.flashcard-thumb').forEach(f => f.classList.remove('flipped'));
    const modal = document.getElementById('card-modal');
    if (modal.classList.contains('active')) {
      modal.style.transition = 'opacity 0.3s ease';
      modal.style.opacity = '0';
      setTimeout(() => {
        closeCardModal();
      }, 300);
    }
    setTimeout(() => {
      const grid = document.getElementById('flashcard-grid');
      grid.style.transition = 'opacity 0.3s ease';
      grid.style.opacity = '0';
      renderGrid(currentCardList);
      setTimeout(() => { grid.style.opacity = '1'; }, 100);
    }, 330);
  }

  // ============ Â≠¶‰π†Â§©Êï∞/ÊâìÂç°ÁªüËÆ° ==============
  function getTodayStudyCount() {
    const today = new Date().toISOString().split('T')[0];
    return parseInt(localStorage.getItem(`study_count_${today}`) || '0');
  }
  function incrementTodayStudyCount() {
    const today = new Date().toISOString().split('T')[0];
    const count = getTodayStudyCount();
    localStorage.setItem(`study_count_${today}`, count + 1);
  }
  function getStudyStreak() {
    let streak = 0;
    const today = new Date();
    const curr = new Date(today);
    while (true) {
      const dateStr = curr.toISOString().split('T')[0];
      if (parseInt(localStorage.getItem(`study_count_${dateStr}`) || '0') === 0) break;
      streak++;
      curr.setDate(curr.getDate() - 1);
    }
    return streak;
  }

  // ============ ÂÄíËÆ°Êó∂ ==============
  function updateCountdown() {
    let dt = localStorage.getItem('examDate') || '';
    let date = dt ? new Date(dt) : new Date(new Date().getFullYear(), 11, 23);
    const now = new Date();
    let days = Math.ceil((date - now) / 86400000);
    if (days < 0) days = 0;
    document.getElementById('countdown').textContent = days + 'Â§©';
    document.querySelector('.countdown-label').onclick = function() {
      const input = prompt('Ëá™ÂÆö‰πâÁõÆÊ†áÊó•ÊúüÔºàÊ†ºÂºè: 2024-12-21Ôºâ', dt || '');
      if (input) {
        localStorage.setItem('examDate', input);
        updateCountdown();
      }
    };
  }

  // ============ ÂØºÂÖ•‰∏éÂØºÂá∫ ==============
  function showImportModal() {
    const modalRoot = document.getElementById('import-modal-root');
    modalRoot.innerHTML = `
    <div>
      <div class="modal-content" style="max-width:440px;max-height:80vh;overflow-y:auto;">
        <h3>ÊâπÈáèÂØºÂÖ•È¢òÂ∫ì</h3>
        <p>Á≤òË¥¥Á¨¶ÂêàÊ†ºÂºèÁöÑJSONÊï∞ÁªÑÔºåÊàñ‰∏ä‰º†.jsonÊñá‰ª∂Ôºö</p>
        <pre class="import-hint" style="background:#f8fafc;border:1px dashed #d1d5db;padding:8px;font-size:13px;margin:8px 0;white-space:pre-wrap;">[
  {"front":"È¢òÂπ≤","back":"Á≠îÊ°à","category":"ÁßëÁõÆ","chapter":"Á´†ËäÇ","tags":["Ê†áÁ≠æ1","Ê†áÁ≠æ2"],"links":["ÂÖ≥ËÅîÂç°Áâá"]}
]</pre>
        <textarea id="import-json" style="width:98%;min-height:96px;border-radius:8px;border:1px solid #e0e0e0;padding:7px 10px;font-size:15px;"></textarea>
        <input type="file" id="import-file" accept=".json" style="margin:10px 0;">
        <div style="text-align:right;margin-top:10px;">
          <button class="btn-secondary" onclick="document.getElementById('import-modal-root').innerHTML=''">ÂèñÊ∂à</button>
          <button class="btn-primary" onclick="processImport()">ÂØºÂÖ•</button>
        </div>
      </div>
    </div>`;
    document.getElementById('import-file').onchange = function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        document.getElementById('import-json').value = ev.target.result;
      };
      reader.readAsText(file);
    };
  }
  function processImport() {
    let importData;
    try {
      importData = JSON.parse(document.getElementById('import-json').value);
      if (!Array.isArray(importData)) throw Error('ËØ∑Á≤òË¥¥JSONÊï∞ÁªÑÊ†ºÂºè');
      importData.forEach(card => {
        if (!card.front || !card.back || !card.category || !card.chapter) throw Error('ÊØèÊù°ÈúÄÂê´front,back,category,chapter');
        card.lastReview = null; card.nextReview = null; card.reviewCount = 0; card.difficulty = 0; card.mastery = 0; card.wrongCount = 0;
        if (!card.tags) card.tags = [];
        if (!card.links) card.links = [];
      });
      // ÂéªÈáç
      const fronts = new Set(cards.map(c => c.front));
      const newCards = importData.filter(card => !fronts.has(card.front));
      cards = cards.concat(newCards);
      localStorage.setItem('flashcards', JSON.stringify(cards));
      document.getElementById('import-modal-root').innerHTML = '';
      const filtered = cards.filter(activeReviewFilter);
      updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
      alert('ÂØºÂÖ•ÊàêÂäüÔºÅÊñ∞Â¢û' + newCards.length + 'Êù°');
    } catch (e) {
      alert('ÂØºÂÖ•Â§±Ë¥•:' + e.message);
    }
  }
  function exportCards() {
    const data = JSON.stringify(cards, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'flashcards_backup_' + Date.now() + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // ============ Êñ∞Âª∫Âç°Áâá ==============
  function addNewCard() {
    const front = prompt('ËæìÂÖ•È¢òÂπ≤(Ê≠£Èù¢)...');
    if (!front) return;
    const back = prompt('ËæìÂÖ•Á≠îÊ°à(ËÉåÈù¢)...');
    if (!back) return;
    const category = prompt('ÊâÄÂ±ûÁßëÁõÆ/ÂàÜÁ±ª?', 'Êú™ÂàÜÁ±ª') || 'Êú™ÂàÜÁ±ª';
    const chapter = prompt('ÊâÄÂ±ûÁ´†ËäÇ?', 'Êú™ÂàÜÁ´†') || 'Êú™ÂàÜÁ´†';
    const tagStr = prompt('ËæìÂÖ•Ê†áÁ≠æÔºåÁî®ÈÄóÂè∑ÂàÜÈöî(ÂèØÈÄâ)...', '');
    const linkStr = prompt('ËæìÂÖ•ÂÖ≥ËÅîÂç°ÁâáÈ¢òÂπ≤ÔºåÁî®ÈÄóÂè∑ÂàÜÈöî(ÂèØÈÄâ)...', '');
    const tags = tagStr ? tagStr.split(',').map(s => s.trim()).filter(Boolean) : [];
    const links = linkStr ? linkStr.split(',').map(s => s.trim()).filter(Boolean) : [];
    cards.push({
      front, back, category, chapter,
      level: 'Âü∫Á°Ä', examFrequency: '‰ΩéÈ¢ë', lastReview: null, nextReview: null, reviewCount: 0,
      difficulty: 0, mastery: 0, wrongCount: 0,
      tags, links
    });
    localStorage.setItem('flashcards', JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
  }

  // ============ Á¨îËÆ∞Á≥ªÁªü ==============
  let notes = JSON.parse(localStorage.getItem('flashcardNotes') || '{"quick":{},"organized":{}}');
  function switchNoteTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('.tab-btn[data-tab="' + tab + '"]').classList.add('active');
    document.getElementById(tab + '-note').classList.add('active');
  }
  function saveNote() {
    const tab = document.querySelector('.tab-btn.active').dataset.tab;
    const today = new Date().toISOString().split('T')[0];
    if (tab === 'quick') {
      notes.quick[today] = document.getElementById('quick-textarea').value;
    } else {
      const cat = document.getElementById('note-category').value;
      const title = document.querySelector('.note-title').value;
      const content = document.getElementById('organized-textarea').value;
      if (!cat) return alert('ËØ∑ÈÄâÊã©ÂàÜÁ±ª');
      if (!notes.organized[cat]) notes.organized[cat] = [];
      notes.organized[cat].push({ title, content, date: today });
    }
    localStorage.setItem('flashcardNotes', JSON.stringify(notes));
    alert('Á¨îËÆ∞Â∑≤‰øùÂ≠ò');
  }
  function addNoteCategory() {
    const cat = prompt('ËæìÂÖ•Êñ∞ÂàÜÁ±ªÂêç');
    if (!cat) return;
    if (!notes.organized[cat]) notes.organized[cat] = [];
    updateNoteCategories();
  }
  function updateNoteCategories() {
    const sel = document.getElementById('note-category');
    if (!sel) return;
    sel.innerHTML = '<option value="">ÈÄâÊã©ÂàÜÁ±ª...</option>' +
      Object.keys(notes.organized).map(c => `<option value="${c}">${c}</option>`).join('');
  }
  function viewNoteHistory() {
    let html = '<h3>ÂéÜÂè≤Á¨îËÆ∞ÔºàÊúÄÊñ∞10Êù°Ôºâ</h3><ul style="max-height:260px;overflow:auto;">';
    const recs = [];
    Object.keys(notes.quick || {}).forEach(date => { recs.push({ txt: notes.quick[date], date }); });
    Object.keys(notes.organized || {}).forEach(cat => {
      (notes.organized[cat] || []).forEach(note => { recs.push({ txt: note.title + ' ' + note.content, date: note.date }); });
    });
    recs.sort((a, b) => b.date.localeCompare(a.date));
    recs.slice(0, 10).forEach(r => {
      html += `<li style="margin-bottom:9px;font-size:14px;"><b>${r.date}</b>Ôºö${r.txt.substring(0,80)}...</li>`;
    });
    html += '</ul><div style="text-align:right"><button class="btn-secondary" onclick="closeModal()">ÂÖ≥Èó≠</button></div>';
    showModal(html);
  }

  // ============ Â§ç‰π†Ê®°Âºè ==============
  function showReviewMenu() {
    const opts = [
      { name:'Â∫îÂ§ç‰π†', filter: card => !card.nextReview || new Date(card.nextReview) <= new Date() },
      { name:'‰ªäÊó•Â∑≤Â≠¶', filter: card => card.lastReview && new Date(card.lastReview).toDateString() === new Date().toDateString() },
      { name:'Êú¨Âë®Â∑≤Â≠¶', filter: card => card.lastReview && (new Date() - new Date(card.lastReview)) <= 7 * 86400000 },
      { name:'È´òÈ¢ëËÄÉÁÇπ', filter: card => card.examFrequency === 'È´òÈ¢ë' },
      { name:'ÈîôÈ¢òÊú¨', filter: card => (card.wrongCount || 0) >= 2 || card.mastery < 3 },
      { name:'ÂÖ®ÈÉ®Âç°Áâá', filter: () => true },
      { name:'‰π±Â∫è', filter: () => true, shuffle: true }
    ];
    let html = '<h3>ÈÄâÊã©Â§ç‰π†Ê®°Âºè</h3>';
    opts.forEach((opt, i) => {
      html += `<button class="btn-primary" style="margin:7px 0;width:100%;" onclick="applyReviewMode(${i})">${opt.name}</button>`;
    });
    html += `<div style="text-align:right;margin-top:8px;"><button class="btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button></div>`;
    showModal(html);
  }
  function applyReviewMode(idx) {
    const opts = [
      { name:'Â∫îÂ§ç‰π†', filter: card => !card.nextReview || new Date(card.nextReview) <= new Date() },
      { name:'‰ªäÊó•Â∑≤Â≠¶', filter: card => card.lastReview && new Date(card.lastReview).toDateString() === new Date().toDateString() },
      { name:'Êú¨Âë®Â∑≤Â≠¶', filter: card => card.lastReview && (new Date() - new Date(card.lastReview)) <= 7 * 86400000 },
      { name:'È´òÈ¢ëËÄÉÁÇπ', filter: card => card.examFrequency === 'È´òÈ¢ë' },
      { name:'ÈîôÈ¢òÊú¨', filter: card => (card.wrongCount || 0) >= 2 || card.mastery < 3 },
      { name:'ÂÖ®ÈÉ®Âç°Áâá', filter: () => true },
      { name:'‰π±Â∫è', filter: () => true, shuffle: true }
    ];
    const opt = opts[idx];
    activeReviewFilter = opt.filter;
    let base = cards.filter(opt.filter);
    if (opt.shuffle) base = base.sort(() => Math.random() - 0.5);
    currentCardList = base;
    renderGrid(base);
    updateCardList(base);
    closeModal();
  }

  // ============ ÁÆ°ÁêÜÈ¢òÂ∫ìÁïåÈù¢ ==============
  function showManageLibrary() {
    let html = '<h3 style="margin-bottom:12px;">ÁÆ°ÁêÜÈ¢òÂ∫ì</h3>';
    html += '<div style="display:flex; gap:10px; margin-bottom:12px;">';
    html += '<input type="text" id="manage-search" placeholder="ÊêúÁ¥¢È¢òÂπ≤/Á≠îÊ°à/ÁßëÁõÆ..." oninput="renderManageTable(this.value)" style="flex:1; padding:8px; border:1px solid #e2e8f0; border-radius:8px;">';
    html += '<select id="manage-sort" onchange="renderManageTable()" style="padding:8px; border:1px solid #e2e8f0; border-radius:8px;">';
    html += '<option value="mastery">ÊåâÊéåÊè°Â∫¶ÈôçÂ∫è</option><option value="wrongCount">ÊåâÈîôÈ¢òÊ¨°Êï∞ÈôçÂ∫è</option><option value="nextReview">ÊåâÂ§ç‰π†Êó∂Èó¥ÂçáÂ∫è</option><option value="front">ÊåâÈ¢òÂπ≤A-Z</option>';    
    html += '</select></div>';
    html += '<table class="manage-table" id="manage-table" style="width:100%;margin-bottom:16px;font-size:14px;"></table>';
    html += '<div class="pagination" id="manage-pagination"></div>';
    html += '<div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">';
    html += '<button class="btn-secondary" onclick="closeModal()">ÂÖ≥Èó≠</button>';
    html += '<button class="btn-primary" onclick="batchExportSelected()" style="background:#4ade80;">ÂØºÂá∫ÈÄâ‰∏≠</button>';
    html += '<button class="btn-primary" onclick="batchDeleteSelected()" style="background:#ef4444;color:#fff;">ÊâπÈáèÂà†Èô§</button>';
    html += '</div>';
    showModal(html);
    renderManageTable();
  }
  function renderManageTable(query = '', page = 1) {
    const q = query.toLowerCase();
    let filtered = cards.filter(card =>
      card.front.toLowerCase().includes(q) || card.back.toLowerCase().includes(q) || card.category.toLowerCase().includes(q) || card.chapter.toLowerCase().includes(q)
    );
    const sort = document.getElementById('manage-sort').value;
    if (sort === 'mastery') filtered.sort((a,b) => b.mastery - a.mastery);
    else if (sort === 'wrongCount') filtered.sort((a,b) => (b.wrongCount || 0) - (a.wrongCount || 0));
    else if (sort === 'nextReview') filtered.sort((a,b) => (new Date(a.nextReview || '9999-12-31') - new Date(b.nextReview || '9999-12-31')));
    else if (sort === 'front') filtered.sort((a,b) => a.front.localeCompare(b.front));
    const perPage = 15;
    const start = (page - 1) * perPage;
    const paginated = filtered.slice(start, start + perPage);
    let tableHtml = '<thead><tr><th style="width:5%;"><input type="checkbox" onclick="toggleAllCheck(this)"></th><th style="width:30%;">È¢òÂπ≤</th><th style="width:15%;">ÁßëÁõÆ/Á´†ËäÇ</th><th style="width:10%;">ÊéåÊè°Â∫¶</th><th style="width:10%;">ÈîôÈ¢òÊï∞</th><th style="width:15%;">‰∏ãÊ¨°Â§ç‰π†</th><th style="width:15%;">Êìç‰Ωú</th></tr></thead><tbody>';
    paginated.forEach(card => {
      const nextReview = card.nextReview ? new Date(card.nextReview).toLocaleDateString() : 'Êú™Â§ç‰π†';
      tableHtml += `<tr><td><input type="checkbox" data-front="${card.front}"></td><td>${truncateText(card.front, 40)}</td><td>${card.category}/${card.chapter}</td><td>${card.mastery}</td><td>${card.wrongCount || 0}</td><td>${nextReview}</td><td><button class="btn-primary" style="padding:4px 8px; font-size:12px;" onclick="showEditCard('${card.front}')">ÁºñËæë</button> <button class="btn-secondary" style="padding:4px 8px; font-size:12px; background:#ef4444; color:#fff;" onclick="deleteCard('${card.front}')">Âà†Èô§</button></td></tr>`;
    });
    tableHtml += '</tbody>';
    document.getElementById('manage-table').innerHTML = tableHtml;
    // ÂàÜÈ°µ
    const pages = Math.ceil(filtered.length / perPage);
    let pagHtml = '';
    for (let i = 1; i <= pages; i++) {
      pagHtml += `<span class="page-btn ${i === page ? 'active' : ''}" onclick="renderManageTable('${query}', ${i})" style="padding:6px 12px; background:${i === page ? '#6366f1' : '#f1f5f9'}; color:${i === page ? '#fff' : '#1e293b'}; border-radius:8px; cursor:pointer; margin:0 4px;">${i}</span>`;
    }
    document.getElementById('manage-pagination').innerHTML = pagHtml;
  }
  function toggleAllCheck(checkbox) {
    document.querySelectorAll('.manage-table input[type="checkbox"]').forEach(cb => cb.checked = checkbox.checked);
  }
  function batchDeleteSelected() {
    const selected = Array.from(document.querySelectorAll('.manage-table input[type="checkbox"]:checked')).map(cb => cb.dataset.front);
    if (selected.length === 0 || !confirm(`Á°ÆËÆ§Âà†Èô§${selected.length}Âº†Âç°ÁâáÔºü`)) return;
    cards = cards.filter(c => !selected.includes(c.front));
    localStorage.setItem('flashcards', JSON.stringify(cards));
    renderManageTable();
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
  }
  function batchExportSelected() {
    const selected = Array.from(document.querySelectorAll('.manage-table input[type="checkbox"]:checked')).map(cb => cb.dataset.front);
    if (selected.length === 0) return alert('ËØ∑ÈÄâÊã©Âç°Áâá');
    const exportCards = cards.filter(c => selected.includes(c.front));
    const data = JSON.stringify(exportCards, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'selected_flashcards_' + Date.now() + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // ============ ÁºñËæë/Âà†Èô§ Âç°Áâá ==============
  function showEditCard(front) {
    const i = cards.findIndex(c => c.front === front);
    if (i === -1) return;
    const card = cards[i];
    let html = `
    <h3>ÁºñËæëÂç°Áâá</h3>
    <label>È¢òÂπ≤(Ê≠£Èù¢):<input type="text" id="edit-front" value="${card.front}" style="width:95%;margin-bottom:7px;"></label><br>
    <label>Á≠îÊ°à(ËÉåÈù¢):<textarea id="edit-back" style="width:95%;height:70px;">${card.back}</textarea></label><br>
    <label>ÁßëÁõÆ:<input type="text" id="edit-category" value="${card.category}" style="width:45%;"></label>
    <label>Á´†ËäÇ:<input type="text" id="edit-chapter" value="${card.chapter}" style="width:45%;"></label><br>
    <label>È´òÈ¢ë:<input type="checkbox" id="edit-high" ${card.examFrequency === 'È´òÈ¢ë' ? 'checked' : ''}></label>
    <label>ÈáçÁÇπ:<input type="checkbox" id="edit-key" ${card.level === 'ÈáçÁÇπ' ? 'checked' : ''}></label><br>
    <label>Ê†áÁ≠æ(ÈÄóÂè∑ÂàÜÈöî):<input type="text" id="edit-tags" value="${(card.tags || []).join(', ')}" style="width:95%;margin:6px 0;"></label><br>
    <label>ÈìæÊé•(ÂÖ≥ËÅîÈ¢òÂπ≤,ÈÄóÂè∑ÂàÜÈöî):<input type="text" id="edit-links" value="${(card.links || []).join(', ')}" style="width:95%;"></label>
    <div style="text-align:right;margin-top:13px;">
      <button class="btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
      <button class="btn-save" onclick="doEditCard('${front}')">‰øùÂ≠ò</button>
      <button class="btn-primary" style="background:#f44;color:#fff;margin-left:8px;" onclick="deleteCard('${front}')">Âà†Èô§</button>
    </div>`;
    showModal(html);
  }
  function doEditCard(oldFront) {
    const i = cards.findIndex(c => c.front === oldFront);
    if (i === -1) return alert('Êú™ÊâæÂà∞Âç°Áâá');
    const newFront = document.getElementById('edit-front').value.trim();
    const newBack = document.getElementById('edit-back').value;
    const newCat = document.getElementById('edit-category').value;
    const newChap = document.getElementById('edit-chapter').value;
    cards[i].front = newFront;
    cards[i].back = newBack;
    cards[i].category = newCat;
    cards[i].chapter = newChap;
    cards[i].examFrequency = document.getElementById('edit-high').checked ? 'È´òÈ¢ë' : '‰ΩéÈ¢ë';
    cards[i].level = document.getElementById('edit-key').checked ? 'ÈáçÁÇπ' : 'Âü∫Á°Ä';
    cards[i].tags = document.getElementById('edit-tags').value.split(',').map(s => s.trim()).filter(Boolean);
    cards[i].links = document.getElementById('edit-links').value.split(',').map(s => s.trim()).filter(Boolean);
    localStorage.setItem('flashcards', JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
    closeModal();
  }
  function deleteCard(front) {
    if (!confirm('Á°ÆËÆ§Âà†Èô§Ôºü')) return;
    cards = cards.filter(c => c.front !== front);
    localStorage.setItem('flashcards', JSON.stringify(cards));
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered); renderGrid(filtered); updateStats(); updateTagList();
    closeModal();
  }

  // ============ ÈÄöÁî®Ê®°ÊÄÅ ==============
  function showModal(html) {
    document.getElementById('import-modal-root').innerHTML = `<div><div class="modal-content" style="max-width:800px; max-height:80vh; overflow-y:auto;">${html}</div></div>`;
  }
  function closeModal() {
    document.getElementById('import-modal-root').innerHTML = '';
  }

  // È°µÈù¢ÂàùÂßãÂåñ
  function initializeApp() {
    const filtered = cards.filter(activeReviewFilter);
    updateCardList(filtered);
    renderGrid(filtered);
    updateStats();
    updateCountdown();
    updateNoteCategories();
    // ÊÅ¢Â§çÁ¨îËÆ∞ËæìÂÖ•
    if (notes.quick) {
      const latest = Object.keys(notes.quick).sort().pop();
      if (latest) document.getElementById('quick-textarea').value = notes.quick[latest];
    }
    // ÊåâÈîÆÁªëÂÆöÔºöCtrl+E ÂØºÂá∫
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportCards(); }
    });
  }
  window.onload = initializeApp;
  </script>
</body>
</html>